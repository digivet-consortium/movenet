# trace_contact_chains() works when a single root is given, with tEnd, and both in- and outgoing contact chains exist

    <div id="htmlwidget-" style="width:100%;height:400px;" class="leaflet html-widget"></div>
    <script type="application/json" data-for="htmlwidget-">{"x":{"options":{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}}},"calls":[{"method":"addTiles","args":["https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",null,null,{"minZoom":0,"maxZoom":18,"tileSize":256,"subdomains":"abc","errorTileUrl":"","tms":false,"noWrap":false,"zoomOffset":0,"zoomReverse":false,"opacity":1,"zIndex":1,"detectRetina":false,"attribution":"&copy; <a href=\"https://openstreetmap.org/copyright/\">OpenStreetMap<\/a>,  <a href=\"https://opendatacommons.org/licenses/odbl/\">ODbL<\/a>"}]},{"method":"addCircleMarkers","args":[54.87183548191156,2.973010058360246,10,null,"Root holding(s)",{"interactive":true,"className":"","pane":"holdingsPane","stroke":true,"color":"black","weight":5,"opacity":0.5,"fill":true,"fillColor":"black","fillOpacity":0.2},{"showCoverageOnHover":true,"zoomToBoundsOnClick":true,"spiderfyOnMaxZoom":true,"removeOutsideVisibleBounds":true,"spiderLegPolylineOptions":{"weight":1.5,"color":"#222","opacity":0.5},"freezeAtZoom":false},null,"<b>Root holding<\/b><br><b>cph:<\/b> 95/216/1100<br><b>holding_type:<\/b> NBUZZ<br><b>herd_size:<\/b> 9294",null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]},{"method":"addCircleMarkers","args":[[51.97547123900536,55.5962326322733,53.03632949264616,52.72330731689453,54.58764878028843,57.691987453391,51.85255634536631,52.1935818898291,53.50583063954677],[5.709143053220052,-2.239221192053663,-0.4189714941543531,-4.813809943331969,-0.2693998861138167,1.531669719343421,-0.529457526950595,2.619264793085283,-5.49156489052311],10,null,"Originating holdings",{"interactive":true,"className":"","pane":"holdingsPane","stroke":true,"color":"blue","weight":5,"opacity":0.5,"fill":true,"fillColor":"blue","fillOpacity":0.2},{"showCoverageOnHover":true,"zoomToBoundsOnClick":true,"spiderfyOnMaxZoom":true,"removeOutsideVisibleBounds":true,"spiderLegPolylineOptions":{"weight":1.5,"color":"#222","opacity":0.5},"freezeAtZoom":false},null,["<b>Originating holding<\/b><br><b>cph:<\/b> 32/532/8560<br><b>holding_type:<\/b> HEJDE<br><b>herd_size:<\/b> 2140","<b>Originating holding<\/b><br><b>cph:<\/b> 75/345/2020<br><b>holding_type:<\/b> GCUHF<br><b>herd_size:<\/b> 1676","<b>Originating holding<\/b><br><b>cph:<\/b> 97/665/7174<br><b>holding_type:<\/b> CYCZH<br><b>herd_size:<\/b> 3818","<b>Originating holding<\/b><br><b>cph:<\/b> 47/479/9810<br><b>holding_type:<\/b> DFYWQ<br><b>herd_size:<\/b> 4924","<b>Originating holding<\/b><br><b>cph:<\/b> 46/782/4470<br><b>holding_type:<\/b> HLUSY<br><b>herd_size:<\/b> 5057","<b>Originating holding<\/b><br><b>cph:<\/b> 75/929/3476<br><b>holding_type:<\/b> THRXE<br><b>herd_size:<\/b> 5781","<b>Originating holding<\/b><br><b>cph:<\/b> 27/664/8542<br><b>holding_type:<\/b> YNPTP<br><b>herd_size:<\/b> 5900","<b>Originating holding<\/b><br><b>cph:<\/b> 68/763/2008<br><b>holding_type:<\/b> SVYNH<br><b>herd_size:<\/b> 6577","<b>Originating holding<\/b><br><b>cph:<\/b> 50/651/8553<br><b>holding_type:<\/b> MNRFB<br><b>herd_size:<\/b> 8826"],null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]},{"method":"addCircleMarkers","args":[[52.32748769739458,57.59973763607515,52.97352449489549,50.73267301970724,57.91324063052767],[4.812667616172421,-3.953480697781026,6.634899107698601,-4.239834059728081,-6.665831129204032],10,null,"Destination holdings",{"interactive":true,"className":"","pane":"holdingsPane","stroke":true,"color":"red","weight":5,"opacity":0.5,"fill":true,"fillColor":"red","fillOpacity":0.2},{"showCoverageOnHover":true,"zoomToBoundsOnClick":true,"spiderfyOnMaxZoom":true,"removeOutsideVisibleBounds":true,"spiderLegPolylineOptions":{"weight":1.5,"color":"#222","opacity":0.5},"freezeAtZoom":false},null,["<b>Destination holding<\/b><br><b>cph:<\/b> 46/908/7292<br><b>holding_type:<\/b> WLRZA<br><b>herd_size:<\/b> 3155","<b>Destination holding<\/b><br><b>cph:<\/b> 77/112/3288<br><b>holding_type:<\/b> JPOXU<br><b>herd_size:<\/b> 3652","<b>Destination holding<\/b><br><b>cph:<\/b> 59/623/8252<br><b>holding_type:<\/b> BKBDY<br><b>herd_size:<\/b> 4034","<b>Destination holding<\/b><br><b>cph:<\/b> 25/591/6144<br><b>holding_type:<\/b> DNNZD<br><b>herd_size:<\/b> 9142","<b>Destination holding<\/b><br><b>cph:<\/b> 47/319/4630<br><b>holding_type:<\/b> HWVGS<br><b>herd_size:<\/b> 9592"],null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]},{"method":"hideGroup","args":[["Ingoing weight","Ingoing moves","Outgoing weight","Outgoing moves"]]},{"method":"addControl","args":["<div>\n  <strong>Movement weight<\/strong>\n<\/div>\n<div>\n  <img src=\"data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20version%3D%221.1%22%20width%3D%2220%22%20height%3D%222%22%3E%0A%20%20%3Crect%20id%3D%22rect%22%20x%3D%220%22%20y%3D%220%22%20height%3D%222%22%20width%3D%2220%22%20stroke%3D%22transparent%22%20fill%3D%22red%22%20stroke-opacity%3D%221%22%20fill-opacity%3D%221%22%20stroke-width%3D%220%22%3E%3C%2Frect%3E%0A%3C%2Fsvg%3E\" style=\"vertical-align: middle; margin: 5px; margin-right: 0px; margin-left: 0px\" height=\"2\" width=\"20\"/>\n  <span style=\"\">10 - 99<\/span>\n<\/div>\n<div>\n  <img src=\"data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20version%3D%221.1%22%20width%3D%2220%22%20height%3D%224%22%3E%0A%20%20%3Crect%20id%3D%22rect%22%20x%3D%220%22%20y%3D%220%22%20height%3D%224%22%20width%3D%2220%22%20stroke%3D%22transparent%22%20fill%3D%22red%22%20stroke-opacity%3D%221%22%20fill-opacity%3D%221%22%20stroke-width%3D%220%22%3E%3C%2Frect%3E%0A%3C%2Fsvg%3E\" style=\"vertical-align: middle; margin: 5px; margin-right: 0px; margin-left: 0px\" height=\"4\" width=\"20\"/>\n  <span style=\"\">100 - 999<\/span>\n<\/div>","bottomright",null,"info legend leaflet-control"]}],"limits":{"lat":[50.73267301970724,57.91324063052767],"lng":[-6.665831129204032,6.634899107698601]}},"evals":[],"jsHooks":{"render":[{"code":"function(el, x, data) {\n  return (function(el, x, data) {\n    var edge;\n    var movement_geojson_in = data.movement_geojson_in;\n    var movement_geojson_out = data.movement_geojson_out;\n    var dates_in = data.dates_in;\n    var dates_out = data.dates_out;\n    var max_distance = data.max_distance;\n    var map = this;\n\n    /*\n    // Add interactive sidebar -- not using this at the moment\n\n    var sidebar = L.control.sidebar('sidebar', {\n        closeButton: true,\n        position: 'left'\n    });\n    map.addControl(sidebar);\n    */\n\n    // Create a pane with a zIndex of 450 to make sure the holding markers are\n    // drawn on top of the admin area backgrounds\n    map.createPane('holdingsPane');\n    map.getPane('holdingsPane').style.zIndex = 450;\n\n    // Retrieve layer groups defined in R, allowing use in grouped layer control panel\n\n    var groups = {\n      originating_holdings: map.layerManager.getLayerGroup('Originating holdings'),\n      destination_holdings: map.layerManager.getLayerGroup('Destination holdings'),\n      ingoing_edges: new L.layerGroup(),\n      outgoing_edges: new L.layerGroup(),\n    };\n\n    /*\n    Create layers for edges (separately for ingoing and outgoing chains): using\n    straight lines with arrowheads, and varying offsets to create parallel lines\n    when moves are repeated.\n    NB: to refer to a col header in GeoJSON, need to use '.properties.col_header'\n    */\n\n    // First make list of properties I don't want to report on in the map\n    var excludedProperties = ['direction', 'edge_id_on_connection', 'edge_width', 'offset']\n\n    // Create a pane with a zIndex of 450 to make sure the movement arrows are\n    // drawn on top of the admin area backgrounds\n    map.createPane('movementArrows');\n    map.getPane('movementArrows').style.zIndex = 450;\n\n    // Add ingoing and outgoing movements\n    if (movement_geojson_in.features.length > 0) {\n      movement_geojson_in.features.forEach(function(edge){\n        var edge_coords = L.GeoJSON.coordsToLatLngs(edge.geometry.coordinates, 0);\n        var polyline = L.polyline(edge_coords, {\n                color: 'blue',\n                weight: edge.properties.edge_width,\n                opacity: 1,\n                offset: edge.properties.offset,\n                pane: 'movementArrows'\n              }).arrowheads({\n                offset: 0, yawn: 30, fill: true, size: '25px'\n              }).addTo(groups.ingoing_edges)\n\n        // Add popup with text based on all edge properties\n        var text = '';\n        for (var prop in edge.properties) {\n          if (edge.properties.hasOwnProperty(prop) && !excludedProperties.includes(prop)) {\n            text += '<b>'+ prop + ': <\/b>' + edge.properties[prop] + '<br>';\n          }\n        }\n        polyline.bindPopup(text);\n      });\n    };\n    groups.ingoing_edges.addTo(map);\n    if (movement_geojson_out.features.length > 0) {\n      movement_geojson_out.features.forEach(function(edge){\n        var edge_coords = L.GeoJSON.coordsToLatLngs(edge.geometry.coordinates, 0);\n        var polyline = L.polyline(edge_coords, {\n                color: 'red',\n                weight: edge.properties.edge_width,\n                opacity: 1,\n                offset: edge.properties.offset,\n                pane: 'movementArrows'\n              }).arrowheads({\n                offset: 0, yawn: 30, fill: true, size: '25px'\n              }).addTo(groups.outgoing_edges)\n\n        // Add popup with text based on all edge properties\n        var text = '';\n        for (var prop in edge.properties) {\n          if (edge.properties.hasOwnProperty(prop) && !excludedProperties.includes(prop)) {\n            text += '<b>'+ prop + ': <\/b>' + edge.properties[prop] + '<br>';\n          }\n        }\n        polyline.bindPopup(text);\n      });\n      groups.outgoing_edges.addTo(map);\n    };\n\n\n    // Set up grouped layer control\n    var groupedOverlays = {\n      ['Incoming contact chains<br>(' + dates_in + (max_distance !== null ? ',<br>max distance from root: ' + max_distance : '') + ')']: {\n          '<span class=\"fa-stack\" style=\"max-width: 12px; max-height: 12px; vertical-align: top;\"><i class=\"fa-solid fa-circle fa-stack-1x\" style=\"color: blue; opacity: 0.2\"><\/i><i class=\"fa-regular fa-circle fa-stack-1x\" style=\"color: blue; opacity: 0.5\"><\/i><\/span> Originating holdings': groups.originating_holdings ?? [],\n          '<i class=\"fa-solid fa-right-long\" style=\"color: blue\"><\/i> Incoming movements': groups.ingoing_edges ?? []},\n      ['Outgoing contact chains<br>(' + dates_out + (max_distance !== null ? ',<br>max distance from root: ' + max_distance : '') + ')']: {\n          '<span class=\"fa-stack\" style=\"max-width: 12px; max-height: 12px; vertical-align: top;\"><i class=\"fa-solid fa-circle fa-stack-1x\" style=\"color: red; opacity: 0.2\"><\/i><i class=\"fa-regular fa-circle fa-stack-1x\" style=\"color: red; opacity: 0.5\"><\/i><\/span> Destination holdings': groups.destination_holdings ?? [],\n          '<i class=\"fa-solid fa-right-long\" style=\"color: red\"><\/i> Outgoing movements': groups.outgoing_edges ?? []}\n      };\n\n    // Make the Administrative area groups exclusive (use radio inputs)\n    var options = {\n      exclusiveGroups: ['Administrative areas'],\n      collapsed: false};\n\n    var layerControl = L.control.groupedLayers(null, groupedOverlays, options);\n    layerControl.addTo(map);\n\n    // If admin areas are provided, add these to layer control\n\n    var adminAreas = map.layerManager.getLayerGroup('Administrative areas')\n    if (adminAreas) {\n      layerControl.addOverlay(adminAreas,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-regular fa-square fa-stack-2x\" style=\"color: black\"><\/i><\/span> Area boundaries only', 'Administrative areas');\n      var ingoingMoves = map.layerManager.getLayerGroup('Ingoing moves');\n      layerControl.addOverlay(ingoingMoves,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-solid fa-square fa-stack-2x\" style=\"color: blue; opacity: 0.2\"><\/i><i class=\"fa-solid fa-arrow-right-arrow-left fa-sm fa-stack-1x\" style=\"color: blue;\"><\/i><\/span> Total ingoing moves from area', 'Administrative areas');\n      var ingoingWeight = map.layerManager.getLayerGroup('Ingoing weight');\n      layerControl.addOverlay(ingoingWeight,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-solid fa-square fa-stack-2x\" style=\"color: blue; opacity: 0.2\"><\/i><i class=\"fa-solid fa-weight-hanging fa-sm fa-stack-1x\" style=\"color: blue;\"><\/i><\/span> Total ingoing weight from area', 'Administrative areas');\n      var outgoingMoves = map.layerManager.getLayerGroup('Outgoing moves');\n      layerControl.addOverlay(outgoingMoves,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-solid fa-square fa-stack-2x\" style=\"color: red; opacity: 0.2\"><\/i><i class=\"fa-solid fa-arrow-right-arrow-left fa-sm fa-stack-1x\" style=\"color: red;\"><\/i><\/span> Total outgoing moves to area', 'Administrative areas');\n      var outgoingWeight = map.layerManager.getLayerGroup('Outgoing weight');\n      layerControl.addOverlay(outgoingWeight,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-solid fa-square fa-stack-2x\" style=\"color: red; opacity: 0.2\"><\/i><i class=\"fa-solid fa-weight-hanging fa-sm fa-stack-1x\" style=\"color: red;\"><\/i><\/span> Total outgoing weight to area', 'Administrative areas');\n\n    // Hide legends on first render, then toggle depending on which admin area map is active\n\n      var legendClasses = ['outgoing-moves', 'ingoing-moves', 'outgoing-weight', 'ingoing-weight'];\n      legendClasses.forEach(function(className) {\n        var legend = document.getElementsByClassName('info legend ' + className)[0];\n        if (legend) {\n          legend.style.display = 'none';\n        }\n      })\n\n      map.on('overlayadd',function(e){\n       if (e.layer === adminAreas){\n          var legendClasses = ['info legend outgoing-moves', 'info legend ingoing-moves', 'info legend outgoing-weight', 'info legend ingoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n        } else if (e.layer === ingoingMoves){\n          var legendClasses = ['info legend outgoing-moves', 'info legend outgoing-weight', 'info legend ingoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n          var correctLegend = document.getElementsByClassName('info legend ingoing-moves')[0]\n          correctLegend.style.display='block';\n        } else if (e.layer === ingoingWeight){\n          // var inWeightLeg = map.layerManager.getLayer('Ingoing_weight_legend');\n          // inWeightLeg.addTo(map);\n          var legendClasses = ['info legend outgoing-moves', 'info legend ingoing-moves', 'info legend outgoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n          var correctLegend = document.getElementsByClassName('info legend ingoing-weight')[0]\n          correctLegend.style.display='block';\n        } else if (e.layer === outgoingMoves){\n          // var outMovesLeg = map.layerManager.getLayer('Outgoing_moves_legend');\n          // outMovesLeg.addTo(map);\n          var legendClasses = ['info legend ingoing-moves', 'info legend outgoing-weight', 'info legend ingoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n          var correctLegend = document.getElementsByClassName('info legend outgoing-moves')[0]\n          correctLegend.style.display='block';\n        } else if (e.layer === outgoingWeight){\n          // var outWeightLeg = map.layerManager.getLayer('Outgoing_weight_legend');\n          // outWeightLeg.addTo(map);\n          var legendClasses = ['info legend outgoing-moves', 'info legend ingoing-moves', 'info legend ingoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n          var correctLegend = document.getElementsByClassName('info legend outgoing-weight')[0]\n          correctLegend.style.display='block';\n        }\n\n      });\n    }\n    }\n\n).call(this.getMap(), el, x, data);\n}","data":{"movement_geojson_in":{"type":"FeatureCollection","features":[{"type":"Feature","properties":{"departure_cph":"27/664/8542","dest_cph":"75/929/3476","departure_date":"2019-04-03","qty_pigs":69.0,"movement_reference":523348.0,"direction":"in","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[-0.529457526950595,51.85255634536631],[1.5316697193434215,57.691987453391]]}},{"type":"Feature","properties":{"departure_cph":"32/532/8560","dest_cph":"75/929/3476","departure_date":"2019-04-07","qty_pigs":60.0,"movement_reference":207280.0,"direction":"in","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[5.7091430532200528,51.97547123900536],[1.5316697193434215,57.691987453391]]}},{"type":"Feature","properties":{"departure_cph":"46/782/4470","dest_cph":"75/929/3476","departure_date":"2019-04-10","qty_pigs":105.0,"movement_reference":802270.0,"direction":"in","edge_id_on_connection":1,"edge_width":4.0,"offset":-2.5},"geometry":{"type":"LineString","coordinates":[[-0.26939988611381668,54.587648780288429],[1.5316697193434215,57.691987453391]]}},{"type":"Feature","properties":{"departure_cph":"47/479/9810","dest_cph":"68/763/2008","departure_date":"2019-04-11","qty_pigs":132.0,"movement_reference":313751.0,"direction":"in","edge_id_on_connection":1,"edge_width":4.0,"offset":-2.5},"geometry":{"type":"LineString","coordinates":[[-4.813809943331969,52.723307316894537],[2.6192647930852828,52.1935818898291]]}},{"type":"Feature","properties":{"departure_cph":"50/651/8553","dest_cph":"95/216/1100","departure_date":"2019-04-21","qty_pigs":57.0,"movement_reference":159675.0,"direction":"in","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[-5.49156489052311,53.505830639546768],[2.973010058360246,54.87183548191156]]}},{"type":"Feature","properties":{"departure_cph":"68/763/2008","dest_cph":"95/216/1100","departure_date":"2019-04-21","qty_pigs":36.0,"movement_reference":273049.0,"direction":"in","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[2.6192647930852828,52.1935818898291],[2.973010058360246,54.87183548191156]]}},{"type":"Feature","properties":{"departure_cph":"75/345/2020","dest_cph":"68/763/2008","departure_date":"2019-04-16","qty_pigs":177.0,"movement_reference":397128.0,"direction":"in","edge_id_on_connection":1,"edge_width":4.0,"offset":-2.5},"geometry":{"type":"LineString","coordinates":[[-2.239221192053663,55.5962326322733],[2.6192647930852828,52.1935818898291]]}},{"type":"Feature","properties":{"departure_cph":"75/929/3476","dest_cph":"50/651/8553","departure_date":"2019-04-17","qty_pigs":53.0,"movement_reference":558949.0,"direction":"in","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[1.5316697193434215,57.691987453391],[-5.49156489052311,53.505830639546768]]}},{"type":"Feature","properties":{"departure_cph":"97/665/7174","dest_cph":"46/782/4470","departure_date":"2019-04-03","qty_pigs":175.0,"movement_reference":224638.0,"direction":"in","edge_id_on_connection":1,"edge_width":4.0,"offset":-2.5},"geometry":{"type":"LineString","coordinates":[[-0.4189714941543531,53.03632949264616],[-0.26939988611381668,54.587648780288429]]}}]},"movement_geojson_out":{"type":"FeatureCollection","features":[{"type":"Feature","properties":{"departure_cph":"46/908/7292","dest_cph":"77/112/3288","departure_date":"2019-06-18","qty_pigs":52.0,"movement_reference":351321.0,"direction":"out","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[4.812667616172421,52.32748769739458],[-3.9534806977810259,57.599737636075158]]}},{"type":"Feature","properties":{"departure_cph":"47/319/4630","dest_cph":"25/591/6144","departure_date":"2019-06-20","qty_pigs":69.0,"movement_reference":458178.0,"direction":"out","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[-6.665831129204032,57.913240630527678],[-4.239834059728081,50.732673019707238]]}},{"type":"Feature","properties":{"departure_cph":"47/319/4630","dest_cph":"46/908/7292","departure_date":"2019-06-18","qty_pigs":183.0,"movement_reference":66096.0,"direction":"out","edge_id_on_connection":1,"edge_width":4.0,"offset":-2.5},"geometry":{"type":"LineString","coordinates":[[-6.665831129204032,57.913240630527678],[4.812667616172421,52.32748769739458]]}},{"type":"Feature","properties":{"departure_cph":"95/216/1100","dest_cph":"47/319/4630","departure_date":"2019-06-05","qty_pigs":92.0,"movement_reference":674885.0,"direction":"out","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[2.973010058360246,54.87183548191156],[-6.665831129204032,57.913240630527678]]}},{"type":"Feature","properties":{"departure_cph":"95/216/1100","dest_cph":"59/623/8252","departure_date":"2019-06-15","qty_pigs":171.0,"movement_reference":945545.0,"direction":"out","edge_id_on_connection":1,"edge_width":4.0,"offset":-2.5},"geometry":{"type":"LineString","coordinates":[[2.973010058360246,54.87183548191156],[6.634899107698601,52.973524494895489]]}}]},"dates_in":"2019-04-02 to 2019-07-01","dates_out":"2019-04-02 to 2019-07-01","max_distance":null}}]}}</script>

# trace_contact_chains() works when a single root is given, with inBegin etc., and both in- and outgoing contact chains exist

    <div id="htmlwidget-" style="width:100%;height:400px;" class="leaflet html-widget"></div>
    <script type="application/json" data-for="htmlwidget-">{"x":{"options":{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}}},"calls":[{"method":"addTiles","args":["https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",null,null,{"minZoom":0,"maxZoom":18,"tileSize":256,"subdomains":"abc","errorTileUrl":"","tms":false,"noWrap":false,"zoomOffset":0,"zoomReverse":false,"opacity":1,"zIndex":1,"detectRetina":false,"attribution":"&copy; <a href=\"https://openstreetmap.org/copyright/\">OpenStreetMap<\/a>,  <a href=\"https://opendatacommons.org/licenses/odbl/\">ODbL<\/a>"}]},{"method":"addCircleMarkers","args":[54.87183548191156,2.973010058360246,10,null,"Root holding(s)",{"interactive":true,"className":"","pane":"holdingsPane","stroke":true,"color":"black","weight":5,"opacity":0.5,"fill":true,"fillColor":"black","fillOpacity":0.2},{"showCoverageOnHover":true,"zoomToBoundsOnClick":true,"spiderfyOnMaxZoom":true,"removeOutsideVisibleBounds":true,"spiderLegPolylineOptions":{"weight":1.5,"color":"#222","opacity":0.5},"freezeAtZoom":false},null,"<b>Root holding<\/b><br><b>cph:<\/b> 95/216/1100<br><b>holding_type:<\/b> NBUZZ<br><b>herd_size:<\/b> 9294",null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]},{"method":"addCircleMarkers","args":[[51.97547123900536,55.5962326322733,53.03632949264616,52.72330731689453,54.58764878028843,57.691987453391,51.85255634536631,52.1935818898291,53.50583063954677],[5.709143053220052,-2.239221192053663,-0.4189714941543531,-4.813809943331969,-0.2693998861138167,1.531669719343421,-0.529457526950595,2.619264793085283,-5.49156489052311],10,null,"Originating holdings",{"interactive":true,"className":"","pane":"holdingsPane","stroke":true,"color":"blue","weight":5,"opacity":0.5,"fill":true,"fillColor":"blue","fillOpacity":0.2},{"showCoverageOnHover":true,"zoomToBoundsOnClick":true,"spiderfyOnMaxZoom":true,"removeOutsideVisibleBounds":true,"spiderLegPolylineOptions":{"weight":1.5,"color":"#222","opacity":0.5},"freezeAtZoom":false},null,["<b>Originating holding<\/b><br><b>cph:<\/b> 32/532/8560<br><b>holding_type:<\/b> HEJDE<br><b>herd_size:<\/b> 2140","<b>Originating holding<\/b><br><b>cph:<\/b> 75/345/2020<br><b>holding_type:<\/b> GCUHF<br><b>herd_size:<\/b> 1676","<b>Originating holding<\/b><br><b>cph:<\/b> 97/665/7174<br><b>holding_type:<\/b> CYCZH<br><b>herd_size:<\/b> 3818","<b>Originating holding<\/b><br><b>cph:<\/b> 47/479/9810<br><b>holding_type:<\/b> DFYWQ<br><b>herd_size:<\/b> 4924","<b>Originating holding<\/b><br><b>cph:<\/b> 46/782/4470<br><b>holding_type:<\/b> HLUSY<br><b>herd_size:<\/b> 5057","<b>Originating holding<\/b><br><b>cph:<\/b> 75/929/3476<br><b>holding_type:<\/b> THRXE<br><b>herd_size:<\/b> 5781","<b>Originating holding<\/b><br><b>cph:<\/b> 27/664/8542<br><b>holding_type:<\/b> YNPTP<br><b>herd_size:<\/b> 5900","<b>Originating holding<\/b><br><b>cph:<\/b> 68/763/2008<br><b>holding_type:<\/b> SVYNH<br><b>herd_size:<\/b> 6577","<b>Originating holding<\/b><br><b>cph:<\/b> 50/651/8553<br><b>holding_type:<\/b> MNRFB<br><b>herd_size:<\/b> 8826"],null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]},{"method":"addCircleMarkers","args":[[52.32748769739458,57.59973763607515,52.97352449489549,50.73267301970724,57.91324063052767],[4.812667616172421,-3.953480697781026,6.634899107698601,-4.239834059728081,-6.665831129204032],10,null,"Destination holdings",{"interactive":true,"className":"","pane":"holdingsPane","stroke":true,"color":"red","weight":5,"opacity":0.5,"fill":true,"fillColor":"red","fillOpacity":0.2},{"showCoverageOnHover":true,"zoomToBoundsOnClick":true,"spiderfyOnMaxZoom":true,"removeOutsideVisibleBounds":true,"spiderLegPolylineOptions":{"weight":1.5,"color":"#222","opacity":0.5},"freezeAtZoom":false},null,["<b>Destination holding<\/b><br><b>cph:<\/b> 46/908/7292<br><b>holding_type:<\/b> WLRZA<br><b>herd_size:<\/b> 3155","<b>Destination holding<\/b><br><b>cph:<\/b> 77/112/3288<br><b>holding_type:<\/b> JPOXU<br><b>herd_size:<\/b> 3652","<b>Destination holding<\/b><br><b>cph:<\/b> 59/623/8252<br><b>holding_type:<\/b> BKBDY<br><b>herd_size:<\/b> 4034","<b>Destination holding<\/b><br><b>cph:<\/b> 25/591/6144<br><b>holding_type:<\/b> DNNZD<br><b>herd_size:<\/b> 9142","<b>Destination holding<\/b><br><b>cph:<\/b> 47/319/4630<br><b>holding_type:<\/b> HWVGS<br><b>herd_size:<\/b> 9592"],null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]},{"method":"hideGroup","args":[["Ingoing weight","Ingoing moves","Outgoing weight","Outgoing moves"]]},{"method":"addControl","args":["<div>\n  <strong>Movement weight<\/strong>\n<\/div>\n<div>\n  <img src=\"data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20version%3D%221.1%22%20width%3D%2220%22%20height%3D%222%22%3E%0A%20%20%3Crect%20id%3D%22rect%22%20x%3D%220%22%20y%3D%220%22%20height%3D%222%22%20width%3D%2220%22%20stroke%3D%22transparent%22%20fill%3D%22red%22%20stroke-opacity%3D%221%22%20fill-opacity%3D%221%22%20stroke-width%3D%220%22%3E%3C%2Frect%3E%0A%3C%2Fsvg%3E\" style=\"vertical-align: middle; margin: 5px; margin-right: 0px; margin-left: 0px\" height=\"2\" width=\"20\"/>\n  <span style=\"\">10 - 99<\/span>\n<\/div>\n<div>\n  <img src=\"data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20version%3D%221.1%22%20width%3D%2220%22%20height%3D%224%22%3E%0A%20%20%3Crect%20id%3D%22rect%22%20x%3D%220%22%20y%3D%220%22%20height%3D%224%22%20width%3D%2220%22%20stroke%3D%22transparent%22%20fill%3D%22red%22%20stroke-opacity%3D%221%22%20fill-opacity%3D%221%22%20stroke-width%3D%220%22%3E%3C%2Frect%3E%0A%3C%2Fsvg%3E\" style=\"vertical-align: middle; margin: 5px; margin-right: 0px; margin-left: 0px\" height=\"4\" width=\"20\"/>\n  <span style=\"\">100 - 999<\/span>\n<\/div>","bottomright",null,"info legend leaflet-control"]}],"limits":{"lat":[50.73267301970724,57.91324063052767],"lng":[-6.665831129204032,6.634899107698601]}},"evals":[],"jsHooks":{"render":[{"code":"function(el, x, data) {\n  return (function(el, x, data) {\n    var edge;\n    var movement_geojson_in = data.movement_geojson_in;\n    var movement_geojson_out = data.movement_geojson_out;\n    var dates_in = data.dates_in;\n    var dates_out = data.dates_out;\n    var max_distance = data.max_distance;\n    var map = this;\n\n    /*\n    // Add interactive sidebar -- not using this at the moment\n\n    var sidebar = L.control.sidebar('sidebar', {\n        closeButton: true,\n        position: 'left'\n    });\n    map.addControl(sidebar);\n    */\n\n    // Create a pane with a zIndex of 450 to make sure the holding markers are\n    // drawn on top of the admin area backgrounds\n    map.createPane('holdingsPane');\n    map.getPane('holdingsPane').style.zIndex = 450;\n\n    // Retrieve layer groups defined in R, allowing use in grouped layer control panel\n\n    var groups = {\n      originating_holdings: map.layerManager.getLayerGroup('Originating holdings'),\n      destination_holdings: map.layerManager.getLayerGroup('Destination holdings'),\n      ingoing_edges: new L.layerGroup(),\n      outgoing_edges: new L.layerGroup(),\n    };\n\n    /*\n    Create layers for edges (separately for ingoing and outgoing chains): using\n    straight lines with arrowheads, and varying offsets to create parallel lines\n    when moves are repeated.\n    NB: to refer to a col header in GeoJSON, need to use '.properties.col_header'\n    */\n\n    // First make list of properties I don't want to report on in the map\n    var excludedProperties = ['direction', 'edge_id_on_connection', 'edge_width', 'offset']\n\n    // Create a pane with a zIndex of 450 to make sure the movement arrows are\n    // drawn on top of the admin area backgrounds\n    map.createPane('movementArrows');\n    map.getPane('movementArrows').style.zIndex = 450;\n\n    // Add ingoing and outgoing movements\n    if (movement_geojson_in.features.length > 0) {\n      movement_geojson_in.features.forEach(function(edge){\n        var edge_coords = L.GeoJSON.coordsToLatLngs(edge.geometry.coordinates, 0);\n        var polyline = L.polyline(edge_coords, {\n                color: 'blue',\n                weight: edge.properties.edge_width,\n                opacity: 1,\n                offset: edge.properties.offset,\n                pane: 'movementArrows'\n              }).arrowheads({\n                offset: 0, yawn: 30, fill: true, size: '25px'\n              }).addTo(groups.ingoing_edges)\n\n        // Add popup with text based on all edge properties\n        var text = '';\n        for (var prop in edge.properties) {\n          if (edge.properties.hasOwnProperty(prop) && !excludedProperties.includes(prop)) {\n            text += '<b>'+ prop + ': <\/b>' + edge.properties[prop] + '<br>';\n          }\n        }\n        polyline.bindPopup(text);\n      });\n    };\n    groups.ingoing_edges.addTo(map);\n    if (movement_geojson_out.features.length > 0) {\n      movement_geojson_out.features.forEach(function(edge){\n        var edge_coords = L.GeoJSON.coordsToLatLngs(edge.geometry.coordinates, 0);\n        var polyline = L.polyline(edge_coords, {\n                color: 'red',\n                weight: edge.properties.edge_width,\n                opacity: 1,\n                offset: edge.properties.offset,\n                pane: 'movementArrows'\n              }).arrowheads({\n                offset: 0, yawn: 30, fill: true, size: '25px'\n              }).addTo(groups.outgoing_edges)\n\n        // Add popup with text based on all edge properties\n        var text = '';\n        for (var prop in edge.properties) {\n          if (edge.properties.hasOwnProperty(prop) && !excludedProperties.includes(prop)) {\n            text += '<b>'+ prop + ': <\/b>' + edge.properties[prop] + '<br>';\n          }\n        }\n        polyline.bindPopup(text);\n      });\n      groups.outgoing_edges.addTo(map);\n    };\n\n\n    // Set up grouped layer control\n    var groupedOverlays = {\n      ['Incoming contact chains<br>(' + dates_in + (max_distance !== null ? ',<br>max distance from root: ' + max_distance : '') + ')']: {\n          '<span class=\"fa-stack\" style=\"max-width: 12px; max-height: 12px; vertical-align: top;\"><i class=\"fa-solid fa-circle fa-stack-1x\" style=\"color: blue; opacity: 0.2\"><\/i><i class=\"fa-regular fa-circle fa-stack-1x\" style=\"color: blue; opacity: 0.5\"><\/i><\/span> Originating holdings': groups.originating_holdings ?? [],\n          '<i class=\"fa-solid fa-right-long\" style=\"color: blue\"><\/i> Incoming movements': groups.ingoing_edges ?? []},\n      ['Outgoing contact chains<br>(' + dates_out + (max_distance !== null ? ',<br>max distance from root: ' + max_distance : '') + ')']: {\n          '<span class=\"fa-stack\" style=\"max-width: 12px; max-height: 12px; vertical-align: top;\"><i class=\"fa-solid fa-circle fa-stack-1x\" style=\"color: red; opacity: 0.2\"><\/i><i class=\"fa-regular fa-circle fa-stack-1x\" style=\"color: red; opacity: 0.5\"><\/i><\/span> Destination holdings': groups.destination_holdings ?? [],\n          '<i class=\"fa-solid fa-right-long\" style=\"color: red\"><\/i> Outgoing movements': groups.outgoing_edges ?? []}\n      };\n\n    // Make the Administrative area groups exclusive (use radio inputs)\n    var options = {\n      exclusiveGroups: ['Administrative areas'],\n      collapsed: false};\n\n    var layerControl = L.control.groupedLayers(null, groupedOverlays, options);\n    layerControl.addTo(map);\n\n    // If admin areas are provided, add these to layer control\n\n    var adminAreas = map.layerManager.getLayerGroup('Administrative areas')\n    if (adminAreas) {\n      layerControl.addOverlay(adminAreas,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-regular fa-square fa-stack-2x\" style=\"color: black\"><\/i><\/span> Area boundaries only', 'Administrative areas');\n      var ingoingMoves = map.layerManager.getLayerGroup('Ingoing moves');\n      layerControl.addOverlay(ingoingMoves,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-solid fa-square fa-stack-2x\" style=\"color: blue; opacity: 0.2\"><\/i><i class=\"fa-solid fa-arrow-right-arrow-left fa-sm fa-stack-1x\" style=\"color: blue;\"><\/i><\/span> Total ingoing moves from area', 'Administrative areas');\n      var ingoingWeight = map.layerManager.getLayerGroup('Ingoing weight');\n      layerControl.addOverlay(ingoingWeight,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-solid fa-square fa-stack-2x\" style=\"color: blue; opacity: 0.2\"><\/i><i class=\"fa-solid fa-weight-hanging fa-sm fa-stack-1x\" style=\"color: blue;\"><\/i><\/span> Total ingoing weight from area', 'Administrative areas');\n      var outgoingMoves = map.layerManager.getLayerGroup('Outgoing moves');\n      layerControl.addOverlay(outgoingMoves,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-solid fa-square fa-stack-2x\" style=\"color: red; opacity: 0.2\"><\/i><i class=\"fa-solid fa-arrow-right-arrow-left fa-sm fa-stack-1x\" style=\"color: red;\"><\/i><\/span> Total outgoing moves to area', 'Administrative areas');\n      var outgoingWeight = map.layerManager.getLayerGroup('Outgoing weight');\n      layerControl.addOverlay(outgoingWeight,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-solid fa-square fa-stack-2x\" style=\"color: red; opacity: 0.2\"><\/i><i class=\"fa-solid fa-weight-hanging fa-sm fa-stack-1x\" style=\"color: red;\"><\/i><\/span> Total outgoing weight to area', 'Administrative areas');\n\n    // Hide legends on first render, then toggle depending on which admin area map is active\n\n      var legendClasses = ['outgoing-moves', 'ingoing-moves', 'outgoing-weight', 'ingoing-weight'];\n      legendClasses.forEach(function(className) {\n        var legend = document.getElementsByClassName('info legend ' + className)[0];\n        if (legend) {\n          legend.style.display = 'none';\n        }\n      })\n\n      map.on('overlayadd',function(e){\n       if (e.layer === adminAreas){\n          var legendClasses = ['info legend outgoing-moves', 'info legend ingoing-moves', 'info legend outgoing-weight', 'info legend ingoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n        } else if (e.layer === ingoingMoves){\n          var legendClasses = ['info legend outgoing-moves', 'info legend outgoing-weight', 'info legend ingoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n          var correctLegend = document.getElementsByClassName('info legend ingoing-moves')[0]\n          correctLegend.style.display='block';\n        } else if (e.layer === ingoingWeight){\n          // var inWeightLeg = map.layerManager.getLayer('Ingoing_weight_legend');\n          // inWeightLeg.addTo(map);\n          var legendClasses = ['info legend outgoing-moves', 'info legend ingoing-moves', 'info legend outgoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n          var correctLegend = document.getElementsByClassName('info legend ingoing-weight')[0]\n          correctLegend.style.display='block';\n        } else if (e.layer === outgoingMoves){\n          // var outMovesLeg = map.layerManager.getLayer('Outgoing_moves_legend');\n          // outMovesLeg.addTo(map);\n          var legendClasses = ['info legend ingoing-moves', 'info legend outgoing-weight', 'info legend ingoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n          var correctLegend = document.getElementsByClassName('info legend outgoing-moves')[0]\n          correctLegend.style.display='block';\n        } else if (e.layer === outgoingWeight){\n          // var outWeightLeg = map.layerManager.getLayer('Outgoing_weight_legend');\n          // outWeightLeg.addTo(map);\n          var legendClasses = ['info legend outgoing-moves', 'info legend ingoing-moves', 'info legend ingoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n          var correctLegend = document.getElementsByClassName('info legend outgoing-weight')[0]\n          correctLegend.style.display='block';\n        }\n\n      });\n    }\n    }\n\n).call(this.getMap(), el, x, data);\n}","data":{"movement_geojson_in":{"type":"FeatureCollection","features":[{"type":"Feature","properties":{"departure_cph":"27/664/8542","dest_cph":"75/929/3476","departure_date":"2019-04-03","qty_pigs":69.0,"movement_reference":523348.0,"direction":"in","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[-0.529457526950595,51.85255634536631],[1.5316697193434215,57.691987453391]]}},{"type":"Feature","properties":{"departure_cph":"32/532/8560","dest_cph":"75/929/3476","departure_date":"2019-04-07","qty_pigs":60.0,"movement_reference":207280.0,"direction":"in","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[5.7091430532200528,51.97547123900536],[1.5316697193434215,57.691987453391]]}},{"type":"Feature","properties":{"departure_cph":"46/782/4470","dest_cph":"75/929/3476","departure_date":"2019-04-10","qty_pigs":105.0,"movement_reference":802270.0,"direction":"in","edge_id_on_connection":1,"edge_width":4.0,"offset":-2.5},"geometry":{"type":"LineString","coordinates":[[-0.26939988611381668,54.587648780288429],[1.5316697193434215,57.691987453391]]}},{"type":"Feature","properties":{"departure_cph":"47/479/9810","dest_cph":"68/763/2008","departure_date":"2019-04-11","qty_pigs":132.0,"movement_reference":313751.0,"direction":"in","edge_id_on_connection":1,"edge_width":4.0,"offset":-2.5},"geometry":{"type":"LineString","coordinates":[[-4.813809943331969,52.723307316894537],[2.6192647930852828,52.1935818898291]]}},{"type":"Feature","properties":{"departure_cph":"50/651/8553","dest_cph":"95/216/1100","departure_date":"2019-04-21","qty_pigs":57.0,"movement_reference":159675.0,"direction":"in","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[-5.49156489052311,53.505830639546768],[2.973010058360246,54.87183548191156]]}},{"type":"Feature","properties":{"departure_cph":"68/763/2008","dest_cph":"95/216/1100","departure_date":"2019-04-21","qty_pigs":36.0,"movement_reference":273049.0,"direction":"in","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[2.6192647930852828,52.1935818898291],[2.973010058360246,54.87183548191156]]}},{"type":"Feature","properties":{"departure_cph":"75/345/2020","dest_cph":"68/763/2008","departure_date":"2019-04-16","qty_pigs":177.0,"movement_reference":397128.0,"direction":"in","edge_id_on_connection":1,"edge_width":4.0,"offset":-2.5},"geometry":{"type":"LineString","coordinates":[[-2.239221192053663,55.5962326322733],[2.6192647930852828,52.1935818898291]]}},{"type":"Feature","properties":{"departure_cph":"75/929/3476","dest_cph":"50/651/8553","departure_date":"2019-04-17","qty_pigs":53.0,"movement_reference":558949.0,"direction":"in","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[1.5316697193434215,57.691987453391],[-5.49156489052311,53.505830639546768]]}},{"type":"Feature","properties":{"departure_cph":"97/665/7174","dest_cph":"46/782/4470","departure_date":"2019-04-03","qty_pigs":175.0,"movement_reference":224638.0,"direction":"in","edge_id_on_connection":1,"edge_width":4.0,"offset":-2.5},"geometry":{"type":"LineString","coordinates":[[-0.4189714941543531,53.03632949264616],[-0.26939988611381668,54.587648780288429]]}}]},"movement_geojson_out":{"type":"FeatureCollection","features":[{"type":"Feature","properties":{"departure_cph":"46/908/7292","dest_cph":"77/112/3288","departure_date":"2019-06-18","qty_pigs":52.0,"movement_reference":351321.0,"direction":"out","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[4.812667616172421,52.32748769739458],[-3.9534806977810259,57.599737636075158]]}},{"type":"Feature","properties":{"departure_cph":"47/319/4630","dest_cph":"25/591/6144","departure_date":"2019-06-20","qty_pigs":69.0,"movement_reference":458178.0,"direction":"out","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[-6.665831129204032,57.913240630527678],[-4.239834059728081,50.732673019707238]]}},{"type":"Feature","properties":{"departure_cph":"47/319/4630","dest_cph":"46/908/7292","departure_date":"2019-06-18","qty_pigs":183.0,"movement_reference":66096.0,"direction":"out","edge_id_on_connection":1,"edge_width":4.0,"offset":-2.5},"geometry":{"type":"LineString","coordinates":[[-6.665831129204032,57.913240630527678],[4.812667616172421,52.32748769739458]]}},{"type":"Feature","properties":{"departure_cph":"95/216/1100","dest_cph":"47/319/4630","departure_date":"2019-06-05","qty_pigs":92.0,"movement_reference":674885.0,"direction":"out","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[2.973010058360246,54.87183548191156],[-6.665831129204032,57.913240630527678]]}},{"type":"Feature","properties":{"departure_cph":"95/216/1100","dest_cph":"59/623/8252","departure_date":"2019-06-15","qty_pigs":171.0,"movement_reference":945545.0,"direction":"out","edge_id_on_connection":1,"edge_width":4.0,"offset":-2.5},"geometry":{"type":"LineString","coordinates":[[2.973010058360246,54.87183548191156],[6.634899107698601,52.973524494895489]]}}]},"dates_in":"2019-04-01 to 2019-07-01","dates_out":"2019-04-01 to 2019-07-01","max_distance":null}}]}}</script>

# trace_contact_chains() works as expected when a maxDistance is given

    <div id="htmlwidget-" style="width:100%;height:400px;" class="leaflet html-widget"></div>
    <script type="application/json" data-for="htmlwidget-">{"x":{"options":{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}}},"calls":[{"method":"addTiles","args":["https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",null,null,{"minZoom":0,"maxZoom":18,"tileSize":256,"subdomains":"abc","errorTileUrl":"","tms":false,"noWrap":false,"zoomOffset":0,"zoomReverse":false,"opacity":1,"zIndex":1,"detectRetina":false,"attribution":"&copy; <a href=\"https://openstreetmap.org/copyright/\">OpenStreetMap<\/a>,  <a href=\"https://opendatacommons.org/licenses/odbl/\">ODbL<\/a>"}]},{"method":"addCircleMarkers","args":[54.87183548191156,2.973010058360246,10,null,"Root holding(s)",{"interactive":true,"className":"","pane":"holdingsPane","stroke":true,"color":"black","weight":5,"opacity":0.5,"fill":true,"fillColor":"black","fillOpacity":0.2},{"showCoverageOnHover":true,"zoomToBoundsOnClick":true,"spiderfyOnMaxZoom":true,"removeOutsideVisibleBounds":true,"spiderLegPolylineOptions":{"weight":1.5,"color":"#222","opacity":0.5},"freezeAtZoom":false},null,"<b>Root holding<\/b><br><b>cph:<\/b> 95/216/1100<br><b>holding_type:<\/b> NBUZZ<br><b>herd_size:<\/b> 9294",null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]},{"method":"addCircleMarkers","args":[[55.5962326322733,52.72330731689453,57.691987453391,52.1935818898291,53.50583063954677],[-2.239221192053663,-4.813809943331969,1.531669719343421,2.619264793085283,-5.49156489052311],10,null,"Originating holdings",{"interactive":true,"className":"","pane":"holdingsPane","stroke":true,"color":"blue","weight":5,"opacity":0.5,"fill":true,"fillColor":"blue","fillOpacity":0.2},{"showCoverageOnHover":true,"zoomToBoundsOnClick":true,"spiderfyOnMaxZoom":true,"removeOutsideVisibleBounds":true,"spiderLegPolylineOptions":{"weight":1.5,"color":"#222","opacity":0.5},"freezeAtZoom":false},null,["<b>Originating holding<\/b><br><b>cph:<\/b> 75/345/2020<br><b>holding_type:<\/b> GCUHF<br><b>herd_size:<\/b> 1676","<b>Originating holding<\/b><br><b>cph:<\/b> 47/479/9810<br><b>holding_type:<\/b> DFYWQ<br><b>herd_size:<\/b> 4924","<b>Originating holding<\/b><br><b>cph:<\/b> 75/929/3476<br><b>holding_type:<\/b> THRXE<br><b>herd_size:<\/b> 5781","<b>Originating holding<\/b><br><b>cph:<\/b> 68/763/2008<br><b>holding_type:<\/b> SVYNH<br><b>herd_size:<\/b> 6577","<b>Originating holding<\/b><br><b>cph:<\/b> 50/651/8553<br><b>holding_type:<\/b> MNRFB<br><b>herd_size:<\/b> 8826"],null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]},{"method":"addCircleMarkers","args":[[52.32748769739458,52.97352449489549,50.73267301970724,57.91324063052767],[4.812667616172421,6.634899107698601,-4.239834059728081,-6.665831129204032],10,null,"Destination holdings",{"interactive":true,"className":"","pane":"holdingsPane","stroke":true,"color":"red","weight":5,"opacity":0.5,"fill":true,"fillColor":"red","fillOpacity":0.2},{"showCoverageOnHover":true,"zoomToBoundsOnClick":true,"spiderfyOnMaxZoom":true,"removeOutsideVisibleBounds":true,"spiderLegPolylineOptions":{"weight":1.5,"color":"#222","opacity":0.5},"freezeAtZoom":false},null,["<b>Destination holding<\/b><br><b>cph:<\/b> 46/908/7292<br><b>holding_type:<\/b> WLRZA<br><b>herd_size:<\/b> 3155","<b>Destination holding<\/b><br><b>cph:<\/b> 59/623/8252<br><b>holding_type:<\/b> BKBDY<br><b>herd_size:<\/b> 4034","<b>Destination holding<\/b><br><b>cph:<\/b> 25/591/6144<br><b>holding_type:<\/b> DNNZD<br><b>herd_size:<\/b> 9142","<b>Destination holding<\/b><br><b>cph:<\/b> 47/319/4630<br><b>holding_type:<\/b> HWVGS<br><b>herd_size:<\/b> 9592"],null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]},{"method":"hideGroup","args":[["Ingoing weight","Ingoing moves","Outgoing weight","Outgoing moves"]]},{"method":"addControl","args":["<div>\n  <strong>Movement weight<\/strong>\n<\/div>\n<div>\n  <img src=\"data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20version%3D%221.1%22%20width%3D%2220%22%20height%3D%222%22%3E%0A%20%20%3Crect%20id%3D%22rect%22%20x%3D%220%22%20y%3D%220%22%20height%3D%222%22%20width%3D%2220%22%20stroke%3D%22transparent%22%20fill%3D%22red%22%20stroke-opacity%3D%221%22%20fill-opacity%3D%221%22%20stroke-width%3D%220%22%3E%3C%2Frect%3E%0A%3C%2Fsvg%3E\" style=\"vertical-align: middle; margin: 5px; margin-right: 0px; margin-left: 0px\" height=\"2\" width=\"20\"/>\n  <span style=\"\">10 - 99<\/span>\n<\/div>\n<div>\n  <img src=\"data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20version%3D%221.1%22%20width%3D%2220%22%20height%3D%224%22%3E%0A%20%20%3Crect%20id%3D%22rect%22%20x%3D%220%22%20y%3D%220%22%20height%3D%224%22%20width%3D%2220%22%20stroke%3D%22transparent%22%20fill%3D%22red%22%20stroke-opacity%3D%221%22%20fill-opacity%3D%221%22%20stroke-width%3D%220%22%3E%3C%2Frect%3E%0A%3C%2Fsvg%3E\" style=\"vertical-align: middle; margin: 5px; margin-right: 0px; margin-left: 0px\" height=\"4\" width=\"20\"/>\n  <span style=\"\">100 - 999<\/span>\n<\/div>","bottomright",null,"info legend leaflet-control"]}],"limits":{"lat":[50.73267301970724,57.91324063052767],"lng":[-6.665831129204032,6.634899107698601]}},"evals":[],"jsHooks":{"render":[{"code":"function(el, x, data) {\n  return (function(el, x, data) {\n    var edge;\n    var movement_geojson_in = data.movement_geojson_in;\n    var movement_geojson_out = data.movement_geojson_out;\n    var dates_in = data.dates_in;\n    var dates_out = data.dates_out;\n    var max_distance = data.max_distance;\n    var map = this;\n\n    /*\n    // Add interactive sidebar -- not using this at the moment\n\n    var sidebar = L.control.sidebar('sidebar', {\n        closeButton: true,\n        position: 'left'\n    });\n    map.addControl(sidebar);\n    */\n\n    // Create a pane with a zIndex of 450 to make sure the holding markers are\n    // drawn on top of the admin area backgrounds\n    map.createPane('holdingsPane');\n    map.getPane('holdingsPane').style.zIndex = 450;\n\n    // Retrieve layer groups defined in R, allowing use in grouped layer control panel\n\n    var groups = {\n      originating_holdings: map.layerManager.getLayerGroup('Originating holdings'),\n      destination_holdings: map.layerManager.getLayerGroup('Destination holdings'),\n      ingoing_edges: new L.layerGroup(),\n      outgoing_edges: new L.layerGroup(),\n    };\n\n    /*\n    Create layers for edges (separately for ingoing and outgoing chains): using\n    straight lines with arrowheads, and varying offsets to create parallel lines\n    when moves are repeated.\n    NB: to refer to a col header in GeoJSON, need to use '.properties.col_header'\n    */\n\n    // First make list of properties I don't want to report on in the map\n    var excludedProperties = ['direction', 'edge_id_on_connection', 'edge_width', 'offset']\n\n    // Create a pane with a zIndex of 450 to make sure the movement arrows are\n    // drawn on top of the admin area backgrounds\n    map.createPane('movementArrows');\n    map.getPane('movementArrows').style.zIndex = 450;\n\n    // Add ingoing and outgoing movements\n    if (movement_geojson_in.features.length > 0) {\n      movement_geojson_in.features.forEach(function(edge){\n        var edge_coords = L.GeoJSON.coordsToLatLngs(edge.geometry.coordinates, 0);\n        var polyline = L.polyline(edge_coords, {\n                color: 'blue',\n                weight: edge.properties.edge_width,\n                opacity: 1,\n                offset: edge.properties.offset,\n                pane: 'movementArrows'\n              }).arrowheads({\n                offset: 0, yawn: 30, fill: true, size: '25px'\n              }).addTo(groups.ingoing_edges)\n\n        // Add popup with text based on all edge properties\n        var text = '';\n        for (var prop in edge.properties) {\n          if (edge.properties.hasOwnProperty(prop) && !excludedProperties.includes(prop)) {\n            text += '<b>'+ prop + ': <\/b>' + edge.properties[prop] + '<br>';\n          }\n        }\n        polyline.bindPopup(text);\n      });\n    };\n    groups.ingoing_edges.addTo(map);\n    if (movement_geojson_out.features.length > 0) {\n      movement_geojson_out.features.forEach(function(edge){\n        var edge_coords = L.GeoJSON.coordsToLatLngs(edge.geometry.coordinates, 0);\n        var polyline = L.polyline(edge_coords, {\n                color: 'red',\n                weight: edge.properties.edge_width,\n                opacity: 1,\n                offset: edge.properties.offset,\n                pane: 'movementArrows'\n              }).arrowheads({\n                offset: 0, yawn: 30, fill: true, size: '25px'\n              }).addTo(groups.outgoing_edges)\n\n        // Add popup with text based on all edge properties\n        var text = '';\n        for (var prop in edge.properties) {\n          if (edge.properties.hasOwnProperty(prop) && !excludedProperties.includes(prop)) {\n            text += '<b>'+ prop + ': <\/b>' + edge.properties[prop] + '<br>';\n          }\n        }\n        polyline.bindPopup(text);\n      });\n      groups.outgoing_edges.addTo(map);\n    };\n\n\n    // Set up grouped layer control\n    var groupedOverlays = {\n      ['Incoming contact chains<br>(' + dates_in + (max_distance !== null ? ',<br>max distance from root: ' + max_distance : '') + ')']: {\n          '<span class=\"fa-stack\" style=\"max-width: 12px; max-height: 12px; vertical-align: top;\"><i class=\"fa-solid fa-circle fa-stack-1x\" style=\"color: blue; opacity: 0.2\"><\/i><i class=\"fa-regular fa-circle fa-stack-1x\" style=\"color: blue; opacity: 0.5\"><\/i><\/span> Originating holdings': groups.originating_holdings ?? [],\n          '<i class=\"fa-solid fa-right-long\" style=\"color: blue\"><\/i> Incoming movements': groups.ingoing_edges ?? []},\n      ['Outgoing contact chains<br>(' + dates_out + (max_distance !== null ? ',<br>max distance from root: ' + max_distance : '') + ')']: {\n          '<span class=\"fa-stack\" style=\"max-width: 12px; max-height: 12px; vertical-align: top;\"><i class=\"fa-solid fa-circle fa-stack-1x\" style=\"color: red; opacity: 0.2\"><\/i><i class=\"fa-regular fa-circle fa-stack-1x\" style=\"color: red; opacity: 0.5\"><\/i><\/span> Destination holdings': groups.destination_holdings ?? [],\n          '<i class=\"fa-solid fa-right-long\" style=\"color: red\"><\/i> Outgoing movements': groups.outgoing_edges ?? []}\n      };\n\n    // Make the Administrative area groups exclusive (use radio inputs)\n    var options = {\n      exclusiveGroups: ['Administrative areas'],\n      collapsed: false};\n\n    var layerControl = L.control.groupedLayers(null, groupedOverlays, options);\n    layerControl.addTo(map);\n\n    // If admin areas are provided, add these to layer control\n\n    var adminAreas = map.layerManager.getLayerGroup('Administrative areas')\n    if (adminAreas) {\n      layerControl.addOverlay(adminAreas,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-regular fa-square fa-stack-2x\" style=\"color: black\"><\/i><\/span> Area boundaries only', 'Administrative areas');\n      var ingoingMoves = map.layerManager.getLayerGroup('Ingoing moves');\n      layerControl.addOverlay(ingoingMoves,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-solid fa-square fa-stack-2x\" style=\"color: blue; opacity: 0.2\"><\/i><i class=\"fa-solid fa-arrow-right-arrow-left fa-sm fa-stack-1x\" style=\"color: blue;\"><\/i><\/span> Total ingoing moves from area', 'Administrative areas');\n      var ingoingWeight = map.layerManager.getLayerGroup('Ingoing weight');\n      layerControl.addOverlay(ingoingWeight,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-solid fa-square fa-stack-2x\" style=\"color: blue; opacity: 0.2\"><\/i><i class=\"fa-solid fa-weight-hanging fa-sm fa-stack-1x\" style=\"color: blue;\"><\/i><\/span> Total ingoing weight from area', 'Administrative areas');\n      var outgoingMoves = map.layerManager.getLayerGroup('Outgoing moves');\n      layerControl.addOverlay(outgoingMoves,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-solid fa-square fa-stack-2x\" style=\"color: red; opacity: 0.2\"><\/i><i class=\"fa-solid fa-arrow-right-arrow-left fa-sm fa-stack-1x\" style=\"color: red;\"><\/i><\/span> Total outgoing moves to area', 'Administrative areas');\n      var outgoingWeight = map.layerManager.getLayerGroup('Outgoing weight');\n      layerControl.addOverlay(outgoingWeight,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-solid fa-square fa-stack-2x\" style=\"color: red; opacity: 0.2\"><\/i><i class=\"fa-solid fa-weight-hanging fa-sm fa-stack-1x\" style=\"color: red;\"><\/i><\/span> Total outgoing weight to area', 'Administrative areas');\n\n    // Hide legends on first render, then toggle depending on which admin area map is active\n\n      var legendClasses = ['outgoing-moves', 'ingoing-moves', 'outgoing-weight', 'ingoing-weight'];\n      legendClasses.forEach(function(className) {\n        var legend = document.getElementsByClassName('info legend ' + className)[0];\n        if (legend) {\n          legend.style.display = 'none';\n        }\n      })\n\n      map.on('overlayadd',function(e){\n       if (e.layer === adminAreas){\n          var legendClasses = ['info legend outgoing-moves', 'info legend ingoing-moves', 'info legend outgoing-weight', 'info legend ingoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n        } else if (e.layer === ingoingMoves){\n          var legendClasses = ['info legend outgoing-moves', 'info legend outgoing-weight', 'info legend ingoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n          var correctLegend = document.getElementsByClassName('info legend ingoing-moves')[0]\n          correctLegend.style.display='block';\n        } else if (e.layer === ingoingWeight){\n          // var inWeightLeg = map.layerManager.getLayer('Ingoing_weight_legend');\n          // inWeightLeg.addTo(map);\n          var legendClasses = ['info legend outgoing-moves', 'info legend ingoing-moves', 'info legend outgoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n          var correctLegend = document.getElementsByClassName('info legend ingoing-weight')[0]\n          correctLegend.style.display='block';\n        } else if (e.layer === outgoingMoves){\n          // var outMovesLeg = map.layerManager.getLayer('Outgoing_moves_legend');\n          // outMovesLeg.addTo(map);\n          var legendClasses = ['info legend ingoing-moves', 'info legend outgoing-weight', 'info legend ingoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n          var correctLegend = document.getElementsByClassName('info legend outgoing-moves')[0]\n          correctLegend.style.display='block';\n        } else if (e.layer === outgoingWeight){\n          // var outWeightLeg = map.layerManager.getLayer('Outgoing_weight_legend');\n          // outWeightLeg.addTo(map);\n          var legendClasses = ['info legend outgoing-moves', 'info legend ingoing-moves', 'info legend ingoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n          var correctLegend = document.getElementsByClassName('info legend outgoing-weight')[0]\n          correctLegend.style.display='block';\n        }\n\n      });\n    }\n    }\n\n).call(this.getMap(), el, x, data);\n}","data":{"movement_geojson_in":{"type":"FeatureCollection","features":[{"type":"Feature","properties":{"departure_cph":"47/479/9810","dest_cph":"68/763/2008","departure_date":"2019-04-11","qty_pigs":132.0,"movement_reference":313751.0,"direction":"in","edge_id_on_connection":1,"edge_width":4.0,"offset":-2.5},"geometry":{"type":"LineString","coordinates":[[-4.813809943331969,52.723307316894537],[2.6192647930852828,52.1935818898291]]}},{"type":"Feature","properties":{"departure_cph":"50/651/8553","dest_cph":"95/216/1100","departure_date":"2019-04-21","qty_pigs":57.0,"movement_reference":159675.0,"direction":"in","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[-5.49156489052311,53.505830639546768],[2.973010058360246,54.87183548191156]]}},{"type":"Feature","properties":{"departure_cph":"68/763/2008","dest_cph":"95/216/1100","departure_date":"2019-04-21","qty_pigs":36.0,"movement_reference":273049.0,"direction":"in","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[2.6192647930852828,52.1935818898291],[2.973010058360246,54.87183548191156]]}},{"type":"Feature","properties":{"departure_cph":"75/345/2020","dest_cph":"68/763/2008","departure_date":"2019-04-16","qty_pigs":177.0,"movement_reference":397128.0,"direction":"in","edge_id_on_connection":1,"edge_width":4.0,"offset":-2.5},"geometry":{"type":"LineString","coordinates":[[-2.239221192053663,55.5962326322733],[2.6192647930852828,52.1935818898291]]}},{"type":"Feature","properties":{"departure_cph":"75/929/3476","dest_cph":"50/651/8553","departure_date":"2019-04-17","qty_pigs":53.0,"movement_reference":558949.0,"direction":"in","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[1.5316697193434215,57.691987453391],[-5.49156489052311,53.505830639546768]]}}]},"movement_geojson_out":{"type":"FeatureCollection","features":[{"type":"Feature","properties":{"departure_cph":"47/319/4630","dest_cph":"25/591/6144","departure_date":"2019-06-20","qty_pigs":69.0,"movement_reference":458178.0,"direction":"out","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[-6.665831129204032,57.913240630527678],[-4.239834059728081,50.732673019707238]]}},{"type":"Feature","properties":{"departure_cph":"47/319/4630","dest_cph":"46/908/7292","departure_date":"2019-06-18","qty_pigs":183.0,"movement_reference":66096.0,"direction":"out","edge_id_on_connection":1,"edge_width":4.0,"offset":-2.5},"geometry":{"type":"LineString","coordinates":[[-6.665831129204032,57.913240630527678],[4.812667616172421,52.32748769739458]]}},{"type":"Feature","properties":{"departure_cph":"95/216/1100","dest_cph":"47/319/4630","departure_date":"2019-06-05","qty_pigs":92.0,"movement_reference":674885.0,"direction":"out","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[2.973010058360246,54.87183548191156],[-6.665831129204032,57.913240630527678]]}},{"type":"Feature","properties":{"departure_cph":"95/216/1100","dest_cph":"59/623/8252","departure_date":"2019-06-15","qty_pigs":171.0,"movement_reference":945545.0,"direction":"out","edge_id_on_connection":1,"edge_width":4.0,"offset":-2.5},"geometry":{"type":"LineString","coordinates":[[2.973010058360246,54.87183548191156],[6.634899107698601,52.973524494895489]]}}]},"dates_in":"2019-04-02 to 2019-07-01","dates_out":"2019-04-02 to 2019-07-01","max_distance":2}}]}}</script>

# trace_contact_chains() works when a single root is given, with tEnd, and only outgoing contact chains exist

    <div id="htmlwidget-" style="width:100%;height:400px;" class="leaflet html-widget"></div>
    <script type="application/json" data-for="htmlwidget-">{"x":{"options":{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}}},"calls":[{"method":"addTiles","args":["https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",null,null,{"minZoom":0,"maxZoom":18,"tileSize":256,"subdomains":"abc","errorTileUrl":"","tms":false,"noWrap":false,"zoomOffset":0,"zoomReverse":false,"opacity":1,"zIndex":1,"detectRetina":false,"attribution":"&copy; <a href=\"https://openstreetmap.org/copyright/\">OpenStreetMap<\/a>,  <a href=\"https://opendatacommons.org/licenses/odbl/\">ODbL<\/a>"}]},{"method":"addCircleMarkers","args":[54.87183548191156,2.973010058360246,10,null,"Root holding(s)",{"interactive":true,"className":"","pane":"holdingsPane","stroke":true,"color":"black","weight":5,"opacity":0.5,"fill":true,"fillColor":"black","fillOpacity":0.2},{"showCoverageOnHover":true,"zoomToBoundsOnClick":true,"spiderfyOnMaxZoom":true,"removeOutsideVisibleBounds":true,"spiderLegPolylineOptions":{"weight":1.5,"color":"#222","opacity":0.5},"freezeAtZoom":false},null,"<b>Root holding<\/b><br><b>cph:<\/b> 95/216/1100<br><b>holding_type:<\/b> NBUZZ<br><b>herd_size:<\/b> 9294",null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]},{"method":"addCircleMarkers","args":[[],[],10,null,"Originating holdings",{"interactive":true,"className":"","pane":"holdingsPane","stroke":true,"color":"blue","weight":5,"opacity":0.5,"fill":true,"fillColor":"blue","fillOpacity":0.2},{"showCoverageOnHover":true,"zoomToBoundsOnClick":true,"spiderfyOnMaxZoom":true,"removeOutsideVisibleBounds":true,"spiderLegPolylineOptions":{"weight":1.5,"color":"#222","opacity":0.5},"freezeAtZoom":false},null,[],null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]},{"method":"addCircleMarkers","args":[[52.32748769739458,57.59973763607515,52.97352449489549,50.73267301970724,57.91324063052767],[4.812667616172421,-3.953480697781026,6.634899107698601,-4.239834059728081,-6.665831129204032],10,null,"Destination holdings",{"interactive":true,"className":"","pane":"holdingsPane","stroke":true,"color":"red","weight":5,"opacity":0.5,"fill":true,"fillColor":"red","fillOpacity":0.2},{"showCoverageOnHover":true,"zoomToBoundsOnClick":true,"spiderfyOnMaxZoom":true,"removeOutsideVisibleBounds":true,"spiderLegPolylineOptions":{"weight":1.5,"color":"#222","opacity":0.5},"freezeAtZoom":false},null,["<b>Destination holding<\/b><br><b>cph:<\/b> 46/908/7292<br><b>holding_type:<\/b> WLRZA<br><b>herd_size:<\/b> 3155","<b>Destination holding<\/b><br><b>cph:<\/b> 77/112/3288<br><b>holding_type:<\/b> JPOXU<br><b>herd_size:<\/b> 3652","<b>Destination holding<\/b><br><b>cph:<\/b> 59/623/8252<br><b>holding_type:<\/b> BKBDY<br><b>herd_size:<\/b> 4034","<b>Destination holding<\/b><br><b>cph:<\/b> 25/591/6144<br><b>holding_type:<\/b> DNNZD<br><b>herd_size:<\/b> 9142","<b>Destination holding<\/b><br><b>cph:<\/b> 47/319/4630<br><b>holding_type:<\/b> HWVGS<br><b>herd_size:<\/b> 9592"],null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]},{"method":"hideGroup","args":[["Ingoing weight","Ingoing moves","Outgoing weight","Outgoing moves"]]},{"method":"addControl","args":["<div>\n  <strong>Movement weight<\/strong>\n<\/div>\n<div>\n  <img src=\"data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20version%3D%221.1%22%20width%3D%2220%22%20height%3D%222%22%3E%0A%20%20%3Crect%20id%3D%22rect%22%20x%3D%220%22%20y%3D%220%22%20height%3D%222%22%20width%3D%2220%22%20stroke%3D%22transparent%22%20fill%3D%22red%22%20stroke-opacity%3D%221%22%20fill-opacity%3D%221%22%20stroke-width%3D%220%22%3E%3C%2Frect%3E%0A%3C%2Fsvg%3E\" style=\"vertical-align: middle; margin: 5px; margin-right: 0px; margin-left: 0px\" height=\"2\" width=\"20\"/>\n  <span style=\"\">10 - 99<\/span>\n<\/div>\n<div>\n  <img src=\"data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20version%3D%221.1%22%20width%3D%2220%22%20height%3D%224%22%3E%0A%20%20%3Crect%20id%3D%22rect%22%20x%3D%220%22%20y%3D%220%22%20height%3D%224%22%20width%3D%2220%22%20stroke%3D%22transparent%22%20fill%3D%22red%22%20stroke-opacity%3D%221%22%20fill-opacity%3D%221%22%20stroke-width%3D%220%22%3E%3C%2Frect%3E%0A%3C%2Fsvg%3E\" style=\"vertical-align: middle; margin: 5px; margin-right: 0px; margin-left: 0px\" height=\"4\" width=\"20\"/>\n  <span style=\"\">100 - 999<\/span>\n<\/div>","bottomright",null,"info legend leaflet-control"]}],"limits":{"lat":[50.73267301970724,57.91324063052767],"lng":[-6.665831129204032,6.634899107698601]}},"evals":[],"jsHooks":{"render":[{"code":"function(el, x, data) {\n  return (function(el, x, data) {\n    var edge;\n    var movement_geojson_in = data.movement_geojson_in;\n    var movement_geojson_out = data.movement_geojson_out;\n    var dates_in = data.dates_in;\n    var dates_out = data.dates_out;\n    var max_distance = data.max_distance;\n    var map = this;\n\n    /*\n    // Add interactive sidebar -- not using this at the moment\n\n    var sidebar = L.control.sidebar('sidebar', {\n        closeButton: true,\n        position: 'left'\n    });\n    map.addControl(sidebar);\n    */\n\n    // Create a pane with a zIndex of 450 to make sure the holding markers are\n    // drawn on top of the admin area backgrounds\n    map.createPane('holdingsPane');\n    map.getPane('holdingsPane').style.zIndex = 450;\n\n    // Retrieve layer groups defined in R, allowing use in grouped layer control panel\n\n    var groups = {\n      originating_holdings: map.layerManager.getLayerGroup('Originating holdings'),\n      destination_holdings: map.layerManager.getLayerGroup('Destination holdings'),\n      ingoing_edges: new L.layerGroup(),\n      outgoing_edges: new L.layerGroup(),\n    };\n\n    /*\n    Create layers for edges (separately for ingoing and outgoing chains): using\n    straight lines with arrowheads, and varying offsets to create parallel lines\n    when moves are repeated.\n    NB: to refer to a col header in GeoJSON, need to use '.properties.col_header'\n    */\n\n    // First make list of properties I don't want to report on in the map\n    var excludedProperties = ['direction', 'edge_id_on_connection', 'edge_width', 'offset']\n\n    // Create a pane with a zIndex of 450 to make sure the movement arrows are\n    // drawn on top of the admin area backgrounds\n    map.createPane('movementArrows');\n    map.getPane('movementArrows').style.zIndex = 450;\n\n    // Add ingoing and outgoing movements\n    if (movement_geojson_in.features.length > 0) {\n      movement_geojson_in.features.forEach(function(edge){\n        var edge_coords = L.GeoJSON.coordsToLatLngs(edge.geometry.coordinates, 0);\n        var polyline = L.polyline(edge_coords, {\n                color: 'blue',\n                weight: edge.properties.edge_width,\n                opacity: 1,\n                offset: edge.properties.offset,\n                pane: 'movementArrows'\n              }).arrowheads({\n                offset: 0, yawn: 30, fill: true, size: '25px'\n              }).addTo(groups.ingoing_edges)\n\n        // Add popup with text based on all edge properties\n        var text = '';\n        for (var prop in edge.properties) {\n          if (edge.properties.hasOwnProperty(prop) && !excludedProperties.includes(prop)) {\n            text += '<b>'+ prop + ': <\/b>' + edge.properties[prop] + '<br>';\n          }\n        }\n        polyline.bindPopup(text);\n      });\n    };\n    groups.ingoing_edges.addTo(map);\n    if (movement_geojson_out.features.length > 0) {\n      movement_geojson_out.features.forEach(function(edge){\n        var edge_coords = L.GeoJSON.coordsToLatLngs(edge.geometry.coordinates, 0);\n        var polyline = L.polyline(edge_coords, {\n                color: 'red',\n                weight: edge.properties.edge_width,\n                opacity: 1,\n                offset: edge.properties.offset,\n                pane: 'movementArrows'\n              }).arrowheads({\n                offset: 0, yawn: 30, fill: true, size: '25px'\n              }).addTo(groups.outgoing_edges)\n\n        // Add popup with text based on all edge properties\n        var text = '';\n        for (var prop in edge.properties) {\n          if (edge.properties.hasOwnProperty(prop) && !excludedProperties.includes(prop)) {\n            text += '<b>'+ prop + ': <\/b>' + edge.properties[prop] + '<br>';\n          }\n        }\n        polyline.bindPopup(text);\n      });\n      groups.outgoing_edges.addTo(map);\n    };\n\n\n    // Set up grouped layer control\n    var groupedOverlays = {\n      ['Incoming contact chains<br>(' + dates_in + (max_distance !== null ? ',<br>max distance from root: ' + max_distance : '') + ')']: {\n          '<span class=\"fa-stack\" style=\"max-width: 12px; max-height: 12px; vertical-align: top;\"><i class=\"fa-solid fa-circle fa-stack-1x\" style=\"color: blue; opacity: 0.2\"><\/i><i class=\"fa-regular fa-circle fa-stack-1x\" style=\"color: blue; opacity: 0.5\"><\/i><\/span> Originating holdings': groups.originating_holdings ?? [],\n          '<i class=\"fa-solid fa-right-long\" style=\"color: blue\"><\/i> Incoming movements': groups.ingoing_edges ?? []},\n      ['Outgoing contact chains<br>(' + dates_out + (max_distance !== null ? ',<br>max distance from root: ' + max_distance : '') + ')']: {\n          '<span class=\"fa-stack\" style=\"max-width: 12px; max-height: 12px; vertical-align: top;\"><i class=\"fa-solid fa-circle fa-stack-1x\" style=\"color: red; opacity: 0.2\"><\/i><i class=\"fa-regular fa-circle fa-stack-1x\" style=\"color: red; opacity: 0.5\"><\/i><\/span> Destination holdings': groups.destination_holdings ?? [],\n          '<i class=\"fa-solid fa-right-long\" style=\"color: red\"><\/i> Outgoing movements': groups.outgoing_edges ?? []}\n      };\n\n    // Make the Administrative area groups exclusive (use radio inputs)\n    var options = {\n      exclusiveGroups: ['Administrative areas'],\n      collapsed: false};\n\n    var layerControl = L.control.groupedLayers(null, groupedOverlays, options);\n    layerControl.addTo(map);\n\n    // If admin areas are provided, add these to layer control\n\n    var adminAreas = map.layerManager.getLayerGroup('Administrative areas')\n    if (adminAreas) {\n      layerControl.addOverlay(adminAreas,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-regular fa-square fa-stack-2x\" style=\"color: black\"><\/i><\/span> Area boundaries only', 'Administrative areas');\n      var ingoingMoves = map.layerManager.getLayerGroup('Ingoing moves');\n      layerControl.addOverlay(ingoingMoves,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-solid fa-square fa-stack-2x\" style=\"color: blue; opacity: 0.2\"><\/i><i class=\"fa-solid fa-arrow-right-arrow-left fa-sm fa-stack-1x\" style=\"color: blue;\"><\/i><\/span> Total ingoing moves from area', 'Administrative areas');\n      var ingoingWeight = map.layerManager.getLayerGroup('Ingoing weight');\n      layerControl.addOverlay(ingoingWeight,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-solid fa-square fa-stack-2x\" style=\"color: blue; opacity: 0.2\"><\/i><i class=\"fa-solid fa-weight-hanging fa-sm fa-stack-1x\" style=\"color: blue;\"><\/i><\/span> Total ingoing weight from area', 'Administrative areas');\n      var outgoingMoves = map.layerManager.getLayerGroup('Outgoing moves');\n      layerControl.addOverlay(outgoingMoves,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-solid fa-square fa-stack-2x\" style=\"color: red; opacity: 0.2\"><\/i><i class=\"fa-solid fa-arrow-right-arrow-left fa-sm fa-stack-1x\" style=\"color: red;\"><\/i><\/span> Total outgoing moves to area', 'Administrative areas');\n      var outgoingWeight = map.layerManager.getLayerGroup('Outgoing weight');\n      layerControl.addOverlay(outgoingWeight,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-solid fa-square fa-stack-2x\" style=\"color: red; opacity: 0.2\"><\/i><i class=\"fa-solid fa-weight-hanging fa-sm fa-stack-1x\" style=\"color: red;\"><\/i><\/span> Total outgoing weight to area', 'Administrative areas');\n\n    // Hide legends on first render, then toggle depending on which admin area map is active\n\n      var legendClasses = ['outgoing-moves', 'ingoing-moves', 'outgoing-weight', 'ingoing-weight'];\n      legendClasses.forEach(function(className) {\n        var legend = document.getElementsByClassName('info legend ' + className)[0];\n        if (legend) {\n          legend.style.display = 'none';\n        }\n      })\n\n      map.on('overlayadd',function(e){\n       if (e.layer === adminAreas){\n          var legendClasses = ['info legend outgoing-moves', 'info legend ingoing-moves', 'info legend outgoing-weight', 'info legend ingoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n        } else if (e.layer === ingoingMoves){\n          var legendClasses = ['info legend outgoing-moves', 'info legend outgoing-weight', 'info legend ingoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n          var correctLegend = document.getElementsByClassName('info legend ingoing-moves')[0]\n          correctLegend.style.display='block';\n        } else if (e.layer === ingoingWeight){\n          // var inWeightLeg = map.layerManager.getLayer('Ingoing_weight_legend');\n          // inWeightLeg.addTo(map);\n          var legendClasses = ['info legend outgoing-moves', 'info legend ingoing-moves', 'info legend outgoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n          var correctLegend = document.getElementsByClassName('info legend ingoing-weight')[0]\n          correctLegend.style.display='block';\n        } else if (e.layer === outgoingMoves){\n          // var outMovesLeg = map.layerManager.getLayer('Outgoing_moves_legend');\n          // outMovesLeg.addTo(map);\n          var legendClasses = ['info legend ingoing-moves', 'info legend outgoing-weight', 'info legend ingoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n          var correctLegend = document.getElementsByClassName('info legend outgoing-moves')[0]\n          correctLegend.style.display='block';\n        } else if (e.layer === outgoingWeight){\n          // var outWeightLeg = map.layerManager.getLayer('Outgoing_weight_legend');\n          // outWeightLeg.addTo(map);\n          var legendClasses = ['info legend outgoing-moves', 'info legend ingoing-moves', 'info legend ingoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n          var correctLegend = document.getElementsByClassName('info legend outgoing-weight')[0]\n          correctLegend.style.display='block';\n        }\n\n      });\n    }\n    }\n\n).call(this.getMap(), el, x, data);\n}","data":{"movement_geojson_in":{"type":"FeatureCollection","features":[]},"movement_geojson_out":{"type":"FeatureCollection","features":[{"type":"Feature","properties":{"departure_cph":"46/908/7292","dest_cph":"77/112/3288","departure_date":"2019-06-18","qty_pigs":52.0,"movement_reference":351321.0,"direction":"out","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[4.812667616172421,52.32748769739458],[-3.9534806977810259,57.599737636075158]]}},{"type":"Feature","properties":{"departure_cph":"47/319/4630","dest_cph":"25/591/6144","departure_date":"2019-06-20","qty_pigs":69.0,"movement_reference":458178.0,"direction":"out","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[-6.665831129204032,57.913240630527678],[-4.239834059728081,50.732673019707238]]}},{"type":"Feature","properties":{"departure_cph":"47/319/4630","dest_cph":"46/908/7292","departure_date":"2019-06-18","qty_pigs":183.0,"movement_reference":66096.0,"direction":"out","edge_id_on_connection":1,"edge_width":4.0,"offset":-2.5},"geometry":{"type":"LineString","coordinates":[[-6.665831129204032,57.913240630527678],[4.812667616172421,52.32748769739458]]}},{"type":"Feature","properties":{"departure_cph":"95/216/1100","dest_cph":"47/319/4630","departure_date":"2019-06-05","qty_pigs":92.0,"movement_reference":674885.0,"direction":"out","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[2.973010058360246,54.87183548191156],[-6.665831129204032,57.913240630527678]]}},{"type":"Feature","properties":{"departure_cph":"95/216/1100","dest_cph":"59/623/8252","departure_date":"2019-06-15","qty_pigs":171.0,"movement_reference":945545.0,"direction":"out","edge_id_on_connection":1,"edge_width":4.0,"offset":-2.5},"geometry":{"type":"LineString","coordinates":[[2.973010058360246,54.87183548191156],[6.634899107698601,52.973524494895489]]}}]},"dates_in":"2019-06-01 to 2019-07-01","dates_out":"2019-06-01 to 2019-07-01","max_distance":null}}]}}</script>

# trace_contact_chains() works when a single root is given, with inBegin etc., and only outgoing contact chains exist

    <div id="htmlwidget-" style="width:100%;height:400px;" class="leaflet html-widget"></div>
    <script type="application/json" data-for="htmlwidget-">{"x":{"options":{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}}},"calls":[{"method":"addTiles","args":["https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",null,null,{"minZoom":0,"maxZoom":18,"tileSize":256,"subdomains":"abc","errorTileUrl":"","tms":false,"noWrap":false,"zoomOffset":0,"zoomReverse":false,"opacity":1,"zIndex":1,"detectRetina":false,"attribution":"&copy; <a href=\"https://openstreetmap.org/copyright/\">OpenStreetMap<\/a>,  <a href=\"https://opendatacommons.org/licenses/odbl/\">ODbL<\/a>"}]},{"method":"addCircleMarkers","args":[54.87183548191156,2.973010058360246,10,null,"Root holding(s)",{"interactive":true,"className":"","pane":"holdingsPane","stroke":true,"color":"black","weight":5,"opacity":0.5,"fill":true,"fillColor":"black","fillOpacity":0.2},{"showCoverageOnHover":true,"zoomToBoundsOnClick":true,"spiderfyOnMaxZoom":true,"removeOutsideVisibleBounds":true,"spiderLegPolylineOptions":{"weight":1.5,"color":"#222","opacity":0.5},"freezeAtZoom":false},null,"<b>Root holding<\/b><br><b>cph:<\/b> 95/216/1100<br><b>holding_type:<\/b> NBUZZ<br><b>herd_size:<\/b> 9294",null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]},{"method":"addCircleMarkers","args":[[],[],10,null,"Originating holdings",{"interactive":true,"className":"","pane":"holdingsPane","stroke":true,"color":"blue","weight":5,"opacity":0.5,"fill":true,"fillColor":"blue","fillOpacity":0.2},{"showCoverageOnHover":true,"zoomToBoundsOnClick":true,"spiderfyOnMaxZoom":true,"removeOutsideVisibleBounds":true,"spiderLegPolylineOptions":{"weight":1.5,"color":"#222","opacity":0.5},"freezeAtZoom":false},null,[],null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]},{"method":"addCircleMarkers","args":[[52.32748769739458,57.59973763607515,52.97352449489549,50.73267301970724,57.91324063052767],[4.812667616172421,-3.953480697781026,6.634899107698601,-4.239834059728081,-6.665831129204032],10,null,"Destination holdings",{"interactive":true,"className":"","pane":"holdingsPane","stroke":true,"color":"red","weight":5,"opacity":0.5,"fill":true,"fillColor":"red","fillOpacity":0.2},{"showCoverageOnHover":true,"zoomToBoundsOnClick":true,"spiderfyOnMaxZoom":true,"removeOutsideVisibleBounds":true,"spiderLegPolylineOptions":{"weight":1.5,"color":"#222","opacity":0.5},"freezeAtZoom":false},null,["<b>Destination holding<\/b><br><b>cph:<\/b> 46/908/7292<br><b>holding_type:<\/b> WLRZA<br><b>herd_size:<\/b> 3155","<b>Destination holding<\/b><br><b>cph:<\/b> 77/112/3288<br><b>holding_type:<\/b> JPOXU<br><b>herd_size:<\/b> 3652","<b>Destination holding<\/b><br><b>cph:<\/b> 59/623/8252<br><b>holding_type:<\/b> BKBDY<br><b>herd_size:<\/b> 4034","<b>Destination holding<\/b><br><b>cph:<\/b> 25/591/6144<br><b>holding_type:<\/b> DNNZD<br><b>herd_size:<\/b> 9142","<b>Destination holding<\/b><br><b>cph:<\/b> 47/319/4630<br><b>holding_type:<\/b> HWVGS<br><b>herd_size:<\/b> 9592"],null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]},{"method":"hideGroup","args":[["Ingoing weight","Ingoing moves","Outgoing weight","Outgoing moves"]]},{"method":"addControl","args":["<div>\n  <strong>Movement weight<\/strong>\n<\/div>\n<div>\n  <img src=\"data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20version%3D%221.1%22%20width%3D%2220%22%20height%3D%222%22%3E%0A%20%20%3Crect%20id%3D%22rect%22%20x%3D%220%22%20y%3D%220%22%20height%3D%222%22%20width%3D%2220%22%20stroke%3D%22transparent%22%20fill%3D%22red%22%20stroke-opacity%3D%221%22%20fill-opacity%3D%221%22%20stroke-width%3D%220%22%3E%3C%2Frect%3E%0A%3C%2Fsvg%3E\" style=\"vertical-align: middle; margin: 5px; margin-right: 0px; margin-left: 0px\" height=\"2\" width=\"20\"/>\n  <span style=\"\">10 - 99<\/span>\n<\/div>\n<div>\n  <img src=\"data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20version%3D%221.1%22%20width%3D%2220%22%20height%3D%224%22%3E%0A%20%20%3Crect%20id%3D%22rect%22%20x%3D%220%22%20y%3D%220%22%20height%3D%224%22%20width%3D%2220%22%20stroke%3D%22transparent%22%20fill%3D%22red%22%20stroke-opacity%3D%221%22%20fill-opacity%3D%221%22%20stroke-width%3D%220%22%3E%3C%2Frect%3E%0A%3C%2Fsvg%3E\" style=\"vertical-align: middle; margin: 5px; margin-right: 0px; margin-left: 0px\" height=\"4\" width=\"20\"/>\n  <span style=\"\">100 - 999<\/span>\n<\/div>","bottomright",null,"info legend leaflet-control"]}],"limits":{"lat":[50.73267301970724,57.91324063052767],"lng":[-6.665831129204032,6.634899107698601]}},"evals":[],"jsHooks":{"render":[{"code":"function(el, x, data) {\n  return (function(el, x, data) {\n    var edge;\n    var movement_geojson_in = data.movement_geojson_in;\n    var movement_geojson_out = data.movement_geojson_out;\n    var dates_in = data.dates_in;\n    var dates_out = data.dates_out;\n    var max_distance = data.max_distance;\n    var map = this;\n\n    /*\n    // Add interactive sidebar -- not using this at the moment\n\n    var sidebar = L.control.sidebar('sidebar', {\n        closeButton: true,\n        position: 'left'\n    });\n    map.addControl(sidebar);\n    */\n\n    // Create a pane with a zIndex of 450 to make sure the holding markers are\n    // drawn on top of the admin area backgrounds\n    map.createPane('holdingsPane');\n    map.getPane('holdingsPane').style.zIndex = 450;\n\n    // Retrieve layer groups defined in R, allowing use in grouped layer control panel\n\n    var groups = {\n      originating_holdings: map.layerManager.getLayerGroup('Originating holdings'),\n      destination_holdings: map.layerManager.getLayerGroup('Destination holdings'),\n      ingoing_edges: new L.layerGroup(),\n      outgoing_edges: new L.layerGroup(),\n    };\n\n    /*\n    Create layers for edges (separately for ingoing and outgoing chains): using\n    straight lines with arrowheads, and varying offsets to create parallel lines\n    when moves are repeated.\n    NB: to refer to a col header in GeoJSON, need to use '.properties.col_header'\n    */\n\n    // First make list of properties I don't want to report on in the map\n    var excludedProperties = ['direction', 'edge_id_on_connection', 'edge_width', 'offset']\n\n    // Create a pane with a zIndex of 450 to make sure the movement arrows are\n    // drawn on top of the admin area backgrounds\n    map.createPane('movementArrows');\n    map.getPane('movementArrows').style.zIndex = 450;\n\n    // Add ingoing and outgoing movements\n    if (movement_geojson_in.features.length > 0) {\n      movement_geojson_in.features.forEach(function(edge){\n        var edge_coords = L.GeoJSON.coordsToLatLngs(edge.geometry.coordinates, 0);\n        var polyline = L.polyline(edge_coords, {\n                color: 'blue',\n                weight: edge.properties.edge_width,\n                opacity: 1,\n                offset: edge.properties.offset,\n                pane: 'movementArrows'\n              }).arrowheads({\n                offset: 0, yawn: 30, fill: true, size: '25px'\n              }).addTo(groups.ingoing_edges)\n\n        // Add popup with text based on all edge properties\n        var text = '';\n        for (var prop in edge.properties) {\n          if (edge.properties.hasOwnProperty(prop) && !excludedProperties.includes(prop)) {\n            text += '<b>'+ prop + ': <\/b>' + edge.properties[prop] + '<br>';\n          }\n        }\n        polyline.bindPopup(text);\n      });\n    };\n    groups.ingoing_edges.addTo(map);\n    if (movement_geojson_out.features.length > 0) {\n      movement_geojson_out.features.forEach(function(edge){\n        var edge_coords = L.GeoJSON.coordsToLatLngs(edge.geometry.coordinates, 0);\n        var polyline = L.polyline(edge_coords, {\n                color: 'red',\n                weight: edge.properties.edge_width,\n                opacity: 1,\n                offset: edge.properties.offset,\n                pane: 'movementArrows'\n              }).arrowheads({\n                offset: 0, yawn: 30, fill: true, size: '25px'\n              }).addTo(groups.outgoing_edges)\n\n        // Add popup with text based on all edge properties\n        var text = '';\n        for (var prop in edge.properties) {\n          if (edge.properties.hasOwnProperty(prop) && !excludedProperties.includes(prop)) {\n            text += '<b>'+ prop + ': <\/b>' + edge.properties[prop] + '<br>';\n          }\n        }\n        polyline.bindPopup(text);\n      });\n      groups.outgoing_edges.addTo(map);\n    };\n\n\n    // Set up grouped layer control\n    var groupedOverlays = {\n      ['Incoming contact chains<br>(' + dates_in + (max_distance !== null ? ',<br>max distance from root: ' + max_distance : '') + ')']: {\n          '<span class=\"fa-stack\" style=\"max-width: 12px; max-height: 12px; vertical-align: top;\"><i class=\"fa-solid fa-circle fa-stack-1x\" style=\"color: blue; opacity: 0.2\"><\/i><i class=\"fa-regular fa-circle fa-stack-1x\" style=\"color: blue; opacity: 0.5\"><\/i><\/span> Originating holdings': groups.originating_holdings ?? [],\n          '<i class=\"fa-solid fa-right-long\" style=\"color: blue\"><\/i> Incoming movements': groups.ingoing_edges ?? []},\n      ['Outgoing contact chains<br>(' + dates_out + (max_distance !== null ? ',<br>max distance from root: ' + max_distance : '') + ')']: {\n          '<span class=\"fa-stack\" style=\"max-width: 12px; max-height: 12px; vertical-align: top;\"><i class=\"fa-solid fa-circle fa-stack-1x\" style=\"color: red; opacity: 0.2\"><\/i><i class=\"fa-regular fa-circle fa-stack-1x\" style=\"color: red; opacity: 0.5\"><\/i><\/span> Destination holdings': groups.destination_holdings ?? [],\n          '<i class=\"fa-solid fa-right-long\" style=\"color: red\"><\/i> Outgoing movements': groups.outgoing_edges ?? []}\n      };\n\n    // Make the Administrative area groups exclusive (use radio inputs)\n    var options = {\n      exclusiveGroups: ['Administrative areas'],\n      collapsed: false};\n\n    var layerControl = L.control.groupedLayers(null, groupedOverlays, options);\n    layerControl.addTo(map);\n\n    // If admin areas are provided, add these to layer control\n\n    var adminAreas = map.layerManager.getLayerGroup('Administrative areas')\n    if (adminAreas) {\n      layerControl.addOverlay(adminAreas,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-regular fa-square fa-stack-2x\" style=\"color: black\"><\/i><\/span> Area boundaries only', 'Administrative areas');\n      var ingoingMoves = map.layerManager.getLayerGroup('Ingoing moves');\n      layerControl.addOverlay(ingoingMoves,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-solid fa-square fa-stack-2x\" style=\"color: blue; opacity: 0.2\"><\/i><i class=\"fa-solid fa-arrow-right-arrow-left fa-sm fa-stack-1x\" style=\"color: blue;\"><\/i><\/span> Total ingoing moves from area', 'Administrative areas');\n      var ingoingWeight = map.layerManager.getLayerGroup('Ingoing weight');\n      layerControl.addOverlay(ingoingWeight,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-solid fa-square fa-stack-2x\" style=\"color: blue; opacity: 0.2\"><\/i><i class=\"fa-solid fa-weight-hanging fa-sm fa-stack-1x\" style=\"color: blue;\"><\/i><\/span> Total ingoing weight from area', 'Administrative areas');\n      var outgoingMoves = map.layerManager.getLayerGroup('Outgoing moves');\n      layerControl.addOverlay(outgoingMoves,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-solid fa-square fa-stack-2x\" style=\"color: red; opacity: 0.2\"><\/i><i class=\"fa-solid fa-arrow-right-arrow-left fa-sm fa-stack-1x\" style=\"color: red;\"><\/i><\/span> Total outgoing moves to area', 'Administrative areas');\n      var outgoingWeight = map.layerManager.getLayerGroup('Outgoing weight');\n      layerControl.addOverlay(outgoingWeight,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-solid fa-square fa-stack-2x\" style=\"color: red; opacity: 0.2\"><\/i><i class=\"fa-solid fa-weight-hanging fa-sm fa-stack-1x\" style=\"color: red;\"><\/i><\/span> Total outgoing weight to area', 'Administrative areas');\n\n    // Hide legends on first render, then toggle depending on which admin area map is active\n\n      var legendClasses = ['outgoing-moves', 'ingoing-moves', 'outgoing-weight', 'ingoing-weight'];\n      legendClasses.forEach(function(className) {\n        var legend = document.getElementsByClassName('info legend ' + className)[0];\n        if (legend) {\n          legend.style.display = 'none';\n        }\n      })\n\n      map.on('overlayadd',function(e){\n       if (e.layer === adminAreas){\n          var legendClasses = ['info legend outgoing-moves', 'info legend ingoing-moves', 'info legend outgoing-weight', 'info legend ingoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n        } else if (e.layer === ingoingMoves){\n          var legendClasses = ['info legend outgoing-moves', 'info legend outgoing-weight', 'info legend ingoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n          var correctLegend = document.getElementsByClassName('info legend ingoing-moves')[0]\n          correctLegend.style.display='block';\n        } else if (e.layer === ingoingWeight){\n          // var inWeightLeg = map.layerManager.getLayer('Ingoing_weight_legend');\n          // inWeightLeg.addTo(map);\n          var legendClasses = ['info legend outgoing-moves', 'info legend ingoing-moves', 'info legend outgoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n          var correctLegend = document.getElementsByClassName('info legend ingoing-weight')[0]\n          correctLegend.style.display='block';\n        } else if (e.layer === outgoingMoves){\n          // var outMovesLeg = map.layerManager.getLayer('Outgoing_moves_legend');\n          // outMovesLeg.addTo(map);\n          var legendClasses = ['info legend ingoing-moves', 'info legend outgoing-weight', 'info legend ingoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n          var correctLegend = document.getElementsByClassName('info legend outgoing-moves')[0]\n          correctLegend.style.display='block';\n        } else if (e.layer === outgoingWeight){\n          // var outWeightLeg = map.layerManager.getLayer('Outgoing_weight_legend');\n          // outWeightLeg.addTo(map);\n          var legendClasses = ['info legend outgoing-moves', 'info legend ingoing-moves', 'info legend ingoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n          var correctLegend = document.getElementsByClassName('info legend outgoing-weight')[0]\n          correctLegend.style.display='block';\n        }\n\n      });\n    }\n    }\n\n).call(this.getMap(), el, x, data);\n}","data":{"movement_geojson_in":{"type":"FeatureCollection","features":[]},"movement_geojson_out":{"type":"FeatureCollection","features":[{"type":"Feature","properties":{"departure_cph":"46/908/7292","dest_cph":"77/112/3288","departure_date":"2019-06-18","qty_pigs":52.0,"movement_reference":351321.0,"direction":"out","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[4.812667616172421,52.32748769739458],[-3.9534806977810259,57.599737636075158]]}},{"type":"Feature","properties":{"departure_cph":"47/319/4630","dest_cph":"25/591/6144","departure_date":"2019-06-20","qty_pigs":69.0,"movement_reference":458178.0,"direction":"out","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[-6.665831129204032,57.913240630527678],[-4.239834059728081,50.732673019707238]]}},{"type":"Feature","properties":{"departure_cph":"47/319/4630","dest_cph":"46/908/7292","departure_date":"2019-06-18","qty_pigs":183.0,"movement_reference":66096.0,"direction":"out","edge_id_on_connection":1,"edge_width":4.0,"offset":-2.5},"geometry":{"type":"LineString","coordinates":[[-6.665831129204032,57.913240630527678],[4.812667616172421,52.32748769739458]]}},{"type":"Feature","properties":{"departure_cph":"95/216/1100","dest_cph":"47/319/4630","departure_date":"2019-06-05","qty_pigs":92.0,"movement_reference":674885.0,"direction":"out","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[2.973010058360246,54.87183548191156],[-6.665831129204032,57.913240630527678]]}},{"type":"Feature","properties":{"departure_cph":"95/216/1100","dest_cph":"59/623/8252","departure_date":"2019-06-15","qty_pigs":171.0,"movement_reference":945545.0,"direction":"out","edge_id_on_connection":1,"edge_width":4.0,"offset":-2.5},"geometry":{"type":"LineString","coordinates":[[2.973010058360246,54.87183548191156],[6.634899107698601,52.973524494895489]]}}]},"dates_in":"2019-06-01 to 2019-07-01","dates_out":"2019-06-01 to 2019-07-01","max_distance":null}}]}}</script>

# trace_contact_chains() works when a single root is given, with tEnd, and only ingoing contact chains exist

    <div id="htmlwidget-" style="width:100%;height:400px;" class="leaflet html-widget"></div>
    <script type="application/json" data-for="htmlwidget-">{"x":{"options":{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}}},"calls":[{"method":"addTiles","args":["https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",null,null,{"minZoom":0,"maxZoom":18,"tileSize":256,"subdomains":"abc","errorTileUrl":"","tms":false,"noWrap":false,"zoomOffset":0,"zoomReverse":false,"opacity":1,"zIndex":1,"detectRetina":false,"attribution":"&copy; <a href=\"https://openstreetmap.org/copyright/\">OpenStreetMap<\/a>,  <a href=\"https://opendatacommons.org/licenses/odbl/\">ODbL<\/a>"}]},{"method":"addCircleMarkers","args":[54.87183548191156,2.973010058360246,10,null,"Root holding(s)",{"interactive":true,"className":"","pane":"holdingsPane","stroke":true,"color":"black","weight":5,"opacity":0.5,"fill":true,"fillColor":"black","fillOpacity":0.2},{"showCoverageOnHover":true,"zoomToBoundsOnClick":true,"spiderfyOnMaxZoom":true,"removeOutsideVisibleBounds":true,"spiderLegPolylineOptions":{"weight":1.5,"color":"#222","opacity":0.5},"freezeAtZoom":false},null,"<b>Root holding<\/b><br><b>cph:<\/b> 95/216/1100<br><b>holding_type:<\/b> NBUZZ<br><b>herd_size:<\/b> 9294",null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]},{"method":"addCircleMarkers","args":[[55.5962326322733,57.691987453391,52.1935818898291,53.50583063954677],[-2.239221192053663,1.531669719343421,2.619264793085283,-5.49156489052311],10,null,"Originating holdings",{"interactive":true,"className":"","pane":"holdingsPane","stroke":true,"color":"blue","weight":5,"opacity":0.5,"fill":true,"fillColor":"blue","fillOpacity":0.2},{"showCoverageOnHover":true,"zoomToBoundsOnClick":true,"spiderfyOnMaxZoom":true,"removeOutsideVisibleBounds":true,"spiderLegPolylineOptions":{"weight":1.5,"color":"#222","opacity":0.5},"freezeAtZoom":false},null,["<b>Originating holding<\/b><br><b>cph:<\/b> 75/345/2020<br><b>holding_type:<\/b> GCUHF<br><b>herd_size:<\/b> 1676","<b>Originating holding<\/b><br><b>cph:<\/b> 75/929/3476<br><b>holding_type:<\/b> THRXE<br><b>herd_size:<\/b> 5781","<b>Originating holding<\/b><br><b>cph:<\/b> 68/763/2008<br><b>holding_type:<\/b> SVYNH<br><b>herd_size:<\/b> 6577","<b>Originating holding<\/b><br><b>cph:<\/b> 50/651/8553<br><b>holding_type:<\/b> MNRFB<br><b>herd_size:<\/b> 8826"],null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]},{"method":"addCircleMarkers","args":[[],[],10,null,"Destination holdings",{"interactive":true,"className":"","pane":"holdingsPane","stroke":true,"color":"red","weight":5,"opacity":0.5,"fill":true,"fillColor":"red","fillOpacity":0.2},{"showCoverageOnHover":true,"zoomToBoundsOnClick":true,"spiderfyOnMaxZoom":true,"removeOutsideVisibleBounds":true,"spiderLegPolylineOptions":{"weight":1.5,"color":"#222","opacity":0.5},"freezeAtZoom":false},null,[],null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]},{"method":"hideGroup","args":[["Ingoing weight","Ingoing moves","Outgoing weight","Outgoing moves"]]},{"method":"addControl","args":["<div>\n  <strong>Movement weight<\/strong>\n<\/div>\n<div>\n  <img src=\"data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20version%3D%221.1%22%20width%3D%2220%22%20height%3D%222%22%3E%0A%20%20%3Crect%20id%3D%22rect%22%20x%3D%220%22%20y%3D%220%22%20height%3D%222%22%20width%3D%2220%22%20stroke%3D%22transparent%22%20fill%3D%22red%22%20stroke-opacity%3D%221%22%20fill-opacity%3D%221%22%20stroke-width%3D%220%22%3E%3C%2Frect%3E%0A%3C%2Fsvg%3E\" style=\"vertical-align: middle; margin: 5px; margin-right: 0px; margin-left: 0px\" height=\"2\" width=\"20\"/>\n  <span style=\"\">10 - 99<\/span>\n<\/div>\n<div>\n  <img src=\"data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20version%3D%221.1%22%20width%3D%2220%22%20height%3D%224%22%3E%0A%20%20%3Crect%20id%3D%22rect%22%20x%3D%220%22%20y%3D%220%22%20height%3D%224%22%20width%3D%2220%22%20stroke%3D%22transparent%22%20fill%3D%22red%22%20stroke-opacity%3D%221%22%20fill-opacity%3D%221%22%20stroke-width%3D%220%22%3E%3C%2Frect%3E%0A%3C%2Fsvg%3E\" style=\"vertical-align: middle; margin: 5px; margin-right: 0px; margin-left: 0px\" height=\"4\" width=\"20\"/>\n  <span style=\"\">100 - 999<\/span>\n<\/div>","bottomright",null,"info legend leaflet-control"]}],"limits":{"lat":[52.1935818898291,57.691987453391],"lng":[-5.49156489052311,2.973010058360246]}},"evals":[],"jsHooks":{"render":[{"code":"function(el, x, data) {\n  return (function(el, x, data) {\n    var edge;\n    var movement_geojson_in = data.movement_geojson_in;\n    var movement_geojson_out = data.movement_geojson_out;\n    var dates_in = data.dates_in;\n    var dates_out = data.dates_out;\n    var max_distance = data.max_distance;\n    var map = this;\n\n    /*\n    // Add interactive sidebar -- not using this at the moment\n\n    var sidebar = L.control.sidebar('sidebar', {\n        closeButton: true,\n        position: 'left'\n    });\n    map.addControl(sidebar);\n    */\n\n    // Create a pane with a zIndex of 450 to make sure the holding markers are\n    // drawn on top of the admin area backgrounds\n    map.createPane('holdingsPane');\n    map.getPane('holdingsPane').style.zIndex = 450;\n\n    // Retrieve layer groups defined in R, allowing use in grouped layer control panel\n\n    var groups = {\n      originating_holdings: map.layerManager.getLayerGroup('Originating holdings'),\n      destination_holdings: map.layerManager.getLayerGroup('Destination holdings'),\n      ingoing_edges: new L.layerGroup(),\n      outgoing_edges: new L.layerGroup(),\n    };\n\n    /*\n    Create layers for edges (separately for ingoing and outgoing chains): using\n    straight lines with arrowheads, and varying offsets to create parallel lines\n    when moves are repeated.\n    NB: to refer to a col header in GeoJSON, need to use '.properties.col_header'\n    */\n\n    // First make list of properties I don't want to report on in the map\n    var excludedProperties = ['direction', 'edge_id_on_connection', 'edge_width', 'offset']\n\n    // Create a pane with a zIndex of 450 to make sure the movement arrows are\n    // drawn on top of the admin area backgrounds\n    map.createPane('movementArrows');\n    map.getPane('movementArrows').style.zIndex = 450;\n\n    // Add ingoing and outgoing movements\n    if (movement_geojson_in.features.length > 0) {\n      movement_geojson_in.features.forEach(function(edge){\n        var edge_coords = L.GeoJSON.coordsToLatLngs(edge.geometry.coordinates, 0);\n        var polyline = L.polyline(edge_coords, {\n                color: 'blue',\n                weight: edge.properties.edge_width,\n                opacity: 1,\n                offset: edge.properties.offset,\n                pane: 'movementArrows'\n              }).arrowheads({\n                offset: 0, yawn: 30, fill: true, size: '25px'\n              }).addTo(groups.ingoing_edges)\n\n        // Add popup with text based on all edge properties\n        var text = '';\n        for (var prop in edge.properties) {\n          if (edge.properties.hasOwnProperty(prop) && !excludedProperties.includes(prop)) {\n            text += '<b>'+ prop + ': <\/b>' + edge.properties[prop] + '<br>';\n          }\n        }\n        polyline.bindPopup(text);\n      });\n    };\n    groups.ingoing_edges.addTo(map);\n    if (movement_geojson_out.features.length > 0) {\n      movement_geojson_out.features.forEach(function(edge){\n        var edge_coords = L.GeoJSON.coordsToLatLngs(edge.geometry.coordinates, 0);\n        var polyline = L.polyline(edge_coords, {\n                color: 'red',\n                weight: edge.properties.edge_width,\n                opacity: 1,\n                offset: edge.properties.offset,\n                pane: 'movementArrows'\n              }).arrowheads({\n                offset: 0, yawn: 30, fill: true, size: '25px'\n              }).addTo(groups.outgoing_edges)\n\n        // Add popup with text based on all edge properties\n        var text = '';\n        for (var prop in edge.properties) {\n          if (edge.properties.hasOwnProperty(prop) && !excludedProperties.includes(prop)) {\n            text += '<b>'+ prop + ': <\/b>' + edge.properties[prop] + '<br>';\n          }\n        }\n        polyline.bindPopup(text);\n      });\n      groups.outgoing_edges.addTo(map);\n    };\n\n\n    // Set up grouped layer control\n    var groupedOverlays = {\n      ['Incoming contact chains<br>(' + dates_in + (max_distance !== null ? ',<br>max distance from root: ' + max_distance : '') + ')']: {\n          '<span class=\"fa-stack\" style=\"max-width: 12px; max-height: 12px; vertical-align: top;\"><i class=\"fa-solid fa-circle fa-stack-1x\" style=\"color: blue; opacity: 0.2\"><\/i><i class=\"fa-regular fa-circle fa-stack-1x\" style=\"color: blue; opacity: 0.5\"><\/i><\/span> Originating holdings': groups.originating_holdings ?? [],\n          '<i class=\"fa-solid fa-right-long\" style=\"color: blue\"><\/i> Incoming movements': groups.ingoing_edges ?? []},\n      ['Outgoing contact chains<br>(' + dates_out + (max_distance !== null ? ',<br>max distance from root: ' + max_distance : '') + ')']: {\n          '<span class=\"fa-stack\" style=\"max-width: 12px; max-height: 12px; vertical-align: top;\"><i class=\"fa-solid fa-circle fa-stack-1x\" style=\"color: red; opacity: 0.2\"><\/i><i class=\"fa-regular fa-circle fa-stack-1x\" style=\"color: red; opacity: 0.5\"><\/i><\/span> Destination holdings': groups.destination_holdings ?? [],\n          '<i class=\"fa-solid fa-right-long\" style=\"color: red\"><\/i> Outgoing movements': groups.outgoing_edges ?? []}\n      };\n\n    // Make the Administrative area groups exclusive (use radio inputs)\n    var options = {\n      exclusiveGroups: ['Administrative areas'],\n      collapsed: false};\n\n    var layerControl = L.control.groupedLayers(null, groupedOverlays, options);\n    layerControl.addTo(map);\n\n    // If admin areas are provided, add these to layer control\n\n    var adminAreas = map.layerManager.getLayerGroup('Administrative areas')\n    if (adminAreas) {\n      layerControl.addOverlay(adminAreas,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-regular fa-square fa-stack-2x\" style=\"color: black\"><\/i><\/span> Area boundaries only', 'Administrative areas');\n      var ingoingMoves = map.layerManager.getLayerGroup('Ingoing moves');\n      layerControl.addOverlay(ingoingMoves,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-solid fa-square fa-stack-2x\" style=\"color: blue; opacity: 0.2\"><\/i><i class=\"fa-solid fa-arrow-right-arrow-left fa-sm fa-stack-1x\" style=\"color: blue;\"><\/i><\/span> Total ingoing moves from area', 'Administrative areas');\n      var ingoingWeight = map.layerManager.getLayerGroup('Ingoing weight');\n      layerControl.addOverlay(ingoingWeight,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-solid fa-square fa-stack-2x\" style=\"color: blue; opacity: 0.2\"><\/i><i class=\"fa-solid fa-weight-hanging fa-sm fa-stack-1x\" style=\"color: blue;\"><\/i><\/span> Total ingoing weight from area', 'Administrative areas');\n      var outgoingMoves = map.layerManager.getLayerGroup('Outgoing moves');\n      layerControl.addOverlay(outgoingMoves,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-solid fa-square fa-stack-2x\" style=\"color: red; opacity: 0.2\"><\/i><i class=\"fa-solid fa-arrow-right-arrow-left fa-sm fa-stack-1x\" style=\"color: red;\"><\/i><\/span> Total outgoing moves to area', 'Administrative areas');\n      var outgoingWeight = map.layerManager.getLayerGroup('Outgoing weight');\n      layerControl.addOverlay(outgoingWeight,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-solid fa-square fa-stack-2x\" style=\"color: red; opacity: 0.2\"><\/i><i class=\"fa-solid fa-weight-hanging fa-sm fa-stack-1x\" style=\"color: red;\"><\/i><\/span> Total outgoing weight to area', 'Administrative areas');\n\n    // Hide legends on first render, then toggle depending on which admin area map is active\n\n      var legendClasses = ['outgoing-moves', 'ingoing-moves', 'outgoing-weight', 'ingoing-weight'];\n      legendClasses.forEach(function(className) {\n        var legend = document.getElementsByClassName('info legend ' + className)[0];\n        if (legend) {\n          legend.style.display = 'none';\n        }\n      })\n\n      map.on('overlayadd',function(e){\n       if (e.layer === adminAreas){\n          var legendClasses = ['info legend outgoing-moves', 'info legend ingoing-moves', 'info legend outgoing-weight', 'info legend ingoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n        } else if (e.layer === ingoingMoves){\n          var legendClasses = ['info legend outgoing-moves', 'info legend outgoing-weight', 'info legend ingoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n          var correctLegend = document.getElementsByClassName('info legend ingoing-moves')[0]\n          correctLegend.style.display='block';\n        } else if (e.layer === ingoingWeight){\n          // var inWeightLeg = map.layerManager.getLayer('Ingoing_weight_legend');\n          // inWeightLeg.addTo(map);\n          var legendClasses = ['info legend outgoing-moves', 'info legend ingoing-moves', 'info legend outgoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n          var correctLegend = document.getElementsByClassName('info legend ingoing-weight')[0]\n          correctLegend.style.display='block';\n        } else if (e.layer === outgoingMoves){\n          // var outMovesLeg = map.layerManager.getLayer('Outgoing_moves_legend');\n          // outMovesLeg.addTo(map);\n          var legendClasses = ['info legend ingoing-moves', 'info legend outgoing-weight', 'info legend ingoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n          var correctLegend = document.getElementsByClassName('info legend outgoing-moves')[0]\n          correctLegend.style.display='block';\n        } else if (e.layer === outgoingWeight){\n          // var outWeightLeg = map.layerManager.getLayer('Outgoing_weight_legend');\n          // outWeightLeg.addTo(map);\n          var legendClasses = ['info legend outgoing-moves', 'info legend ingoing-moves', 'info legend ingoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n          var correctLegend = document.getElementsByClassName('info legend outgoing-weight')[0]\n          correctLegend.style.display='block';\n        }\n\n      });\n    }\n    }\n\n).call(this.getMap(), el, x, data);\n}","data":{"movement_geojson_in":{"type":"FeatureCollection","features":[{"type":"Feature","properties":{"departure_cph":"50/651/8553","dest_cph":"95/216/1100","departure_date":"2019-04-21","qty_pigs":57.0,"movement_reference":159675.0,"direction":"in","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[-5.49156489052311,53.505830639546768],[2.973010058360246,54.87183548191156]]}},{"type":"Feature","properties":{"departure_cph":"68/763/2008","dest_cph":"95/216/1100","departure_date":"2019-04-21","qty_pigs":36.0,"movement_reference":273049.0,"direction":"in","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[2.6192647930852828,52.1935818898291],[2.973010058360246,54.87183548191156]]}},{"type":"Feature","properties":{"departure_cph":"75/345/2020","dest_cph":"68/763/2008","departure_date":"2019-04-16","qty_pigs":177.0,"movement_reference":397128.0,"direction":"in","edge_id_on_connection":1,"edge_width":4.0,"offset":-2.5},"geometry":{"type":"LineString","coordinates":[[-2.239221192053663,55.5962326322733],[2.6192647930852828,52.1935818898291]]}},{"type":"Feature","properties":{"departure_cph":"75/929/3476","dest_cph":"50/651/8553","departure_date":"2019-04-17","qty_pigs":53.0,"movement_reference":558949.0,"direction":"in","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[1.5316697193434215,57.691987453391],[-5.49156489052311,53.505830639546768]]}}]},"movement_geojson_out":{"type":"FeatureCollection","features":[]},"dates_in":"2019-04-16 to 2019-05-01","dates_out":"2019-04-16 to 2019-05-01","max_distance":null}}]}}</script>

# trace_contact_chains() works when multiple roots are given, and in- and outgoing contact chains exist for both roots

    <div id="htmlwidget-" style="width:100%;height:400px;" class="leaflet html-widget"></div>
    <script type="application/json" data-for="htmlwidget-">{"x":{"options":{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}}},"calls":[{"method":"addTiles","args":["https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",null,null,{"minZoom":0,"maxZoom":18,"tileSize":256,"subdomains":"abc","errorTileUrl":"","tms":false,"noWrap":false,"zoomOffset":0,"zoomReverse":false,"opacity":1,"zIndex":1,"detectRetina":false,"attribution":"&copy; <a href=\"https://openstreetmap.org/copyright/\">OpenStreetMap<\/a>,  <a href=\"https://opendatacommons.org/licenses/odbl/\">ODbL<\/a>"}]},{"method":"addCircleMarkers","args":[[54.98403048690485,54.87183548191156],[1.432469703785022,2.973010058360246],10,null,"Root holding(s)",{"interactive":true,"className":"","pane":"holdingsPane","stroke":true,"color":"black","weight":5,"opacity":0.5,"fill":true,"fillColor":"black","fillOpacity":0.2},{"showCoverageOnHover":true,"zoomToBoundsOnClick":true,"spiderfyOnMaxZoom":true,"removeOutsideVisibleBounds":true,"spiderLegPolylineOptions":{"weight":1.5,"color":"#222","opacity":0.5},"freezeAtZoom":false},null,["<b>Root holding<\/b><br><b>cph:<\/b> 76/613/8076<br><b>holding_type:<\/b> GSOSL<br><b>herd_size:<\/b> 2835","<b>Root holding<\/b><br><b>cph:<\/b> 95/216/1100<br><b>holding_type:<\/b> NBUZZ<br><b>herd_size:<\/b> 9294"],null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]},{"method":"addCircleMarkers","args":[[51.97547123900536,55.5962326322733,54.9484886706319,51.37238242790912,53.03632949264616,52.72330731689453,54.58764878028843,57.691987453391,51.85255634536631,52.1935818898291,58.75449990931138,57.42690260461425,53.50583063954677],[5.709143053220052,-2.239221192053663,-3.346269435742193,6.325527856321187,-0.4189714941543531,-4.813809943331969,-0.2693998861138167,1.531669719343421,-0.529457526950595,2.619264793085283,-2.327806569609407,-8.212145897472171,-5.49156489052311],10,null,"Originating holdings",{"interactive":true,"className":"","pane":"holdingsPane","stroke":true,"color":"blue","weight":5,"opacity":0.5,"fill":true,"fillColor":"blue","fillOpacity":0.2},{"showCoverageOnHover":true,"zoomToBoundsOnClick":true,"spiderfyOnMaxZoom":true,"removeOutsideVisibleBounds":true,"spiderLegPolylineOptions":{"weight":1.5,"color":"#222","opacity":0.5},"freezeAtZoom":false},null,["<b>Originating holding<\/b><br><b>cph:<\/b> 32/532/8560<br><b>holding_type:<\/b> HEJDE<br><b>herd_size:<\/b> 2140","<b>Originating holding<\/b><br><b>cph:<\/b> 75/345/2020<br><b>holding_type:<\/b> GCUHF<br><b>herd_size:<\/b> 1676","<b>Originating holding<\/b><br><b>cph:<\/b> 31/931/4017<br><b>holding_type:<\/b> IDFWB<br><b>herd_size:<\/b> 2087","<b>Originating holding<\/b><br><b>cph:<\/b> 12/927/6771<br><b>holding_type:<\/b> PGXGF<br><b>herd_size:<\/b> 3646","<b>Originating holding<\/b><br><b>cph:<\/b> 97/665/7174<br><b>holding_type:<\/b> CYCZH<br><b>herd_size:<\/b> 3818","<b>Originating holding<\/b><br><b>cph:<\/b> 47/479/9810<br><b>holding_type:<\/b> DFYWQ<br><b>herd_size:<\/b> 4924","<b>Originating holding<\/b><br><b>cph:<\/b> 46/782/4470<br><b>holding_type:<\/b> HLUSY<br><b>herd_size:<\/b> 5057","<b>Originating holding<\/b><br><b>cph:<\/b> 75/929/3476<br><b>holding_type:<\/b> THRXE<br><b>herd_size:<\/b> 5781","<b>Originating holding<\/b><br><b>cph:<\/b> 27/664/8542<br><b>holding_type:<\/b> YNPTP<br><b>herd_size:<\/b> 5900","<b>Originating holding<\/b><br><b>cph:<\/b> 68/763/2008<br><b>holding_type:<\/b> SVYNH<br><b>herd_size:<\/b> 6577","<b>Originating holding<\/b><br><b>cph:<\/b> 62/462/9360<br><b>holding_type:<\/b> PKGKB<br><b>herd_size:<\/b> 7285","<b>Originating holding<\/b><br><b>cph:<\/b> 50/311/4527<br><b>holding_type:<\/b> CKUVU<br><b>herd_size:<\/b> 8365","<b>Originating holding<\/b><br><b>cph:<\/b> 50/651/8553<br><b>holding_type:<\/b> MNRFB<br><b>herd_size:<\/b> 8826"],null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]},{"method":"addCircleMarkers","args":[[49.88183449273195,55.29756363006695,55.27420170081376,55.23333466721238,50.15122282135447,55.15491005301967,50.42483656807834,56.9322631133128,55.90105036636857,52.21659406589045,54.8916289683963],[2.967485532960136,-4.216615327296315,6.813548740858337,5.074005585646177,0.5085638607971534,5.232927820865301,3.227510113265497,2.686919394875848,-1.029894828110878,-7.535725739796091,2.949366387284553],10,null,"Destination holdings",{"interactive":true,"className":"","pane":"holdingsPane","stroke":true,"color":"red","weight":5,"opacity":0.5,"fill":true,"fillColor":"red","fillOpacity":0.2},{"showCoverageOnHover":true,"zoomToBoundsOnClick":true,"spiderfyOnMaxZoom":true,"removeOutsideVisibleBounds":true,"spiderLegPolylineOptions":{"weight":1.5,"color":"#222","opacity":0.5},"freezeAtZoom":false},null,["<b>Destination holding<\/b><br><b>cph:<\/b> 87/903/8284<br><b>holding_type:<\/b> NERMX<br><b>herd_size:<\/b> 2614","<b>Destination holding<\/b><br><b>cph:<\/b> 34/522/7120<br><b>holding_type:<\/b> XBDQK<br><b>herd_size:<\/b> 3999","<b>Destination holding<\/b><br><b>cph:<\/b> 43/601/7059<br><b>holding_type:<\/b> FDDRB<br><b>herd_size:<\/b> 4148","<b>Destination holding<\/b><br><b>cph:<\/b> 19/818/9098<br><b>holding_type:<\/b> WBWUE<br><b>herd_size:<\/b> 5261","<b>Destination holding<\/b><br><b>cph:<\/b> 66/569/6625<br><b>holding_type:<\/b> RLTZH<br><b>herd_size:<\/b> 6125","<b>Destination holding<\/b><br><b>cph:<\/b> 11/996/6937<br><b>holding_type:<\/b> ROEYA<br><b>herd_size:<\/b> 6179","<b>Destination holding<\/b><br><b>cph:<\/b> 11/895/7288<br><b>holding_type:<\/b> MIYUS<br><b>herd_size:<\/b> 7210","<b>Destination holding<\/b><br><b>cph:<\/b> 21/302/1233<br><b>holding_type:<\/b> ZEBUH<br><b>herd_size:<\/b> 7872","<b>Destination holding<\/b><br><b>cph:<\/b> 64/388/9121<br><b>holding_type:<\/b> BKHUY<br><b>herd_size:<\/b> 8258","<b>Destination holding<\/b><br><b>cph:<\/b> 92/619/8429<br><b>holding_type:<\/b> NPMWM<br><b>herd_size:<\/b> 8383","<b>Destination holding<\/b><br><b>cph:<\/b> 70/182/3852<br><b>holding_type:<\/b> NXXCB<br><b>herd_size:<\/b> 9547"],null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]},{"method":"hideGroup","args":[["Ingoing weight","Ingoing moves","Outgoing weight","Outgoing moves"]]},{"method":"addControl","args":["<div>\n  <strong>Movement weight<\/strong>\n<\/div>\n<div>\n  <img src=\"data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20version%3D%221.1%22%20width%3D%2220%22%20height%3D%222%22%3E%0A%20%20%3Crect%20id%3D%22rect%22%20x%3D%220%22%20y%3D%220%22%20height%3D%222%22%20width%3D%2220%22%20stroke%3D%22transparent%22%20fill%3D%22red%22%20stroke-opacity%3D%221%22%20fill-opacity%3D%221%22%20stroke-width%3D%220%22%3E%3C%2Frect%3E%0A%3C%2Fsvg%3E\" style=\"vertical-align: middle; margin: 5px; margin-right: 0px; margin-left: 0px\" height=\"2\" width=\"20\"/>\n  <span style=\"\">10 - 99<\/span>\n<\/div>\n<div>\n  <img src=\"data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20version%3D%221.1%22%20width%3D%2220%22%20height%3D%224%22%3E%0A%20%20%3Crect%20id%3D%22rect%22%20x%3D%220%22%20y%3D%220%22%20height%3D%224%22%20width%3D%2220%22%20stroke%3D%22transparent%22%20fill%3D%22red%22%20stroke-opacity%3D%221%22%20fill-opacity%3D%221%22%20stroke-width%3D%220%22%3E%3C%2Frect%3E%0A%3C%2Fsvg%3E\" style=\"vertical-align: middle; margin: 5px; margin-right: 0px; margin-left: 0px\" height=\"4\" width=\"20\"/>\n  <span style=\"\">100 - 999<\/span>\n<\/div>","bottomright",null,"info legend leaflet-control"]}],"limits":{"lat":[49.88183449273195,58.75449990931138],"lng":[-8.212145897472171,6.813548740858337]}},"evals":[],"jsHooks":{"render":[{"code":"function(el, x, data) {\n  return (function(el, x, data) {\n    var edge;\n    var movement_geojson_in = data.movement_geojson_in;\n    var movement_geojson_out = data.movement_geojson_out;\n    var dates_in = data.dates_in;\n    var dates_out = data.dates_out;\n    var max_distance = data.max_distance;\n    var map = this;\n\n    /*\n    // Add interactive sidebar -- not using this at the moment\n\n    var sidebar = L.control.sidebar('sidebar', {\n        closeButton: true,\n        position: 'left'\n    });\n    map.addControl(sidebar);\n    */\n\n    // Create a pane with a zIndex of 450 to make sure the holding markers are\n    // drawn on top of the admin area backgrounds\n    map.createPane('holdingsPane');\n    map.getPane('holdingsPane').style.zIndex = 450;\n\n    // Retrieve layer groups defined in R, allowing use in grouped layer control panel\n\n    var groups = {\n      originating_holdings: map.layerManager.getLayerGroup('Originating holdings'),\n      destination_holdings: map.layerManager.getLayerGroup('Destination holdings'),\n      ingoing_edges: new L.layerGroup(),\n      outgoing_edges: new L.layerGroup(),\n    };\n\n    /*\n    Create layers for edges (separately for ingoing and outgoing chains): using\n    straight lines with arrowheads, and varying offsets to create parallel lines\n    when moves are repeated.\n    NB: to refer to a col header in GeoJSON, need to use '.properties.col_header'\n    */\n\n    // First make list of properties I don't want to report on in the map\n    var excludedProperties = ['direction', 'edge_id_on_connection', 'edge_width', 'offset']\n\n    // Create a pane with a zIndex of 450 to make sure the movement arrows are\n    // drawn on top of the admin area backgrounds\n    map.createPane('movementArrows');\n    map.getPane('movementArrows').style.zIndex = 450;\n\n    // Add ingoing and outgoing movements\n    if (movement_geojson_in.features.length > 0) {\n      movement_geojson_in.features.forEach(function(edge){\n        var edge_coords = L.GeoJSON.coordsToLatLngs(edge.geometry.coordinates, 0);\n        var polyline = L.polyline(edge_coords, {\n                color: 'blue',\n                weight: edge.properties.edge_width,\n                opacity: 1,\n                offset: edge.properties.offset,\n                pane: 'movementArrows'\n              }).arrowheads({\n                offset: 0, yawn: 30, fill: true, size: '25px'\n              }).addTo(groups.ingoing_edges)\n\n        // Add popup with text based on all edge properties\n        var text = '';\n        for (var prop in edge.properties) {\n          if (edge.properties.hasOwnProperty(prop) && !excludedProperties.includes(prop)) {\n            text += '<b>'+ prop + ': <\/b>' + edge.properties[prop] + '<br>';\n          }\n        }\n        polyline.bindPopup(text);\n      });\n    };\n    groups.ingoing_edges.addTo(map);\n    if (movement_geojson_out.features.length > 0) {\n      movement_geojson_out.features.forEach(function(edge){\n        var edge_coords = L.GeoJSON.coordsToLatLngs(edge.geometry.coordinates, 0);\n        var polyline = L.polyline(edge_coords, {\n                color: 'red',\n                weight: edge.properties.edge_width,\n                opacity: 1,\n                offset: edge.properties.offset,\n                pane: 'movementArrows'\n              }).arrowheads({\n                offset: 0, yawn: 30, fill: true, size: '25px'\n              }).addTo(groups.outgoing_edges)\n\n        // Add popup with text based on all edge properties\n        var text = '';\n        for (var prop in edge.properties) {\n          if (edge.properties.hasOwnProperty(prop) && !excludedProperties.includes(prop)) {\n            text += '<b>'+ prop + ': <\/b>' + edge.properties[prop] + '<br>';\n          }\n        }\n        polyline.bindPopup(text);\n      });\n      groups.outgoing_edges.addTo(map);\n    };\n\n\n    // Set up grouped layer control\n    var groupedOverlays = {\n      ['Incoming contact chains<br>(' + dates_in + (max_distance !== null ? ',<br>max distance from root: ' + max_distance : '') + ')']: {\n          '<span class=\"fa-stack\" style=\"max-width: 12px; max-height: 12px; vertical-align: top;\"><i class=\"fa-solid fa-circle fa-stack-1x\" style=\"color: blue; opacity: 0.2\"><\/i><i class=\"fa-regular fa-circle fa-stack-1x\" style=\"color: blue; opacity: 0.5\"><\/i><\/span> Originating holdings': groups.originating_holdings ?? [],\n          '<i class=\"fa-solid fa-right-long\" style=\"color: blue\"><\/i> Incoming movements': groups.ingoing_edges ?? []},\n      ['Outgoing contact chains<br>(' + dates_out + (max_distance !== null ? ',<br>max distance from root: ' + max_distance : '') + ')']: {\n          '<span class=\"fa-stack\" style=\"max-width: 12px; max-height: 12px; vertical-align: top;\"><i class=\"fa-solid fa-circle fa-stack-1x\" style=\"color: red; opacity: 0.2\"><\/i><i class=\"fa-regular fa-circle fa-stack-1x\" style=\"color: red; opacity: 0.5\"><\/i><\/span> Destination holdings': groups.destination_holdings ?? [],\n          '<i class=\"fa-solid fa-right-long\" style=\"color: red\"><\/i> Outgoing movements': groups.outgoing_edges ?? []}\n      };\n\n    // Make the Administrative area groups exclusive (use radio inputs)\n    var options = {\n      exclusiveGroups: ['Administrative areas'],\n      collapsed: false};\n\n    var layerControl = L.control.groupedLayers(null, groupedOverlays, options);\n    layerControl.addTo(map);\n\n    // If admin areas are provided, add these to layer control\n\n    var adminAreas = map.layerManager.getLayerGroup('Administrative areas')\n    if (adminAreas) {\n      layerControl.addOverlay(adminAreas,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-regular fa-square fa-stack-2x\" style=\"color: black\"><\/i><\/span> Area boundaries only', 'Administrative areas');\n      var ingoingMoves = map.layerManager.getLayerGroup('Ingoing moves');\n      layerControl.addOverlay(ingoingMoves,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-solid fa-square fa-stack-2x\" style=\"color: blue; opacity: 0.2\"><\/i><i class=\"fa-solid fa-arrow-right-arrow-left fa-sm fa-stack-1x\" style=\"color: blue;\"><\/i><\/span> Total ingoing moves from area', 'Administrative areas');\n      var ingoingWeight = map.layerManager.getLayerGroup('Ingoing weight');\n      layerControl.addOverlay(ingoingWeight,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-solid fa-square fa-stack-2x\" style=\"color: blue; opacity: 0.2\"><\/i><i class=\"fa-solid fa-weight-hanging fa-sm fa-stack-1x\" style=\"color: blue;\"><\/i><\/span> Total ingoing weight from area', 'Administrative areas');\n      var outgoingMoves = map.layerManager.getLayerGroup('Outgoing moves');\n      layerControl.addOverlay(outgoingMoves,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-solid fa-square fa-stack-2x\" style=\"color: red; opacity: 0.2\"><\/i><i class=\"fa-solid fa-arrow-right-arrow-left fa-sm fa-stack-1x\" style=\"color: red;\"><\/i><\/span> Total outgoing moves to area', 'Administrative areas');\n      var outgoingWeight = map.layerManager.getLayerGroup('Outgoing weight');\n      layerControl.addOverlay(outgoingWeight,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-solid fa-square fa-stack-2x\" style=\"color: red; opacity: 0.2\"><\/i><i class=\"fa-solid fa-weight-hanging fa-sm fa-stack-1x\" style=\"color: red;\"><\/i><\/span> Total outgoing weight to area', 'Administrative areas');\n\n    // Hide legends on first render, then toggle depending on which admin area map is active\n\n      var legendClasses = ['outgoing-moves', 'ingoing-moves', 'outgoing-weight', 'ingoing-weight'];\n      legendClasses.forEach(function(className) {\n        var legend = document.getElementsByClassName('info legend ' + className)[0];\n        if (legend) {\n          legend.style.display = 'none';\n        }\n      })\n\n      map.on('overlayadd',function(e){\n       if (e.layer === adminAreas){\n          var legendClasses = ['info legend outgoing-moves', 'info legend ingoing-moves', 'info legend outgoing-weight', 'info legend ingoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n        } else if (e.layer === ingoingMoves){\n          var legendClasses = ['info legend outgoing-moves', 'info legend outgoing-weight', 'info legend ingoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n          var correctLegend = document.getElementsByClassName('info legend ingoing-moves')[0]\n          correctLegend.style.display='block';\n        } else if (e.layer === ingoingWeight){\n          // var inWeightLeg = map.layerManager.getLayer('Ingoing_weight_legend');\n          // inWeightLeg.addTo(map);\n          var legendClasses = ['info legend outgoing-moves', 'info legend ingoing-moves', 'info legend outgoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n          var correctLegend = document.getElementsByClassName('info legend ingoing-weight')[0]\n          correctLegend.style.display='block';\n        } else if (e.layer === outgoingMoves){\n          // var outMovesLeg = map.layerManager.getLayer('Outgoing_moves_legend');\n          // outMovesLeg.addTo(map);\n          var legendClasses = ['info legend ingoing-moves', 'info legend outgoing-weight', 'info legend ingoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n          var correctLegend = document.getElementsByClassName('info legend outgoing-moves')[0]\n          correctLegend.style.display='block';\n        } else if (e.layer === outgoingWeight){\n          // var outWeightLeg = map.layerManager.getLayer('Outgoing_weight_legend');\n          // outWeightLeg.addTo(map);\n          var legendClasses = ['info legend outgoing-moves', 'info legend ingoing-moves', 'info legend ingoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n          var correctLegend = document.getElementsByClassName('info legend outgoing-weight')[0]\n          correctLegend.style.display='block';\n        }\n\n      });\n    }\n    }\n\n).call(this.getMap(), el, x, data);\n}","data":{"movement_geojson_in":{"type":"FeatureCollection","features":[{"type":"Feature","properties":{"departure_cph":"12/927/6771","dest_cph":"31/931/4017","departure_date":"2019-03-18","qty_pigs":102.0,"movement_reference":87708.0,"direction":"in","edge_id_on_connection":1,"edge_width":4.0,"offset":-2.5},"geometry":{"type":"LineString","coordinates":[[6.325527856321187,51.372382427909119],[-3.3462694357421935,54.948488670631899]]}},{"type":"Feature","properties":{"departure_cph":"27/664/8542","dest_cph":"75/929/3476","departure_date":"2019-04-03","qty_pigs":69.0,"movement_reference":523348.0,"direction":"in","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[-0.529457526950595,51.85255634536631],[1.5316697193434215,57.691987453391]]}},{"type":"Feature","properties":{"departure_cph":"31/931/4017","dest_cph":"95/216/1100","departure_date":"2019-03-24","qty_pigs":148.0,"movement_reference":410903.0,"direction":"in","edge_id_on_connection":1,"edge_width":4.0,"offset":-2.5},"geometry":{"type":"LineString","coordinates":[[-3.3462694357421935,54.948488670631899],[2.973010058360246,54.87183548191156]]}},{"type":"Feature","properties":{"departure_cph":"32/532/8560","dest_cph":"75/929/3476","departure_date":"2019-04-07","qty_pigs":60.0,"movement_reference":207280.0,"direction":"in","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[5.7091430532200528,51.97547123900536],[1.5316697193434215,57.691987453391]]}},{"type":"Feature","properties":{"departure_cph":"46/782/4470","dest_cph":"75/929/3476","departure_date":"2019-04-10","qty_pigs":105.0,"movement_reference":802270.0,"direction":"in","edge_id_on_connection":1,"edge_width":4.0,"offset":-2.5},"geometry":{"type":"LineString","coordinates":[[-0.26939988611381668,54.587648780288429],[1.5316697193434215,57.691987453391]]}},{"type":"Feature","properties":{"departure_cph":"47/479/9810","dest_cph":"68/763/2008","departure_date":"2019-04-11","qty_pigs":132.0,"movement_reference":313751.0,"direction":"in","edge_id_on_connection":1,"edge_width":4.0,"offset":-2.5},"geometry":{"type":"LineString","coordinates":[[-4.813809943331969,52.723307316894537],[2.6192647930852828,52.1935818898291]]}},{"type":"Feature","properties":{"departure_cph":"50/311/4527","dest_cph":"32/532/8560","departure_date":"2019-03-20","qty_pigs":49.0,"movement_reference":710363.0,"direction":"in","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[-8.21214589747217,57.42690260461425],[5.7091430532200528,51.97547123900536]]}},{"type":"Feature","properties":{"departure_cph":"50/651/8553","dest_cph":"95/216/1100","departure_date":"2019-04-21","qty_pigs":57.0,"movement_reference":159675.0,"direction":"in","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[-5.49156489052311,53.505830639546768],[2.973010058360246,54.87183548191156]]}},{"type":"Feature","properties":{"departure_cph":"62/462/9360","dest_cph":"95/216/1100","departure_date":"2019-03-21","qty_pigs":135.0,"movement_reference":861933.0,"direction":"in","edge_id_on_connection":1,"edge_width":4.0,"offset":-2.5},"geometry":{"type":"LineString","coordinates":[[-2.3278065696094076,58.754499909311387],[2.973010058360246,54.87183548191156]]}},{"type":"Feature","properties":{"departure_cph":"68/763/2008","dest_cph":"95/216/1100","departure_date":"2019-04-21","qty_pigs":36.0,"movement_reference":273049.0,"direction":"in","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[2.6192647930852828,52.1935818898291],[2.973010058360246,54.87183548191156]]}},{"type":"Feature","properties":{"departure_cph":"75/345/2020","dest_cph":"68/763/2008","departure_date":"2019-04-16","qty_pigs":177.0,"movement_reference":397128.0,"direction":"in","edge_id_on_connection":1,"edge_width":4.0,"offset":-2.5},"geometry":{"type":"LineString","coordinates":[[-2.239221192053663,55.5962326322733],[2.6192647930852828,52.1935818898291]]}},{"type":"Feature","properties":{"departure_cph":"75/929/3476","dest_cph":"50/651/8553","departure_date":"2019-04-17","qty_pigs":53.0,"movement_reference":558949.0,"direction":"in","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[1.5316697193434215,57.691987453391],[-5.49156489052311,53.505830639546768]]}},{"type":"Feature","properties":{"departure_cph":"97/665/7174","dest_cph":"46/782/4470","departure_date":"2019-04-03","qty_pigs":175.0,"movement_reference":224638.0,"direction":"in","edge_id_on_connection":1,"edge_width":4.0,"offset":-2.5},"geometry":{"type":"LineString","coordinates":[[-0.4189714941543531,53.03632949264616],[-0.26939988611381668,54.587648780288429]]}}]},"movement_geojson_out":{"type":"FeatureCollection","features":[{"type":"Feature","properties":{"departure_cph":"11/895/7288","dest_cph":"34/522/7120","departure_date":"2019-04-03","qty_pigs":83.0,"movement_reference":768681.0,"direction":"out","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[3.227510113265497,50.42483656807834],[-4.216615327296315,55.297563630066949]]}},{"type":"Feature","properties":{"departure_cph":"11/895/7288","dest_cph":"92/619/8429","departure_date":"2019-04-20","qty_pigs":175.0,"movement_reference":119493.0,"direction":"out","edge_id_on_connection":1,"edge_width":4.0,"offset":-2.5},"geometry":{"type":"LineString","coordinates":[[3.227510113265497,50.42483656807834],[-7.535725739796091,52.21659406589045]]}},{"type":"Feature","properties":{"departure_cph":"11/996/6937","dest_cph":"70/182/3852","departure_date":"2019-04-23","qty_pigs":168.0,"movement_reference":835832.0,"direction":"out","edge_id_on_connection":1,"edge_width":4.0,"offset":-2.5},"geometry":{"type":"LineString","coordinates":[[5.232927820865301,55.15491005301967],[2.949366387284553,54.8916289683963]]}},{"type":"Feature","properties":{"departure_cph":"19/818/9098","dest_cph":"11/996/6937","departure_date":"2019-04-13","qty_pigs":62.0,"movement_reference":938451.0,"direction":"out","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[5.0740055856461769,55.233334667212378],[5.232927820865301,55.15491005301967]]}},{"type":"Feature","properties":{"departure_cph":"19/818/9098","dest_cph":"21/302/1233","departure_date":"2019-04-13","qty_pigs":58.0,"movement_reference":679062.0,"direction":"out","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[5.0740055856461769,55.233334667212378],[2.6869193948758478,56.9322631133128]]}},{"type":"Feature","properties":{"departure_cph":"19/818/9098","dest_cph":"64/388/9121","departure_date":"2019-03-28","qty_pigs":64.0,"movement_reference":995250.0,"direction":"out","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[5.0740055856461769,55.233334667212378],[-1.0298948281108785,55.901050366368568]]}},{"type":"Feature","properties":{"departure_cph":"34/522/7120","dest_cph":"87/903/8284","departure_date":"2019-04-12","qty_pigs":102.0,"movement_reference":951478.0,"direction":"out","edge_id_on_connection":1,"edge_width":4.0,"offset":-2.5},"geometry":{"type":"LineString","coordinates":[[-4.216615327296315,55.297563630066949],[2.967485532960136,49.881834492731957]]}},{"type":"Feature","properties":{"departure_cph":"76/613/8076","dest_cph":"43/601/7059","departure_date":"2019-03-17","qty_pigs":68.0,"movement_reference":539349.0,"direction":"out","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[1.4324697037850225,54.98403048690485],[6.813548740858337,55.274201700813758]]}},{"type":"Feature","properties":{"departure_cph":"87/903/8284","dest_cph":"66/569/6625","departure_date":"2019-05-01","qty_pigs":40.0,"movement_reference":545902.0,"direction":"out","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[2.967485532960136,49.881834492731957],[0.5085638607971534,50.151222821354469]]}},{"type":"Feature","properties":{"departure_cph":"95/216/1100","dest_cph":"11/895/7288","departure_date":"2019-03-18","qty_pigs":176.0,"movement_reference":129296.0,"direction":"out","edge_id_on_connection":1,"edge_width":4.0,"offset":-2.5},"geometry":{"type":"LineString","coordinates":[[2.973010058360246,54.87183548191156],[3.227510113265497,50.42483656807834]]}},{"type":"Feature","properties":{"departure_cph":"95/216/1100","dest_cph":"19/818/9098","departure_date":"2019-03-17","qty_pigs":92.0,"movement_reference":621448.0,"direction":"out","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[2.973010058360246,54.87183548191156],[5.0740055856461769,55.233334667212378]]}}]},"dates_in":"2019-03-12 to 2019-05-01","dates_out":"2019-03-12 to 2019-05-01","max_distance":null}}]}}</script>

# trace_contact_chains() works when multiple roots are given, and contact chains exist for only one root

    <div id="htmlwidget-" style="width:100%;height:400px;" class="leaflet html-widget"></div>
    <script type="application/json" data-for="htmlwidget-">{"x":{"options":{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}}},"calls":[{"method":"addTiles","args":["https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",null,null,{"minZoom":0,"maxZoom":18,"tileSize":256,"subdomains":"abc","errorTileUrl":"","tms":false,"noWrap":false,"zoomOffset":0,"zoomReverse":false,"opacity":1,"zIndex":1,"detectRetina":false,"attribution":"&copy; <a href=\"https://openstreetmap.org/copyright/\">OpenStreetMap<\/a>,  <a href=\"https://opendatacommons.org/licenses/odbl/\">ODbL<\/a>"}]},{"method":"addCircleMarkers","args":[[54.98403048690485,54.87183548191156],[1.432469703785022,2.973010058360246],10,null,"Root holding(s)",{"interactive":true,"className":"","pane":"holdingsPane","stroke":true,"color":"black","weight":5,"opacity":0.5,"fill":true,"fillColor":"black","fillOpacity":0.2},{"showCoverageOnHover":true,"zoomToBoundsOnClick":true,"spiderfyOnMaxZoom":true,"removeOutsideVisibleBounds":true,"spiderLegPolylineOptions":{"weight":1.5,"color":"#222","opacity":0.5},"freezeAtZoom":false},null,["<b>Root holding<\/b><br><b>cph:<\/b> 76/613/8076<br><b>holding_type:<\/b> GSOSL<br><b>herd_size:<\/b> 2835","<b>Root holding<\/b><br><b>cph:<\/b> 95/216/1100<br><b>holding_type:<\/b> NBUZZ<br><b>herd_size:<\/b> 9294"],null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]},{"method":"addCircleMarkers","args":[[55.5962326322733,57.691987453391,52.1935818898291,53.50583063954677],[-2.239221192053663,1.531669719343421,2.619264793085283,-5.49156489052311],10,null,"Originating holdings",{"interactive":true,"className":"","pane":"holdingsPane","stroke":true,"color":"blue","weight":5,"opacity":0.5,"fill":true,"fillColor":"blue","fillOpacity":0.2},{"showCoverageOnHover":true,"zoomToBoundsOnClick":true,"spiderfyOnMaxZoom":true,"removeOutsideVisibleBounds":true,"spiderLegPolylineOptions":{"weight":1.5,"color":"#222","opacity":0.5},"freezeAtZoom":false},null,["<b>Originating holding<\/b><br><b>cph:<\/b> 75/345/2020<br><b>holding_type:<\/b> GCUHF<br><b>herd_size:<\/b> 1676","<b>Originating holding<\/b><br><b>cph:<\/b> 75/929/3476<br><b>holding_type:<\/b> THRXE<br><b>herd_size:<\/b> 5781","<b>Originating holding<\/b><br><b>cph:<\/b> 68/763/2008<br><b>holding_type:<\/b> SVYNH<br><b>herd_size:<\/b> 6577","<b>Originating holding<\/b><br><b>cph:<\/b> 50/651/8553<br><b>holding_type:<\/b> MNRFB<br><b>herd_size:<\/b> 8826"],null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]},{"method":"addCircleMarkers","args":[[],[],10,null,"Destination holdings",{"interactive":true,"className":"","pane":"holdingsPane","stroke":true,"color":"red","weight":5,"opacity":0.5,"fill":true,"fillColor":"red","fillOpacity":0.2},{"showCoverageOnHover":true,"zoomToBoundsOnClick":true,"spiderfyOnMaxZoom":true,"removeOutsideVisibleBounds":true,"spiderLegPolylineOptions":{"weight":1.5,"color":"#222","opacity":0.5},"freezeAtZoom":false},null,[],null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]},{"method":"hideGroup","args":[["Ingoing weight","Ingoing moves","Outgoing weight","Outgoing moves"]]},{"method":"addControl","args":["<div>\n  <strong>Movement weight<\/strong>\n<\/div>\n<div>\n  <img src=\"data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20version%3D%221.1%22%20width%3D%2220%22%20height%3D%222%22%3E%0A%20%20%3Crect%20id%3D%22rect%22%20x%3D%220%22%20y%3D%220%22%20height%3D%222%22%20width%3D%2220%22%20stroke%3D%22transparent%22%20fill%3D%22red%22%20stroke-opacity%3D%221%22%20fill-opacity%3D%221%22%20stroke-width%3D%220%22%3E%3C%2Frect%3E%0A%3C%2Fsvg%3E\" style=\"vertical-align: middle; margin: 5px; margin-right: 0px; margin-left: 0px\" height=\"2\" width=\"20\"/>\n  <span style=\"\">10 - 99<\/span>\n<\/div>\n<div>\n  <img src=\"data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20version%3D%221.1%22%20width%3D%2220%22%20height%3D%224%22%3E%0A%20%20%3Crect%20id%3D%22rect%22%20x%3D%220%22%20y%3D%220%22%20height%3D%224%22%20width%3D%2220%22%20stroke%3D%22transparent%22%20fill%3D%22red%22%20stroke-opacity%3D%221%22%20fill-opacity%3D%221%22%20stroke-width%3D%220%22%3E%3C%2Frect%3E%0A%3C%2Fsvg%3E\" style=\"vertical-align: middle; margin: 5px; margin-right: 0px; margin-left: 0px\" height=\"4\" width=\"20\"/>\n  <span style=\"\">100 - 999<\/span>\n<\/div>","bottomright",null,"info legend leaflet-control"]}],"limits":{"lat":[52.1935818898291,57.691987453391],"lng":[-5.49156489052311,2.973010058360246]}},"evals":[],"jsHooks":{"render":[{"code":"function(el, x, data) {\n  return (function(el, x, data) {\n    var edge;\n    var movement_geojson_in = data.movement_geojson_in;\n    var movement_geojson_out = data.movement_geojson_out;\n    var dates_in = data.dates_in;\n    var dates_out = data.dates_out;\n    var max_distance = data.max_distance;\n    var map = this;\n\n    /*\n    // Add interactive sidebar -- not using this at the moment\n\n    var sidebar = L.control.sidebar('sidebar', {\n        closeButton: true,\n        position: 'left'\n    });\n    map.addControl(sidebar);\n    */\n\n    // Create a pane with a zIndex of 450 to make sure the holding markers are\n    // drawn on top of the admin area backgrounds\n    map.createPane('holdingsPane');\n    map.getPane('holdingsPane').style.zIndex = 450;\n\n    // Retrieve layer groups defined in R, allowing use in grouped layer control panel\n\n    var groups = {\n      originating_holdings: map.layerManager.getLayerGroup('Originating holdings'),\n      destination_holdings: map.layerManager.getLayerGroup('Destination holdings'),\n      ingoing_edges: new L.layerGroup(),\n      outgoing_edges: new L.layerGroup(),\n    };\n\n    /*\n    Create layers for edges (separately for ingoing and outgoing chains): using\n    straight lines with arrowheads, and varying offsets to create parallel lines\n    when moves are repeated.\n    NB: to refer to a col header in GeoJSON, need to use '.properties.col_header'\n    */\n\n    // First make list of properties I don't want to report on in the map\n    var excludedProperties = ['direction', 'edge_id_on_connection', 'edge_width', 'offset']\n\n    // Create a pane with a zIndex of 450 to make sure the movement arrows are\n    // drawn on top of the admin area backgrounds\n    map.createPane('movementArrows');\n    map.getPane('movementArrows').style.zIndex = 450;\n\n    // Add ingoing and outgoing movements\n    if (movement_geojson_in.features.length > 0) {\n      movement_geojson_in.features.forEach(function(edge){\n        var edge_coords = L.GeoJSON.coordsToLatLngs(edge.geometry.coordinates, 0);\n        var polyline = L.polyline(edge_coords, {\n                color: 'blue',\n                weight: edge.properties.edge_width,\n                opacity: 1,\n                offset: edge.properties.offset,\n                pane: 'movementArrows'\n              }).arrowheads({\n                offset: 0, yawn: 30, fill: true, size: '25px'\n              }).addTo(groups.ingoing_edges)\n\n        // Add popup with text based on all edge properties\n        var text = '';\n        for (var prop in edge.properties) {\n          if (edge.properties.hasOwnProperty(prop) && !excludedProperties.includes(prop)) {\n            text += '<b>'+ prop + ': <\/b>' + edge.properties[prop] + '<br>';\n          }\n        }\n        polyline.bindPopup(text);\n      });\n    };\n    groups.ingoing_edges.addTo(map);\n    if (movement_geojson_out.features.length > 0) {\n      movement_geojson_out.features.forEach(function(edge){\n        var edge_coords = L.GeoJSON.coordsToLatLngs(edge.geometry.coordinates, 0);\n        var polyline = L.polyline(edge_coords, {\n                color: 'red',\n                weight: edge.properties.edge_width,\n                opacity: 1,\n                offset: edge.properties.offset,\n                pane: 'movementArrows'\n              }).arrowheads({\n                offset: 0, yawn: 30, fill: true, size: '25px'\n              }).addTo(groups.outgoing_edges)\n\n        // Add popup with text based on all edge properties\n        var text = '';\n        for (var prop in edge.properties) {\n          if (edge.properties.hasOwnProperty(prop) && !excludedProperties.includes(prop)) {\n            text += '<b>'+ prop + ': <\/b>' + edge.properties[prop] + '<br>';\n          }\n        }\n        polyline.bindPopup(text);\n      });\n      groups.outgoing_edges.addTo(map);\n    };\n\n\n    // Set up grouped layer control\n    var groupedOverlays = {\n      ['Incoming contact chains<br>(' + dates_in + (max_distance !== null ? ',<br>max distance from root: ' + max_distance : '') + ')']: {\n          '<span class=\"fa-stack\" style=\"max-width: 12px; max-height: 12px; vertical-align: top;\"><i class=\"fa-solid fa-circle fa-stack-1x\" style=\"color: blue; opacity: 0.2\"><\/i><i class=\"fa-regular fa-circle fa-stack-1x\" style=\"color: blue; opacity: 0.5\"><\/i><\/span> Originating holdings': groups.originating_holdings ?? [],\n          '<i class=\"fa-solid fa-right-long\" style=\"color: blue\"><\/i> Incoming movements': groups.ingoing_edges ?? []},\n      ['Outgoing contact chains<br>(' + dates_out + (max_distance !== null ? ',<br>max distance from root: ' + max_distance : '') + ')']: {\n          '<span class=\"fa-stack\" style=\"max-width: 12px; max-height: 12px; vertical-align: top;\"><i class=\"fa-solid fa-circle fa-stack-1x\" style=\"color: red; opacity: 0.2\"><\/i><i class=\"fa-regular fa-circle fa-stack-1x\" style=\"color: red; opacity: 0.5\"><\/i><\/span> Destination holdings': groups.destination_holdings ?? [],\n          '<i class=\"fa-solid fa-right-long\" style=\"color: red\"><\/i> Outgoing movements': groups.outgoing_edges ?? []}\n      };\n\n    // Make the Administrative area groups exclusive (use radio inputs)\n    var options = {\n      exclusiveGroups: ['Administrative areas'],\n      collapsed: false};\n\n    var layerControl = L.control.groupedLayers(null, groupedOverlays, options);\n    layerControl.addTo(map);\n\n    // If admin areas are provided, add these to layer control\n\n    var adminAreas = map.layerManager.getLayerGroup('Administrative areas')\n    if (adminAreas) {\n      layerControl.addOverlay(adminAreas,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-regular fa-square fa-stack-2x\" style=\"color: black\"><\/i><\/span> Area boundaries only', 'Administrative areas');\n      var ingoingMoves = map.layerManager.getLayerGroup('Ingoing moves');\n      layerControl.addOverlay(ingoingMoves,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-solid fa-square fa-stack-2x\" style=\"color: blue; opacity: 0.2\"><\/i><i class=\"fa-solid fa-arrow-right-arrow-left fa-sm fa-stack-1x\" style=\"color: blue;\"><\/i><\/span> Total ingoing moves from area', 'Administrative areas');\n      var ingoingWeight = map.layerManager.getLayerGroup('Ingoing weight');\n      layerControl.addOverlay(ingoingWeight,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-solid fa-square fa-stack-2x\" style=\"color: blue; opacity: 0.2\"><\/i><i class=\"fa-solid fa-weight-hanging fa-sm fa-stack-1x\" style=\"color: blue;\"><\/i><\/span> Total ingoing weight from area', 'Administrative areas');\n      var outgoingMoves = map.layerManager.getLayerGroup('Outgoing moves');\n      layerControl.addOverlay(outgoingMoves,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-solid fa-square fa-stack-2x\" style=\"color: red; opacity: 0.2\"><\/i><i class=\"fa-solid fa-arrow-right-arrow-left fa-sm fa-stack-1x\" style=\"color: red;\"><\/i><\/span> Total outgoing moves to area', 'Administrative areas');\n      var outgoingWeight = map.layerManager.getLayerGroup('Outgoing weight');\n      layerControl.addOverlay(outgoingWeight,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-solid fa-square fa-stack-2x\" style=\"color: red; opacity: 0.2\"><\/i><i class=\"fa-solid fa-weight-hanging fa-sm fa-stack-1x\" style=\"color: red;\"><\/i><\/span> Total outgoing weight to area', 'Administrative areas');\n\n    // Hide legends on first render, then toggle depending on which admin area map is active\n\n      var legendClasses = ['outgoing-moves', 'ingoing-moves', 'outgoing-weight', 'ingoing-weight'];\n      legendClasses.forEach(function(className) {\n        var legend = document.getElementsByClassName('info legend ' + className)[0];\n        if (legend) {\n          legend.style.display = 'none';\n        }\n      })\n\n      map.on('overlayadd',function(e){\n       if (e.layer === adminAreas){\n          var legendClasses = ['info legend outgoing-moves', 'info legend ingoing-moves', 'info legend outgoing-weight', 'info legend ingoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n        } else if (e.layer === ingoingMoves){\n          var legendClasses = ['info legend outgoing-moves', 'info legend outgoing-weight', 'info legend ingoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n          var correctLegend = document.getElementsByClassName('info legend ingoing-moves')[0]\n          correctLegend.style.display='block';\n        } else if (e.layer === ingoingWeight){\n          // var inWeightLeg = map.layerManager.getLayer('Ingoing_weight_legend');\n          // inWeightLeg.addTo(map);\n          var legendClasses = ['info legend outgoing-moves', 'info legend ingoing-moves', 'info legend outgoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n          var correctLegend = document.getElementsByClassName('info legend ingoing-weight')[0]\n          correctLegend.style.display='block';\n        } else if (e.layer === outgoingMoves){\n          // var outMovesLeg = map.layerManager.getLayer('Outgoing_moves_legend');\n          // outMovesLeg.addTo(map);\n          var legendClasses = ['info legend ingoing-moves', 'info legend outgoing-weight', 'info legend ingoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n          var correctLegend = document.getElementsByClassName('info legend outgoing-moves')[0]\n          correctLegend.style.display='block';\n        } else if (e.layer === outgoingWeight){\n          // var outWeightLeg = map.layerManager.getLayer('Outgoing_weight_legend');\n          // outWeightLeg.addTo(map);\n          var legendClasses = ['info legend outgoing-moves', 'info legend ingoing-moves', 'info legend ingoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n          var correctLegend = document.getElementsByClassName('info legend outgoing-weight')[0]\n          correctLegend.style.display='block';\n        }\n\n      });\n    }\n    }\n\n).call(this.getMap(), el, x, data);\n}","data":{"movement_geojson_in":{"type":"FeatureCollection","features":[{"type":"Feature","properties":{"departure_cph":"50/651/8553","dest_cph":"95/216/1100","departure_date":"2019-04-21","qty_pigs":57.0,"movement_reference":159675.0,"direction":"in","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[-5.49156489052311,53.505830639546768],[2.973010058360246,54.87183548191156]]}},{"type":"Feature","properties":{"departure_cph":"68/763/2008","dest_cph":"95/216/1100","departure_date":"2019-04-21","qty_pigs":36.0,"movement_reference":273049.0,"direction":"in","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[2.6192647930852828,52.1935818898291],[2.973010058360246,54.87183548191156]]}},{"type":"Feature","properties":{"departure_cph":"75/345/2020","dest_cph":"68/763/2008","departure_date":"2019-04-16","qty_pigs":177.0,"movement_reference":397128.0,"direction":"in","edge_id_on_connection":1,"edge_width":4.0,"offset":-2.5},"geometry":{"type":"LineString","coordinates":[[-2.239221192053663,55.5962326322733],[2.6192647930852828,52.1935818898291]]}},{"type":"Feature","properties":{"departure_cph":"75/929/3476","dest_cph":"50/651/8553","departure_date":"2019-04-17","qty_pigs":53.0,"movement_reference":558949.0,"direction":"in","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[1.5316697193434215,57.691987453391],[-5.49156489052311,53.505830639546768]]}}]},"movement_geojson_out":{"type":"FeatureCollection","features":[]},"dates_in":"2019-04-16 to 2019-05-01","dates_out":"2019-04-16 to 2019-05-01","max_distance":null}}]}}</script>

# trace_contact_chains() behaviour for multiple in/out/root statuses within a single contact chain is as expected

    <div id="htmlwidget-" style="width:100%;height:400px;" class="leaflet html-widget"></div>
    <script type="application/json" data-for="htmlwidget-">{"x":{"options":{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}}},"calls":[{"method":"addTiles","args":["https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",null,null,{"minZoom":0,"maxZoom":18,"tileSize":256,"subdomains":"abc","errorTileUrl":"","tms":false,"noWrap":false,"zoomOffset":0,"zoomReverse":false,"opacity":1,"zIndex":1,"detectRetina":false,"attribution":"&copy; <a href=\"https://openstreetmap.org/copyright/\">OpenStreetMap<\/a>,  <a href=\"https://opendatacommons.org/licenses/odbl/\">ODbL<\/a>"}]},{"method":"addCircleMarkers","args":[55.77480400308583,3.509621520312091,10,null,"Root holding(s)",{"interactive":true,"className":"","pane":"holdingsPane","stroke":true,"color":"black","weight":5,"opacity":0.5,"fill":true,"fillColor":"black","fillOpacity":0.2},{"showCoverageOnHover":true,"zoomToBoundsOnClick":true,"spiderfyOnMaxZoom":true,"removeOutsideVisibleBounds":true,"spiderLegPolylineOptions":{"weight":1.5,"color":"#222","opacity":0.5},"freezeAtZoom":false},null,"<b>Root holding<\/b><br><b>cph:<\/b> 39/103/5541<br><b>holding_type:<\/b> JJAWD<br><b>herd_size:<\/b> 3415",null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]},{"method":"addCircleMarkers","args":[[54.86382754054693,56.42366726554555],[-7.011031868789061,-0.940826864323105],10,null,"Originating holdings",{"interactive":true,"className":"","pane":"holdingsPane","stroke":true,"color":"blue","weight":5,"opacity":0.5,"fill":true,"fillColor":"blue","fillOpacity":0.2},{"showCoverageOnHover":true,"zoomToBoundsOnClick":true,"spiderfyOnMaxZoom":true,"removeOutsideVisibleBounds":true,"spiderLegPolylineOptions":{"weight":1.5,"color":"#222","opacity":0.5},"freezeAtZoom":false},null,["<b>Originating holding<\/b><br><b>cph:<\/b> 41/788/6464<br><b>holding_type:<\/b> CNUIF<br><b>herd_size:<\/b> 5816","<b>Originating holding<\/b><br><b>cph:<\/b> 69/196/5890<br><b>holding_type:<\/b> MJQYM<br><b>herd_size:<\/b> 9913"],null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]},{"method":"addCircleMarkers","args":[[54.86382754054693,56.42366726554555],[-7.011031868789061,-0.940826864323105],10,null,"Destination holdings",{"interactive":true,"className":"","pane":"holdingsPane","stroke":true,"color":"red","weight":5,"opacity":0.5,"fill":true,"fillColor":"red","fillOpacity":0.2},{"showCoverageOnHover":true,"zoomToBoundsOnClick":true,"spiderfyOnMaxZoom":true,"removeOutsideVisibleBounds":true,"spiderLegPolylineOptions":{"weight":1.5,"color":"#222","opacity":0.5},"freezeAtZoom":false},null,["<b>Destination holding<\/b><br><b>cph:<\/b> 41/788/6464<br><b>holding_type:<\/b> CNUIF<br><b>herd_size:<\/b> 5816","<b>Destination holding<\/b><br><b>cph:<\/b> 69/196/5890<br><b>holding_type:<\/b> MJQYM<br><b>herd_size:<\/b> 9913"],null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]},{"method":"hideGroup","args":[["Ingoing weight","Ingoing moves","Outgoing weight","Outgoing moves"]]},{"method":"addControl","args":["<div>\n  <strong>Movement weight<\/strong>\n<\/div>\n<div>\n  <img src=\"data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20version%3D%221.1%22%20width%3D%2220%22%20height%3D%221%22%3E%0A%20%20%3Crect%20id%3D%22rect%22%20x%3D%220%22%20y%3D%220%22%20height%3D%221%22%20width%3D%2220%22%20stroke%3D%22transparent%22%20fill%3D%22red%22%20stroke-opacity%3D%221%22%20fill-opacity%3D%221%22%20stroke-width%3D%220%22%3E%3C%2Frect%3E%0A%3C%2Fsvg%3E\" style=\"vertical-align: middle; margin: 5px; margin-right: 0px; margin-left: 0px\" height=\"1\" width=\"20\"/>\n  <span style=\"\">1<\/span>\n<\/div>","bottomright",null,"info legend leaflet-control"]}],"limits":{"lat":[54.86382754054693,56.42366726554555],"lng":[-7.011031868789061,3.509621520312091]}},"evals":[],"jsHooks":{"render":[{"code":"function(el, x, data) {\n  return (function(el, x, data) {\n    var edge;\n    var movement_geojson_in = data.movement_geojson_in;\n    var movement_geojson_out = data.movement_geojson_out;\n    var dates_in = data.dates_in;\n    var dates_out = data.dates_out;\n    var max_distance = data.max_distance;\n    var map = this;\n\n    /*\n    // Add interactive sidebar -- not using this at the moment\n\n    var sidebar = L.control.sidebar('sidebar', {\n        closeButton: true,\n        position: 'left'\n    });\n    map.addControl(sidebar);\n    */\n\n    // Create a pane with a zIndex of 450 to make sure the holding markers are\n    // drawn on top of the admin area backgrounds\n    map.createPane('holdingsPane');\n    map.getPane('holdingsPane').style.zIndex = 450;\n\n    // Retrieve layer groups defined in R, allowing use in grouped layer control panel\n\n    var groups = {\n      originating_holdings: map.layerManager.getLayerGroup('Originating holdings'),\n      destination_holdings: map.layerManager.getLayerGroup('Destination holdings'),\n      ingoing_edges: new L.layerGroup(),\n      outgoing_edges: new L.layerGroup(),\n    };\n\n    /*\n    Create layers for edges (separately for ingoing and outgoing chains): using\n    straight lines with arrowheads, and varying offsets to create parallel lines\n    when moves are repeated.\n    NB: to refer to a col header in GeoJSON, need to use '.properties.col_header'\n    */\n\n    // First make list of properties I don't want to report on in the map\n    var excludedProperties = ['direction', 'edge_id_on_connection', 'edge_width', 'offset']\n\n    // Create a pane with a zIndex of 450 to make sure the movement arrows are\n    // drawn on top of the admin area backgrounds\n    map.createPane('movementArrows');\n    map.getPane('movementArrows').style.zIndex = 450;\n\n    // Add ingoing and outgoing movements\n    if (movement_geojson_in.features.length > 0) {\n      movement_geojson_in.features.forEach(function(edge){\n        var edge_coords = L.GeoJSON.coordsToLatLngs(edge.geometry.coordinates, 0);\n        var polyline = L.polyline(edge_coords, {\n                color: 'blue',\n                weight: edge.properties.edge_width,\n                opacity: 1,\n                offset: edge.properties.offset,\n                pane: 'movementArrows'\n              }).arrowheads({\n                offset: 0, yawn: 30, fill: true, size: '25px'\n              }).addTo(groups.ingoing_edges)\n\n        // Add popup with text based on all edge properties\n        var text = '';\n        for (var prop in edge.properties) {\n          if (edge.properties.hasOwnProperty(prop) && !excludedProperties.includes(prop)) {\n            text += '<b>'+ prop + ': <\/b>' + edge.properties[prop] + '<br>';\n          }\n        }\n        polyline.bindPopup(text);\n      });\n    };\n    groups.ingoing_edges.addTo(map);\n    if (movement_geojson_out.features.length > 0) {\n      movement_geojson_out.features.forEach(function(edge){\n        var edge_coords = L.GeoJSON.coordsToLatLngs(edge.geometry.coordinates, 0);\n        var polyline = L.polyline(edge_coords, {\n                color: 'red',\n                weight: edge.properties.edge_width,\n                opacity: 1,\n                offset: edge.properties.offset,\n                pane: 'movementArrows'\n              }).arrowheads({\n                offset: 0, yawn: 30, fill: true, size: '25px'\n              }).addTo(groups.outgoing_edges)\n\n        // Add popup with text based on all edge properties\n        var text = '';\n        for (var prop in edge.properties) {\n          if (edge.properties.hasOwnProperty(prop) && !excludedProperties.includes(prop)) {\n            text += '<b>'+ prop + ': <\/b>' + edge.properties[prop] + '<br>';\n          }\n        }\n        polyline.bindPopup(text);\n      });\n      groups.outgoing_edges.addTo(map);\n    };\n\n\n    // Set up grouped layer control\n    var groupedOverlays = {\n      ['Incoming contact chains<br>(' + dates_in + (max_distance !== null ? ',<br>max distance from root: ' + max_distance : '') + ')']: {\n          '<span class=\"fa-stack\" style=\"max-width: 12px; max-height: 12px; vertical-align: top;\"><i class=\"fa-solid fa-circle fa-stack-1x\" style=\"color: blue; opacity: 0.2\"><\/i><i class=\"fa-regular fa-circle fa-stack-1x\" style=\"color: blue; opacity: 0.5\"><\/i><\/span> Originating holdings': groups.originating_holdings ?? [],\n          '<i class=\"fa-solid fa-right-long\" style=\"color: blue\"><\/i> Incoming movements': groups.ingoing_edges ?? []},\n      ['Outgoing contact chains<br>(' + dates_out + (max_distance !== null ? ',<br>max distance from root: ' + max_distance : '') + ')']: {\n          '<span class=\"fa-stack\" style=\"max-width: 12px; max-height: 12px; vertical-align: top;\"><i class=\"fa-solid fa-circle fa-stack-1x\" style=\"color: red; opacity: 0.2\"><\/i><i class=\"fa-regular fa-circle fa-stack-1x\" style=\"color: red; opacity: 0.5\"><\/i><\/span> Destination holdings': groups.destination_holdings ?? [],\n          '<i class=\"fa-solid fa-right-long\" style=\"color: red\"><\/i> Outgoing movements': groups.outgoing_edges ?? []}\n      };\n\n    // Make the Administrative area groups exclusive (use radio inputs)\n    var options = {\n      exclusiveGroups: ['Administrative areas'],\n      collapsed: false};\n\n    var layerControl = L.control.groupedLayers(null, groupedOverlays, options);\n    layerControl.addTo(map);\n\n    // If admin areas are provided, add these to layer control\n\n    var adminAreas = map.layerManager.getLayerGroup('Administrative areas')\n    if (adminAreas) {\n      layerControl.addOverlay(adminAreas,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-regular fa-square fa-stack-2x\" style=\"color: black\"><\/i><\/span> Area boundaries only', 'Administrative areas');\n      var ingoingMoves = map.layerManager.getLayerGroup('Ingoing moves');\n      layerControl.addOverlay(ingoingMoves,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-solid fa-square fa-stack-2x\" style=\"color: blue; opacity: 0.2\"><\/i><i class=\"fa-solid fa-arrow-right-arrow-left fa-sm fa-stack-1x\" style=\"color: blue;\"><\/i><\/span> Total ingoing moves from area', 'Administrative areas');\n      var ingoingWeight = map.layerManager.getLayerGroup('Ingoing weight');\n      layerControl.addOverlay(ingoingWeight,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-solid fa-square fa-stack-2x\" style=\"color: blue; opacity: 0.2\"><\/i><i class=\"fa-solid fa-weight-hanging fa-sm fa-stack-1x\" style=\"color: blue;\"><\/i><\/span> Total ingoing weight from area', 'Administrative areas');\n      var outgoingMoves = map.layerManager.getLayerGroup('Outgoing moves');\n      layerControl.addOverlay(outgoingMoves,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-solid fa-square fa-stack-2x\" style=\"color: red; opacity: 0.2\"><\/i><i class=\"fa-solid fa-arrow-right-arrow-left fa-sm fa-stack-1x\" style=\"color: red;\"><\/i><\/span> Total outgoing moves to area', 'Administrative areas');\n      var outgoingWeight = map.layerManager.getLayerGroup('Outgoing weight');\n      layerControl.addOverlay(outgoingWeight,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-solid fa-square fa-stack-2x\" style=\"color: red; opacity: 0.2\"><\/i><i class=\"fa-solid fa-weight-hanging fa-sm fa-stack-1x\" style=\"color: red;\"><\/i><\/span> Total outgoing weight to area', 'Administrative areas');\n\n    // Hide legends on first render, then toggle depending on which admin area map is active\n\n      var legendClasses = ['outgoing-moves', 'ingoing-moves', 'outgoing-weight', 'ingoing-weight'];\n      legendClasses.forEach(function(className) {\n        var legend = document.getElementsByClassName('info legend ' + className)[0];\n        if (legend) {\n          legend.style.display = 'none';\n        }\n      })\n\n      map.on('overlayadd',function(e){\n       if (e.layer === adminAreas){\n          var legendClasses = ['info legend outgoing-moves', 'info legend ingoing-moves', 'info legend outgoing-weight', 'info legend ingoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n        } else if (e.layer === ingoingMoves){\n          var legendClasses = ['info legend outgoing-moves', 'info legend outgoing-weight', 'info legend ingoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n          var correctLegend = document.getElementsByClassName('info legend ingoing-moves')[0]\n          correctLegend.style.display='block';\n        } else if (e.layer === ingoingWeight){\n          // var inWeightLeg = map.layerManager.getLayer('Ingoing_weight_legend');\n          // inWeightLeg.addTo(map);\n          var legendClasses = ['info legend outgoing-moves', 'info legend ingoing-moves', 'info legend outgoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n          var correctLegend = document.getElementsByClassName('info legend ingoing-weight')[0]\n          correctLegend.style.display='block';\n        } else if (e.layer === outgoingMoves){\n          // var outMovesLeg = map.layerManager.getLayer('Outgoing_moves_legend');\n          // outMovesLeg.addTo(map);\n          var legendClasses = ['info legend ingoing-moves', 'info legend outgoing-weight', 'info legend ingoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n          var correctLegend = document.getElementsByClassName('info legend outgoing-moves')[0]\n          correctLegend.style.display='block';\n        } else if (e.layer === outgoingWeight){\n          // var outWeightLeg = map.layerManager.getLayer('Outgoing_weight_legend');\n          // outWeightLeg.addTo(map);\n          var legendClasses = ['info legend outgoing-moves', 'info legend ingoing-moves', 'info legend ingoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n          var correctLegend = document.getElementsByClassName('info legend outgoing-weight')[0]\n          correctLegend.style.display='block';\n        }\n\n      });\n    }\n    }\n\n).call(this.getMap(), el, x, data);\n}","data":{"movement_geojson_in":{"type":"FeatureCollection","features":[{"type":"Feature","properties":{"departure_cph":"41/788/6464","dest_cph":"69/196/5890","departure_date":"2019-01-02","qty_pigs":6.0,"direction":"in","edge_id_on_connection":1,"edge_width":1.0,"offset":-1.0},"geometry":{"type":"LineString","coordinates":[[-7.011031868789061,54.86382754054693],[-0.940826864323105,56.42366726554555]]}},{"type":"Feature","properties":{"departure_cph":"69/196/5890","dest_cph":"39/103/5541","departure_date":"2019-01-03","qty_pigs":3.0,"direction":"in","edge_id_on_connection":1,"edge_width":1.0,"offset":-1.0},"geometry":{"type":"LineString","coordinates":[[-0.940826864323105,56.42366726554555],[3.509621520312091,55.77480400308583]]}}]},"movement_geojson_out":{"type":"FeatureCollection","features":[{"type":"Feature","properties":{"departure_cph":"39/103/5541","dest_cph":"41/788/6464","departure_date":"2019-01-01","qty_pigs":5.0,"direction":"out","edge_id_on_connection":1,"edge_width":1.0,"offset":-1.0},"geometry":{"type":"LineString","coordinates":[[3.509621520312091,55.77480400308583],[-7.011031868789061,54.86382754054693]]}},{"type":"Feature","properties":{"departure_cph":"41/788/6464","dest_cph":"69/196/5890","departure_date":"2019-01-02","qty_pigs":6.0,"direction":"out","edge_id_on_connection":2,"edge_width":1.0,"offset":-3.0},"geometry":{"type":"LineString","coordinates":[[-7.011031868789061,54.86382754054693],[-0.940826864323105,56.42366726554555]]}}]},"dates_in":"2018-12-31 to 2019-01-05","dates_out":"2018-12-31 to 2019-01-05","max_distance":null}}]}}</script>

# trace_contact_chains() works with duplicated movements and prints a message

    <div id="htmlwidget-" style="width:100%;height:400px;" class="leaflet html-widget"></div>
    <script type="application/json" data-for="htmlwidget-">{"x":{"options":{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}}},"calls":[{"method":"addTiles","args":["https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",null,null,{"minZoom":0,"maxZoom":18,"tileSize":256,"subdomains":"abc","errorTileUrl":"","tms":false,"noWrap":false,"zoomOffset":0,"zoomReverse":false,"opacity":1,"zIndex":1,"detectRetina":false,"attribution":"&copy; <a href=\"https://openstreetmap.org/copyright/\">OpenStreetMap<\/a>,  <a href=\"https://opendatacommons.org/licenses/odbl/\">ODbL<\/a>"}]},{"method":"addCircleMarkers","args":[54.87183548191156,2.973010058360246,10,null,"Root holding(s)",{"interactive":true,"className":"","pane":"holdingsPane","stroke":true,"color":"black","weight":5,"opacity":0.5,"fill":true,"fillColor":"black","fillOpacity":0.2},{"showCoverageOnHover":true,"zoomToBoundsOnClick":true,"spiderfyOnMaxZoom":true,"removeOutsideVisibleBounds":true,"spiderLegPolylineOptions":{"weight":1.5,"color":"#222","opacity":0.5},"freezeAtZoom":false},null,"<b>Root holding<\/b><br><b>cph:<\/b> 95/216/1100<br><b>holding_type:<\/b> NBUZZ<br><b>herd_size:<\/b> 9294",null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]},{"method":"addCircleMarkers","args":[[51.97547123900536,55.5962326322733,53.03632949264616,52.72330731689453,54.58764878028843,57.691987453391,51.85255634536631,52.1935818898291,53.50583063954677],[5.709143053220052,-2.239221192053663,-0.4189714941543531,-4.813809943331969,-0.2693998861138167,1.531669719343421,-0.529457526950595,2.619264793085283,-5.49156489052311],10,null,"Originating holdings",{"interactive":true,"className":"","pane":"holdingsPane","stroke":true,"color":"blue","weight":5,"opacity":0.5,"fill":true,"fillColor":"blue","fillOpacity":0.2},{"showCoverageOnHover":true,"zoomToBoundsOnClick":true,"spiderfyOnMaxZoom":true,"removeOutsideVisibleBounds":true,"spiderLegPolylineOptions":{"weight":1.5,"color":"#222","opacity":0.5},"freezeAtZoom":false},null,["<b>Originating holding<\/b><br><b>cph:<\/b> 32/532/8560<br><b>holding_type:<\/b> HEJDE<br><b>herd_size:<\/b> 2140","<b>Originating holding<\/b><br><b>cph:<\/b> 75/345/2020<br><b>holding_type:<\/b> GCUHF<br><b>herd_size:<\/b> 1676","<b>Originating holding<\/b><br><b>cph:<\/b> 97/665/7174<br><b>holding_type:<\/b> CYCZH<br><b>herd_size:<\/b> 3818","<b>Originating holding<\/b><br><b>cph:<\/b> 47/479/9810<br><b>holding_type:<\/b> DFYWQ<br><b>herd_size:<\/b> 4924","<b>Originating holding<\/b><br><b>cph:<\/b> 46/782/4470<br><b>holding_type:<\/b> HLUSY<br><b>herd_size:<\/b> 5057","<b>Originating holding<\/b><br><b>cph:<\/b> 75/929/3476<br><b>holding_type:<\/b> THRXE<br><b>herd_size:<\/b> 5781","<b>Originating holding<\/b><br><b>cph:<\/b> 27/664/8542<br><b>holding_type:<\/b> YNPTP<br><b>herd_size:<\/b> 5900","<b>Originating holding<\/b><br><b>cph:<\/b> 68/763/2008<br><b>holding_type:<\/b> SVYNH<br><b>herd_size:<\/b> 6577","<b>Originating holding<\/b><br><b>cph:<\/b> 50/651/8553<br><b>holding_type:<\/b> MNRFB<br><b>herd_size:<\/b> 8826"],null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]},{"method":"addCircleMarkers","args":[[52.32748769739458,57.59973763607515,52.97352449489549,50.73267301970724,57.91324063052767],[4.812667616172421,-3.953480697781026,6.634899107698601,-4.239834059728081,-6.665831129204032],10,null,"Destination holdings",{"interactive":true,"className":"","pane":"holdingsPane","stroke":true,"color":"red","weight":5,"opacity":0.5,"fill":true,"fillColor":"red","fillOpacity":0.2},{"showCoverageOnHover":true,"zoomToBoundsOnClick":true,"spiderfyOnMaxZoom":true,"removeOutsideVisibleBounds":true,"spiderLegPolylineOptions":{"weight":1.5,"color":"#222","opacity":0.5},"freezeAtZoom":false},null,["<b>Destination holding<\/b><br><b>cph:<\/b> 46/908/7292<br><b>holding_type:<\/b> WLRZA<br><b>herd_size:<\/b> 3155","<b>Destination holding<\/b><br><b>cph:<\/b> 77/112/3288<br><b>holding_type:<\/b> JPOXU<br><b>herd_size:<\/b> 3652","<b>Destination holding<\/b><br><b>cph:<\/b> 59/623/8252<br><b>holding_type:<\/b> BKBDY<br><b>herd_size:<\/b> 4034","<b>Destination holding<\/b><br><b>cph:<\/b> 25/591/6144<br><b>holding_type:<\/b> DNNZD<br><b>herd_size:<\/b> 9142","<b>Destination holding<\/b><br><b>cph:<\/b> 47/319/4630<br><b>holding_type:<\/b> HWVGS<br><b>herd_size:<\/b> 9592"],null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]},{"method":"hideGroup","args":[["Ingoing weight","Ingoing moves","Outgoing weight","Outgoing moves"]]},{"method":"addControl","args":["<div>\n  <strong>Movement weight<\/strong>\n<\/div>\n<div>\n  <img src=\"data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20version%3D%221.1%22%20width%3D%2220%22%20height%3D%222%22%3E%0A%20%20%3Crect%20id%3D%22rect%22%20x%3D%220%22%20y%3D%220%22%20height%3D%222%22%20width%3D%2220%22%20stroke%3D%22transparent%22%20fill%3D%22red%22%20stroke-opacity%3D%221%22%20fill-opacity%3D%221%22%20stroke-width%3D%220%22%3E%3C%2Frect%3E%0A%3C%2Fsvg%3E\" style=\"vertical-align: middle; margin: 5px; margin-right: 0px; margin-left: 0px\" height=\"2\" width=\"20\"/>\n  <span style=\"\">10 - 99<\/span>\n<\/div>\n<div>\n  <img src=\"data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20version%3D%221.1%22%20width%3D%2220%22%20height%3D%224%22%3E%0A%20%20%3Crect%20id%3D%22rect%22%20x%3D%220%22%20y%3D%220%22%20height%3D%224%22%20width%3D%2220%22%20stroke%3D%22transparent%22%20fill%3D%22red%22%20stroke-opacity%3D%221%22%20fill-opacity%3D%221%22%20stroke-width%3D%220%22%3E%3C%2Frect%3E%0A%3C%2Fsvg%3E\" style=\"vertical-align: middle; margin: 5px; margin-right: 0px; margin-left: 0px\" height=\"4\" width=\"20\"/>\n  <span style=\"\">100 - 999<\/span>\n<\/div>","bottomright",null,"info legend leaflet-control"]}],"limits":{"lat":[50.73267301970724,57.91324063052767],"lng":[-6.665831129204032,6.634899107698601]}},"evals":[],"jsHooks":{"render":[{"code":"function(el, x, data) {\n  return (function(el, x, data) {\n    var edge;\n    var movement_geojson_in = data.movement_geojson_in;\n    var movement_geojson_out = data.movement_geojson_out;\n    var dates_in = data.dates_in;\n    var dates_out = data.dates_out;\n    var max_distance = data.max_distance;\n    var map = this;\n\n    /*\n    // Add interactive sidebar -- not using this at the moment\n\n    var sidebar = L.control.sidebar('sidebar', {\n        closeButton: true,\n        position: 'left'\n    });\n    map.addControl(sidebar);\n    */\n\n    // Create a pane with a zIndex of 450 to make sure the holding markers are\n    // drawn on top of the admin area backgrounds\n    map.createPane('holdingsPane');\n    map.getPane('holdingsPane').style.zIndex = 450;\n\n    // Retrieve layer groups defined in R, allowing use in grouped layer control panel\n\n    var groups = {\n      originating_holdings: map.layerManager.getLayerGroup('Originating holdings'),\n      destination_holdings: map.layerManager.getLayerGroup('Destination holdings'),\n      ingoing_edges: new L.layerGroup(),\n      outgoing_edges: new L.layerGroup(),\n    };\n\n    /*\n    Create layers for edges (separately for ingoing and outgoing chains): using\n    straight lines with arrowheads, and varying offsets to create parallel lines\n    when moves are repeated.\n    NB: to refer to a col header in GeoJSON, need to use '.properties.col_header'\n    */\n\n    // First make list of properties I don't want to report on in the map\n    var excludedProperties = ['direction', 'edge_id_on_connection', 'edge_width', 'offset']\n\n    // Create a pane with a zIndex of 450 to make sure the movement arrows are\n    // drawn on top of the admin area backgrounds\n    map.createPane('movementArrows');\n    map.getPane('movementArrows').style.zIndex = 450;\n\n    // Add ingoing and outgoing movements\n    if (movement_geojson_in.features.length > 0) {\n      movement_geojson_in.features.forEach(function(edge){\n        var edge_coords = L.GeoJSON.coordsToLatLngs(edge.geometry.coordinates, 0);\n        var polyline = L.polyline(edge_coords, {\n                color: 'blue',\n                weight: edge.properties.edge_width,\n                opacity: 1,\n                offset: edge.properties.offset,\n                pane: 'movementArrows'\n              }).arrowheads({\n                offset: 0, yawn: 30, fill: true, size: '25px'\n              }).addTo(groups.ingoing_edges)\n\n        // Add popup with text based on all edge properties\n        var text = '';\n        for (var prop in edge.properties) {\n          if (edge.properties.hasOwnProperty(prop) && !excludedProperties.includes(prop)) {\n            text += '<b>'+ prop + ': <\/b>' + edge.properties[prop] + '<br>';\n          }\n        }\n        polyline.bindPopup(text);\n      });\n    };\n    groups.ingoing_edges.addTo(map);\n    if (movement_geojson_out.features.length > 0) {\n      movement_geojson_out.features.forEach(function(edge){\n        var edge_coords = L.GeoJSON.coordsToLatLngs(edge.geometry.coordinates, 0);\n        var polyline = L.polyline(edge_coords, {\n                color: 'red',\n                weight: edge.properties.edge_width,\n                opacity: 1,\n                offset: edge.properties.offset,\n                pane: 'movementArrows'\n              }).arrowheads({\n                offset: 0, yawn: 30, fill: true, size: '25px'\n              }).addTo(groups.outgoing_edges)\n\n        // Add popup with text based on all edge properties\n        var text = '';\n        for (var prop in edge.properties) {\n          if (edge.properties.hasOwnProperty(prop) && !excludedProperties.includes(prop)) {\n            text += '<b>'+ prop + ': <\/b>' + edge.properties[prop] + '<br>';\n          }\n        }\n        polyline.bindPopup(text);\n      });\n      groups.outgoing_edges.addTo(map);\n    };\n\n\n    // Set up grouped layer control\n    var groupedOverlays = {\n      ['Incoming contact chains<br>(' + dates_in + (max_distance !== null ? ',<br>max distance from root: ' + max_distance : '') + ')']: {\n          '<span class=\"fa-stack\" style=\"max-width: 12px; max-height: 12px; vertical-align: top;\"><i class=\"fa-solid fa-circle fa-stack-1x\" style=\"color: blue; opacity: 0.2\"><\/i><i class=\"fa-regular fa-circle fa-stack-1x\" style=\"color: blue; opacity: 0.5\"><\/i><\/span> Originating holdings': groups.originating_holdings ?? [],\n          '<i class=\"fa-solid fa-right-long\" style=\"color: blue\"><\/i> Incoming movements': groups.ingoing_edges ?? []},\n      ['Outgoing contact chains<br>(' + dates_out + (max_distance !== null ? ',<br>max distance from root: ' + max_distance : '') + ')']: {\n          '<span class=\"fa-stack\" style=\"max-width: 12px; max-height: 12px; vertical-align: top;\"><i class=\"fa-solid fa-circle fa-stack-1x\" style=\"color: red; opacity: 0.2\"><\/i><i class=\"fa-regular fa-circle fa-stack-1x\" style=\"color: red; opacity: 0.5\"><\/i><\/span> Destination holdings': groups.destination_holdings ?? [],\n          '<i class=\"fa-solid fa-right-long\" style=\"color: red\"><\/i> Outgoing movements': groups.outgoing_edges ?? []}\n      };\n\n    // Make the Administrative area groups exclusive (use radio inputs)\n    var options = {\n      exclusiveGroups: ['Administrative areas'],\n      collapsed: false};\n\n    var layerControl = L.control.groupedLayers(null, groupedOverlays, options);\n    layerControl.addTo(map);\n\n    // If admin areas are provided, add these to layer control\n\n    var adminAreas = map.layerManager.getLayerGroup('Administrative areas')\n    if (adminAreas) {\n      layerControl.addOverlay(adminAreas,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-regular fa-square fa-stack-2x\" style=\"color: black\"><\/i><\/span> Area boundaries only', 'Administrative areas');\n      var ingoingMoves = map.layerManager.getLayerGroup('Ingoing moves');\n      layerControl.addOverlay(ingoingMoves,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-solid fa-square fa-stack-2x\" style=\"color: blue; opacity: 0.2\"><\/i><i class=\"fa-solid fa-arrow-right-arrow-left fa-sm fa-stack-1x\" style=\"color: blue;\"><\/i><\/span> Total ingoing moves from area', 'Administrative areas');\n      var ingoingWeight = map.layerManager.getLayerGroup('Ingoing weight');\n      layerControl.addOverlay(ingoingWeight,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-solid fa-square fa-stack-2x\" style=\"color: blue; opacity: 0.2\"><\/i><i class=\"fa-solid fa-weight-hanging fa-sm fa-stack-1x\" style=\"color: blue;\"><\/i><\/span> Total ingoing weight from area', 'Administrative areas');\n      var outgoingMoves = map.layerManager.getLayerGroup('Outgoing moves');\n      layerControl.addOverlay(outgoingMoves,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-solid fa-square fa-stack-2x\" style=\"color: red; opacity: 0.2\"><\/i><i class=\"fa-solid fa-arrow-right-arrow-left fa-sm fa-stack-1x\" style=\"color: red;\"><\/i><\/span> Total outgoing moves to area', 'Administrative areas');\n      var outgoingWeight = map.layerManager.getLayerGroup('Outgoing weight');\n      layerControl.addOverlay(outgoingWeight,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-solid fa-square fa-stack-2x\" style=\"color: red; opacity: 0.2\"><\/i><i class=\"fa-solid fa-weight-hanging fa-sm fa-stack-1x\" style=\"color: red;\"><\/i><\/span> Total outgoing weight to area', 'Administrative areas');\n\n    // Hide legends on first render, then toggle depending on which admin area map is active\n\n      var legendClasses = ['outgoing-moves', 'ingoing-moves', 'outgoing-weight', 'ingoing-weight'];\n      legendClasses.forEach(function(className) {\n        var legend = document.getElementsByClassName('info legend ' + className)[0];\n        if (legend) {\n          legend.style.display = 'none';\n        }\n      })\n\n      map.on('overlayadd',function(e){\n       if (e.layer === adminAreas){\n          var legendClasses = ['info legend outgoing-moves', 'info legend ingoing-moves', 'info legend outgoing-weight', 'info legend ingoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n        } else if (e.layer === ingoingMoves){\n          var legendClasses = ['info legend outgoing-moves', 'info legend outgoing-weight', 'info legend ingoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n          var correctLegend = document.getElementsByClassName('info legend ingoing-moves')[0]\n          correctLegend.style.display='block';\n        } else if (e.layer === ingoingWeight){\n          // var inWeightLeg = map.layerManager.getLayer('Ingoing_weight_legend');\n          // inWeightLeg.addTo(map);\n          var legendClasses = ['info legend outgoing-moves', 'info legend ingoing-moves', 'info legend outgoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n          var correctLegend = document.getElementsByClassName('info legend ingoing-weight')[0]\n          correctLegend.style.display='block';\n        } else if (e.layer === outgoingMoves){\n          // var outMovesLeg = map.layerManager.getLayer('Outgoing_moves_legend');\n          // outMovesLeg.addTo(map);\n          var legendClasses = ['info legend ingoing-moves', 'info legend outgoing-weight', 'info legend ingoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n          var correctLegend = document.getElementsByClassName('info legend outgoing-moves')[0]\n          correctLegend.style.display='block';\n        } else if (e.layer === outgoingWeight){\n          // var outWeightLeg = map.layerManager.getLayer('Outgoing_weight_legend');\n          // outWeightLeg.addTo(map);\n          var legendClasses = ['info legend outgoing-moves', 'info legend ingoing-moves', 'info legend ingoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n          var correctLegend = document.getElementsByClassName('info legend outgoing-weight')[0]\n          correctLegend.style.display='block';\n        }\n\n      });\n    }\n    }\n\n).call(this.getMap(), el, x, data);\n}","data":{"movement_geojson_in":{"type":"FeatureCollection","features":[{"type":"Feature","properties":{"departure_cph":"27/664/8542","dest_cph":"75/929/3476","departure_date":"2019-04-03","qty_pigs":69.0,"movement_reference":523348.0,"direction":"in","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[-0.529457526950595,51.85255634536631],[1.5316697193434215,57.691987453391]]}},{"type":"Feature","properties":{"departure_cph":"27/664/8542","dest_cph":"75/929/3476","departure_date":"2019-04-03","qty_pigs":69.0,"movement_reference":523348.0,"direction":"in","edge_id_on_connection":2,"edge_width":2.0,"offset":-4.5},"geometry":{"type":"LineString","coordinates":[[-0.529457526950595,51.85255634536631],[1.5316697193434215,57.691987453391]]}},{"type":"Feature","properties":{"departure_cph":"32/532/8560","dest_cph":"75/929/3476","departure_date":"2019-04-07","qty_pigs":60.0,"movement_reference":207280.0,"direction":"in","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[5.7091430532200528,51.97547123900536],[1.5316697193434215,57.691987453391]]}},{"type":"Feature","properties":{"departure_cph":"32/532/8560","dest_cph":"75/929/3476","departure_date":"2019-04-07","qty_pigs":60.0,"movement_reference":207280.0,"direction":"in","edge_id_on_connection":2,"edge_width":2.0,"offset":-4.5},"geometry":{"type":"LineString","coordinates":[[5.7091430532200528,51.97547123900536],[1.5316697193434215,57.691987453391]]}},{"type":"Feature","properties":{"departure_cph":"46/782/4470","dest_cph":"75/929/3476","departure_date":"2019-04-10","qty_pigs":105.0,"movement_reference":802270.0,"direction":"in","edge_id_on_connection":1,"edge_width":4.0,"offset":-2.5},"geometry":{"type":"LineString","coordinates":[[-0.26939988611381668,54.587648780288429],[1.5316697193434215,57.691987453391]]}},{"type":"Feature","properties":{"departure_cph":"46/782/4470","dest_cph":"75/929/3476","departure_date":"2019-04-10","qty_pigs":105.0,"movement_reference":802270.0,"direction":"in","edge_id_on_connection":2,"edge_width":4.0,"offset":-7.5},"geometry":{"type":"LineString","coordinates":[[-0.26939988611381668,54.587648780288429],[1.5316697193434215,57.691987453391]]}},{"type":"Feature","properties":{"departure_cph":"47/479/9810","dest_cph":"68/763/2008","departure_date":"2019-04-11","qty_pigs":132.0,"movement_reference":313751.0,"direction":"in","edge_id_on_connection":1,"edge_width":4.0,"offset":-2.5},"geometry":{"type":"LineString","coordinates":[[-4.813809943331969,52.723307316894537],[2.6192647930852828,52.1935818898291]]}},{"type":"Feature","properties":{"departure_cph":"47/479/9810","dest_cph":"68/763/2008","departure_date":"2019-04-11","qty_pigs":132.0,"movement_reference":313751.0,"direction":"in","edge_id_on_connection":2,"edge_width":4.0,"offset":-7.5},"geometry":{"type":"LineString","coordinates":[[-4.813809943331969,52.723307316894537],[2.6192647930852828,52.1935818898291]]}},{"type":"Feature","properties":{"departure_cph":"50/651/8553","dest_cph":"95/216/1100","departure_date":"2019-04-21","qty_pigs":57.0,"movement_reference":159675.0,"direction":"in","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[-5.49156489052311,53.505830639546768],[2.973010058360246,54.87183548191156]]}},{"type":"Feature","properties":{"departure_cph":"50/651/8553","dest_cph":"95/216/1100","departure_date":"2019-04-21","qty_pigs":57.0,"movement_reference":159675.0,"direction":"in","edge_id_on_connection":2,"edge_width":2.0,"offset":-4.5},"geometry":{"type":"LineString","coordinates":[[-5.49156489052311,53.505830639546768],[2.973010058360246,54.87183548191156]]}},{"type":"Feature","properties":{"departure_cph":"68/763/2008","dest_cph":"95/216/1100","departure_date":"2019-04-21","qty_pigs":36.0,"movement_reference":273049.0,"direction":"in","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[2.6192647930852828,52.1935818898291],[2.973010058360246,54.87183548191156]]}},{"type":"Feature","properties":{"departure_cph":"68/763/2008","dest_cph":"95/216/1100","departure_date":"2019-04-21","qty_pigs":36.0,"movement_reference":273049.0,"direction":"in","edge_id_on_connection":2,"edge_width":2.0,"offset":-4.5},"geometry":{"type":"LineString","coordinates":[[2.6192647930852828,52.1935818898291],[2.973010058360246,54.87183548191156]]}},{"type":"Feature","properties":{"departure_cph":"75/345/2020","dest_cph":"68/763/2008","departure_date":"2019-04-16","qty_pigs":177.0,"movement_reference":397128.0,"direction":"in","edge_id_on_connection":1,"edge_width":4.0,"offset":-2.5},"geometry":{"type":"LineString","coordinates":[[-2.239221192053663,55.5962326322733],[2.6192647930852828,52.1935818898291]]}},{"type":"Feature","properties":{"departure_cph":"75/345/2020","dest_cph":"68/763/2008","departure_date":"2019-04-16","qty_pigs":177.0,"movement_reference":397128.0,"direction":"in","edge_id_on_connection":2,"edge_width":4.0,"offset":-7.5},"geometry":{"type":"LineString","coordinates":[[-2.239221192053663,55.5962326322733],[2.6192647930852828,52.1935818898291]]}},{"type":"Feature","properties":{"departure_cph":"75/929/3476","dest_cph":"50/651/8553","departure_date":"2019-04-17","qty_pigs":53.0,"movement_reference":558949.0,"direction":"in","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[1.5316697193434215,57.691987453391],[-5.49156489052311,53.505830639546768]]}},{"type":"Feature","properties":{"departure_cph":"75/929/3476","dest_cph":"50/651/8553","departure_date":"2019-04-17","qty_pigs":53.0,"movement_reference":558949.0,"direction":"in","edge_id_on_connection":2,"edge_width":2.0,"offset":-4.5},"geometry":{"type":"LineString","coordinates":[[1.5316697193434215,57.691987453391],[-5.49156489052311,53.505830639546768]]}},{"type":"Feature","properties":{"departure_cph":"97/665/7174","dest_cph":"46/782/4470","departure_date":"2019-04-03","qty_pigs":175.0,"movement_reference":224638.0,"direction":"in","edge_id_on_connection":1,"edge_width":4.0,"offset":-2.5},"geometry":{"type":"LineString","coordinates":[[-0.4189714941543531,53.03632949264616],[-0.26939988611381668,54.587648780288429]]}},{"type":"Feature","properties":{"departure_cph":"97/665/7174","dest_cph":"46/782/4470","departure_date":"2019-04-03","qty_pigs":175.0,"movement_reference":224638.0,"direction":"in","edge_id_on_connection":2,"edge_width":4.0,"offset":-7.5},"geometry":{"type":"LineString","coordinates":[[-0.4189714941543531,53.03632949264616],[-0.26939988611381668,54.587648780288429]]}}]},"movement_geojson_out":{"type":"FeatureCollection","features":[{"type":"Feature","properties":{"departure_cph":"46/908/7292","dest_cph":"77/112/3288","departure_date":"2019-06-18","qty_pigs":52.0,"movement_reference":351321.0,"direction":"out","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[4.812667616172421,52.32748769739458],[-3.9534806977810259,57.599737636075158]]}},{"type":"Feature","properties":{"departure_cph":"46/908/7292","dest_cph":"77/112/3288","departure_date":"2019-06-18","qty_pigs":52.0,"movement_reference":351321.0,"direction":"out","edge_id_on_connection":2,"edge_width":2.0,"offset":-4.5},"geometry":{"type":"LineString","coordinates":[[4.812667616172421,52.32748769739458],[-3.9534806977810259,57.599737636075158]]}},{"type":"Feature","properties":{"departure_cph":"47/319/4630","dest_cph":"25/591/6144","departure_date":"2019-06-20","qty_pigs":69.0,"movement_reference":458178.0,"direction":"out","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[-6.665831129204032,57.913240630527678],[-4.239834059728081,50.732673019707238]]}},{"type":"Feature","properties":{"departure_cph":"47/319/4630","dest_cph":"25/591/6144","departure_date":"2019-06-20","qty_pigs":69.0,"movement_reference":458178.0,"direction":"out","edge_id_on_connection":2,"edge_width":2.0,"offset":-4.5},"geometry":{"type":"LineString","coordinates":[[-6.665831129204032,57.913240630527678],[-4.239834059728081,50.732673019707238]]}},{"type":"Feature","properties":{"departure_cph":"47/319/4630","dest_cph":"46/908/7292","departure_date":"2019-06-18","qty_pigs":183.0,"movement_reference":66096.0,"direction":"out","edge_id_on_connection":1,"edge_width":4.0,"offset":-2.5},"geometry":{"type":"LineString","coordinates":[[-6.665831129204032,57.913240630527678],[4.812667616172421,52.32748769739458]]}},{"type":"Feature","properties":{"departure_cph":"47/319/4630","dest_cph":"46/908/7292","departure_date":"2019-06-18","qty_pigs":183.0,"movement_reference":66096.0,"direction":"out","edge_id_on_connection":2,"edge_width":4.0,"offset":-7.5},"geometry":{"type":"LineString","coordinates":[[-6.665831129204032,57.913240630527678],[4.812667616172421,52.32748769739458]]}},{"type":"Feature","properties":{"departure_cph":"95/216/1100","dest_cph":"47/319/4630","departure_date":"2019-06-05","qty_pigs":92.0,"movement_reference":674885.0,"direction":"out","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[2.973010058360246,54.87183548191156],[-6.665831129204032,57.913240630527678]]}},{"type":"Feature","properties":{"departure_cph":"95/216/1100","dest_cph":"47/319/4630","departure_date":"2019-06-05","qty_pigs":92.0,"movement_reference":674885.0,"direction":"out","edge_id_on_connection":2,"edge_width":2.0,"offset":-4.5},"geometry":{"type":"LineString","coordinates":[[2.973010058360246,54.87183548191156],[-6.665831129204032,57.913240630527678]]}},{"type":"Feature","properties":{"departure_cph":"95/216/1100","dest_cph":"59/623/8252","departure_date":"2019-06-15","qty_pigs":171.0,"movement_reference":945545.0,"direction":"out","edge_id_on_connection":1,"edge_width":4.0,"offset":-2.5},"geometry":{"type":"LineString","coordinates":[[2.973010058360246,54.87183548191156],[6.634899107698601,52.973524494895489]]}},{"type":"Feature","properties":{"departure_cph":"95/216/1100","dest_cph":"59/623/8252","departure_date":"2019-06-15","qty_pigs":171.0,"movement_reference":945545.0,"direction":"out","edge_id_on_connection":2,"edge_width":4.0,"offset":-7.5},"geometry":{"type":"LineString","coordinates":[[2.973010058360246,54.87183548191156],[6.634899107698601,52.973524494895489]]}}]},"dates_in":"2019-04-02 to 2019-07-01","dates_out":"2019-04-02 to 2019-07-01","max_distance":null}}]}}</script>

# trace_contact_chains() works with near-duplicate movements (difference in non-required field)

    <div id="htmlwidget-" style="width:100%;height:400px;" class="leaflet html-widget"></div>
    <script type="application/json" data-for="htmlwidget-">{"x":{"options":{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}}},"calls":[{"method":"addTiles","args":["https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",null,null,{"minZoom":0,"maxZoom":18,"tileSize":256,"subdomains":"abc","errorTileUrl":"","tms":false,"noWrap":false,"zoomOffset":0,"zoomReverse":false,"opacity":1,"zIndex":1,"detectRetina":false,"attribution":"&copy; <a href=\"https://openstreetmap.org/copyright/\">OpenStreetMap<\/a>,  <a href=\"https://opendatacommons.org/licenses/odbl/\">ODbL<\/a>"}]},{"method":"addCircleMarkers","args":[54.87183548191156,2.973010058360246,10,null,"Root holding(s)",{"interactive":true,"className":"","pane":"holdingsPane","stroke":true,"color":"black","weight":5,"opacity":0.5,"fill":true,"fillColor":"black","fillOpacity":0.2},{"showCoverageOnHover":true,"zoomToBoundsOnClick":true,"spiderfyOnMaxZoom":true,"removeOutsideVisibleBounds":true,"spiderLegPolylineOptions":{"weight":1.5,"color":"#222","opacity":0.5},"freezeAtZoom":false},null,"<b>Root holding<\/b><br><b>cph:<\/b> 95/216/1100<br><b>holding_type:<\/b> NBUZZ<br><b>herd_size:<\/b> 9294",null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]},{"method":"addCircleMarkers","args":[[51.97547123900536,55.5962326322733,53.03632949264616,52.72330731689453,54.58764878028843,57.691987453391,51.85255634536631,52.1935818898291,53.50583063954677],[5.709143053220052,-2.239221192053663,-0.4189714941543531,-4.813809943331969,-0.2693998861138167,1.531669719343421,-0.529457526950595,2.619264793085283,-5.49156489052311],10,null,"Originating holdings",{"interactive":true,"className":"","pane":"holdingsPane","stroke":true,"color":"blue","weight":5,"opacity":0.5,"fill":true,"fillColor":"blue","fillOpacity":0.2},{"showCoverageOnHover":true,"zoomToBoundsOnClick":true,"spiderfyOnMaxZoom":true,"removeOutsideVisibleBounds":true,"spiderLegPolylineOptions":{"weight":1.5,"color":"#222","opacity":0.5},"freezeAtZoom":false},null,["<b>Originating holding<\/b><br><b>cph:<\/b> 32/532/8560<br><b>holding_type:<\/b> HEJDE<br><b>herd_size:<\/b> 2140","<b>Originating holding<\/b><br><b>cph:<\/b> 75/345/2020<br><b>holding_type:<\/b> GCUHF<br><b>herd_size:<\/b> 1676","<b>Originating holding<\/b><br><b>cph:<\/b> 97/665/7174<br><b>holding_type:<\/b> CYCZH<br><b>herd_size:<\/b> 3818","<b>Originating holding<\/b><br><b>cph:<\/b> 47/479/9810<br><b>holding_type:<\/b> DFYWQ<br><b>herd_size:<\/b> 4924","<b>Originating holding<\/b><br><b>cph:<\/b> 46/782/4470<br><b>holding_type:<\/b> HLUSY<br><b>herd_size:<\/b> 5057","<b>Originating holding<\/b><br><b>cph:<\/b> 75/929/3476<br><b>holding_type:<\/b> THRXE<br><b>herd_size:<\/b> 5781","<b>Originating holding<\/b><br><b>cph:<\/b> 27/664/8542<br><b>holding_type:<\/b> YNPTP<br><b>herd_size:<\/b> 5900","<b>Originating holding<\/b><br><b>cph:<\/b> 68/763/2008<br><b>holding_type:<\/b> SVYNH<br><b>herd_size:<\/b> 6577","<b>Originating holding<\/b><br><b>cph:<\/b> 50/651/8553<br><b>holding_type:<\/b> MNRFB<br><b>herd_size:<\/b> 8826"],null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]},{"method":"addCircleMarkers","args":[[52.32748769739458,57.59973763607515,52.97352449489549,50.73267301970724,57.91324063052767],[4.812667616172421,-3.953480697781026,6.634899107698601,-4.239834059728081,-6.665831129204032],10,null,"Destination holdings",{"interactive":true,"className":"","pane":"holdingsPane","stroke":true,"color":"red","weight":5,"opacity":0.5,"fill":true,"fillColor":"red","fillOpacity":0.2},{"showCoverageOnHover":true,"zoomToBoundsOnClick":true,"spiderfyOnMaxZoom":true,"removeOutsideVisibleBounds":true,"spiderLegPolylineOptions":{"weight":1.5,"color":"#222","opacity":0.5},"freezeAtZoom":false},null,["<b>Destination holding<\/b><br><b>cph:<\/b> 46/908/7292<br><b>holding_type:<\/b> WLRZA<br><b>herd_size:<\/b> 3155","<b>Destination holding<\/b><br><b>cph:<\/b> 77/112/3288<br><b>holding_type:<\/b> JPOXU<br><b>herd_size:<\/b> 3652","<b>Destination holding<\/b><br><b>cph:<\/b> 59/623/8252<br><b>holding_type:<\/b> BKBDY<br><b>herd_size:<\/b> 4034","<b>Destination holding<\/b><br><b>cph:<\/b> 25/591/6144<br><b>holding_type:<\/b> DNNZD<br><b>herd_size:<\/b> 9142","<b>Destination holding<\/b><br><b>cph:<\/b> 47/319/4630<br><b>holding_type:<\/b> HWVGS<br><b>herd_size:<\/b> 9592"],null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]},{"method":"hideGroup","args":[["Ingoing weight","Ingoing moves","Outgoing weight","Outgoing moves"]]},{"method":"addControl","args":["<div>\n  <strong>Movement weight<\/strong>\n<\/div>\n<div>\n  <img src=\"data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20version%3D%221.1%22%20width%3D%2220%22%20height%3D%222%22%3E%0A%20%20%3Crect%20id%3D%22rect%22%20x%3D%220%22%20y%3D%220%22%20height%3D%222%22%20width%3D%2220%22%20stroke%3D%22transparent%22%20fill%3D%22red%22%20stroke-opacity%3D%221%22%20fill-opacity%3D%221%22%20stroke-width%3D%220%22%3E%3C%2Frect%3E%0A%3C%2Fsvg%3E\" style=\"vertical-align: middle; margin: 5px; margin-right: 0px; margin-left: 0px\" height=\"2\" width=\"20\"/>\n  <span style=\"\">10 - 99<\/span>\n<\/div>\n<div>\n  <img src=\"data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20version%3D%221.1%22%20width%3D%2220%22%20height%3D%224%22%3E%0A%20%20%3Crect%20id%3D%22rect%22%20x%3D%220%22%20y%3D%220%22%20height%3D%224%22%20width%3D%2220%22%20stroke%3D%22transparent%22%20fill%3D%22red%22%20stroke-opacity%3D%221%22%20fill-opacity%3D%221%22%20stroke-width%3D%220%22%3E%3C%2Frect%3E%0A%3C%2Fsvg%3E\" style=\"vertical-align: middle; margin: 5px; margin-right: 0px; margin-left: 0px\" height=\"4\" width=\"20\"/>\n  <span style=\"\">100 - 999<\/span>\n<\/div>","bottomright",null,"info legend leaflet-control"]}],"limits":{"lat":[50.73267301970724,57.91324063052767],"lng":[-6.665831129204032,6.634899107698601]}},"evals":[],"jsHooks":{"render":[{"code":"function(el, x, data) {\n  return (function(el, x, data) {\n    var edge;\n    var movement_geojson_in = data.movement_geojson_in;\n    var movement_geojson_out = data.movement_geojson_out;\n    var dates_in = data.dates_in;\n    var dates_out = data.dates_out;\n    var max_distance = data.max_distance;\n    var map = this;\n\n    /*\n    // Add interactive sidebar -- not using this at the moment\n\n    var sidebar = L.control.sidebar('sidebar', {\n        closeButton: true,\n        position: 'left'\n    });\n    map.addControl(sidebar);\n    */\n\n    // Create a pane with a zIndex of 450 to make sure the holding markers are\n    // drawn on top of the admin area backgrounds\n    map.createPane('holdingsPane');\n    map.getPane('holdingsPane').style.zIndex = 450;\n\n    // Retrieve layer groups defined in R, allowing use in grouped layer control panel\n\n    var groups = {\n      originating_holdings: map.layerManager.getLayerGroup('Originating holdings'),\n      destination_holdings: map.layerManager.getLayerGroup('Destination holdings'),\n      ingoing_edges: new L.layerGroup(),\n      outgoing_edges: new L.layerGroup(),\n    };\n\n    /*\n    Create layers for edges (separately for ingoing and outgoing chains): using\n    straight lines with arrowheads, and varying offsets to create parallel lines\n    when moves are repeated.\n    NB: to refer to a col header in GeoJSON, need to use '.properties.col_header'\n    */\n\n    // First make list of properties I don't want to report on in the map\n    var excludedProperties = ['direction', 'edge_id_on_connection', 'edge_width', 'offset']\n\n    // Create a pane with a zIndex of 450 to make sure the movement arrows are\n    // drawn on top of the admin area backgrounds\n    map.createPane('movementArrows');\n    map.getPane('movementArrows').style.zIndex = 450;\n\n    // Add ingoing and outgoing movements\n    if (movement_geojson_in.features.length > 0) {\n      movement_geojson_in.features.forEach(function(edge){\n        var edge_coords = L.GeoJSON.coordsToLatLngs(edge.geometry.coordinates, 0);\n        var polyline = L.polyline(edge_coords, {\n                color: 'blue',\n                weight: edge.properties.edge_width,\n                opacity: 1,\n                offset: edge.properties.offset,\n                pane: 'movementArrows'\n              }).arrowheads({\n                offset: 0, yawn: 30, fill: true, size: '25px'\n              }).addTo(groups.ingoing_edges)\n\n        // Add popup with text based on all edge properties\n        var text = '';\n        for (var prop in edge.properties) {\n          if (edge.properties.hasOwnProperty(prop) && !excludedProperties.includes(prop)) {\n            text += '<b>'+ prop + ': <\/b>' + edge.properties[prop] + '<br>';\n          }\n        }\n        polyline.bindPopup(text);\n      });\n    };\n    groups.ingoing_edges.addTo(map);\n    if (movement_geojson_out.features.length > 0) {\n      movement_geojson_out.features.forEach(function(edge){\n        var edge_coords = L.GeoJSON.coordsToLatLngs(edge.geometry.coordinates, 0);\n        var polyline = L.polyline(edge_coords, {\n                color: 'red',\n                weight: edge.properties.edge_width,\n                opacity: 1,\n                offset: edge.properties.offset,\n                pane: 'movementArrows'\n              }).arrowheads({\n                offset: 0, yawn: 30, fill: true, size: '25px'\n              }).addTo(groups.outgoing_edges)\n\n        // Add popup with text based on all edge properties\n        var text = '';\n        for (var prop in edge.properties) {\n          if (edge.properties.hasOwnProperty(prop) && !excludedProperties.includes(prop)) {\n            text += '<b>'+ prop + ': <\/b>' + edge.properties[prop] + '<br>';\n          }\n        }\n        polyline.bindPopup(text);\n      });\n      groups.outgoing_edges.addTo(map);\n    };\n\n\n    // Set up grouped layer control\n    var groupedOverlays = {\n      ['Incoming contact chains<br>(' + dates_in + (max_distance !== null ? ',<br>max distance from root: ' + max_distance : '') + ')']: {\n          '<span class=\"fa-stack\" style=\"max-width: 12px; max-height: 12px; vertical-align: top;\"><i class=\"fa-solid fa-circle fa-stack-1x\" style=\"color: blue; opacity: 0.2\"><\/i><i class=\"fa-regular fa-circle fa-stack-1x\" style=\"color: blue; opacity: 0.5\"><\/i><\/span> Originating holdings': groups.originating_holdings ?? [],\n          '<i class=\"fa-solid fa-right-long\" style=\"color: blue\"><\/i> Incoming movements': groups.ingoing_edges ?? []},\n      ['Outgoing contact chains<br>(' + dates_out + (max_distance !== null ? ',<br>max distance from root: ' + max_distance : '') + ')']: {\n          '<span class=\"fa-stack\" style=\"max-width: 12px; max-height: 12px; vertical-align: top;\"><i class=\"fa-solid fa-circle fa-stack-1x\" style=\"color: red; opacity: 0.2\"><\/i><i class=\"fa-regular fa-circle fa-stack-1x\" style=\"color: red; opacity: 0.5\"><\/i><\/span> Destination holdings': groups.destination_holdings ?? [],\n          '<i class=\"fa-solid fa-right-long\" style=\"color: red\"><\/i> Outgoing movements': groups.outgoing_edges ?? []}\n      };\n\n    // Make the Administrative area groups exclusive (use radio inputs)\n    var options = {\n      exclusiveGroups: ['Administrative areas'],\n      collapsed: false};\n\n    var layerControl = L.control.groupedLayers(null, groupedOverlays, options);\n    layerControl.addTo(map);\n\n    // If admin areas are provided, add these to layer control\n\n    var adminAreas = map.layerManager.getLayerGroup('Administrative areas')\n    if (adminAreas) {\n      layerControl.addOverlay(adminAreas,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-regular fa-square fa-stack-2x\" style=\"color: black\"><\/i><\/span> Area boundaries only', 'Administrative areas');\n      var ingoingMoves = map.layerManager.getLayerGroup('Ingoing moves');\n      layerControl.addOverlay(ingoingMoves,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-solid fa-square fa-stack-2x\" style=\"color: blue; opacity: 0.2\"><\/i><i class=\"fa-solid fa-arrow-right-arrow-left fa-sm fa-stack-1x\" style=\"color: blue;\"><\/i><\/span> Total ingoing moves from area', 'Administrative areas');\n      var ingoingWeight = map.layerManager.getLayerGroup('Ingoing weight');\n      layerControl.addOverlay(ingoingWeight,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-solid fa-square fa-stack-2x\" style=\"color: blue; opacity: 0.2\"><\/i><i class=\"fa-solid fa-weight-hanging fa-sm fa-stack-1x\" style=\"color: blue;\"><\/i><\/span> Total ingoing weight from area', 'Administrative areas');\n      var outgoingMoves = map.layerManager.getLayerGroup('Outgoing moves');\n      layerControl.addOverlay(outgoingMoves,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-solid fa-square fa-stack-2x\" style=\"color: red; opacity: 0.2\"><\/i><i class=\"fa-solid fa-arrow-right-arrow-left fa-sm fa-stack-1x\" style=\"color: red;\"><\/i><\/span> Total outgoing moves to area', 'Administrative areas');\n      var outgoingWeight = map.layerManager.getLayerGroup('Outgoing weight');\n      layerControl.addOverlay(outgoingWeight,\n        '<span class=\"fa-stack fa-xs\" style=\"max-width: 16px; max-height: 12px; vertical-align: top; text-align: center;\"><i class=\"fa-solid fa-square fa-stack-2x\" style=\"color: red; opacity: 0.2\"><\/i><i class=\"fa-solid fa-weight-hanging fa-sm fa-stack-1x\" style=\"color: red;\"><\/i><\/span> Total outgoing weight to area', 'Administrative areas');\n\n    // Hide legends on first render, then toggle depending on which admin area map is active\n\n      var legendClasses = ['outgoing-moves', 'ingoing-moves', 'outgoing-weight', 'ingoing-weight'];\n      legendClasses.forEach(function(className) {\n        var legend = document.getElementsByClassName('info legend ' + className)[0];\n        if (legend) {\n          legend.style.display = 'none';\n        }\n      })\n\n      map.on('overlayadd',function(e){\n       if (e.layer === adminAreas){\n          var legendClasses = ['info legend outgoing-moves', 'info legend ingoing-moves', 'info legend outgoing-weight', 'info legend ingoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n        } else if (e.layer === ingoingMoves){\n          var legendClasses = ['info legend outgoing-moves', 'info legend outgoing-weight', 'info legend ingoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n          var correctLegend = document.getElementsByClassName('info legend ingoing-moves')[0]\n          correctLegend.style.display='block';\n        } else if (e.layer === ingoingWeight){\n          // var inWeightLeg = map.layerManager.getLayer('Ingoing_weight_legend');\n          // inWeightLeg.addTo(map);\n          var legendClasses = ['info legend outgoing-moves', 'info legend ingoing-moves', 'info legend outgoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n          var correctLegend = document.getElementsByClassName('info legend ingoing-weight')[0]\n          correctLegend.style.display='block';\n        } else if (e.layer === outgoingMoves){\n          // var outMovesLeg = map.layerManager.getLayer('Outgoing_moves_legend');\n          // outMovesLeg.addTo(map);\n          var legendClasses = ['info legend ingoing-moves', 'info legend outgoing-weight', 'info legend ingoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n          var correctLegend = document.getElementsByClassName('info legend outgoing-moves')[0]\n          correctLegend.style.display='block';\n        } else if (e.layer === outgoingWeight){\n          // var outWeightLeg = map.layerManager.getLayer('Outgoing_weight_legend');\n          // outWeightLeg.addTo(map);\n          var legendClasses = ['info legend outgoing-moves', 'info legend ingoing-moves', 'info legend ingoing-weight'];\n          legendClasses.forEach(function(className) {\n            var legend = document.getElementsByClassName(className)[0];\n            if (legend) {\n              legend.style.display='none';\n            }\n          });\n          var correctLegend = document.getElementsByClassName('info legend outgoing-weight')[0]\n          correctLegend.style.display='block';\n        }\n\n      });\n    }\n    }\n\n).call(this.getMap(), el, x, data);\n}","data":{"movement_geojson_in":{"type":"FeatureCollection","features":[{"type":"Feature","properties":{"departure_cph":"27/664/8542","dest_cph":"75/929/3476","departure_date":"2019-04-03","qty_pigs":69.0,"movement_reference":523348.0,"direction":"in","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[-0.529457526950595,51.85255634536631],[1.5316697193434215,57.691987453391]]}},{"type":"Feature","properties":{"departure_cph":"27/664/8542","dest_cph":"75/929/3476","departure_date":"2019-04-03","qty_pigs":69.0,"movement_reference":523358.0,"direction":"in","edge_id_on_connection":2,"edge_width":2.0,"offset":-4.5},"geometry":{"type":"LineString","coordinates":[[-0.529457526950595,51.85255634536631],[1.5316697193434215,57.691987453391]]}},{"type":"Feature","properties":{"departure_cph":"32/532/8560","dest_cph":"75/929/3476","departure_date":"2019-04-07","qty_pigs":60.0,"movement_reference":207280.0,"direction":"in","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[5.7091430532200528,51.97547123900536],[1.5316697193434215,57.691987453391]]}},{"type":"Feature","properties":{"departure_cph":"32/532/8560","dest_cph":"75/929/3476","departure_date":"2019-04-07","qty_pigs":60.0,"movement_reference":207290.0,"direction":"in","edge_id_on_connection":2,"edge_width":2.0,"offset":-4.5},"geometry":{"type":"LineString","coordinates":[[5.7091430532200528,51.97547123900536],[1.5316697193434215,57.691987453391]]}},{"type":"Feature","properties":{"departure_cph":"46/782/4470","dest_cph":"75/929/3476","departure_date":"2019-04-10","qty_pigs":105.0,"movement_reference":802270.0,"direction":"in","edge_id_on_connection":1,"edge_width":4.0,"offset":-2.5},"geometry":{"type":"LineString","coordinates":[[-0.26939988611381668,54.587648780288429],[1.5316697193434215,57.691987453391]]}},{"type":"Feature","properties":{"departure_cph":"46/782/4470","dest_cph":"75/929/3476","departure_date":"2019-04-10","qty_pigs":105.0,"movement_reference":802280.0,"direction":"in","edge_id_on_connection":2,"edge_width":4.0,"offset":-7.5},"geometry":{"type":"LineString","coordinates":[[-0.26939988611381668,54.587648780288429],[1.5316697193434215,57.691987453391]]}},{"type":"Feature","properties":{"departure_cph":"47/479/9810","dest_cph":"68/763/2008","departure_date":"2019-04-11","qty_pigs":132.0,"movement_reference":313751.0,"direction":"in","edge_id_on_connection":1,"edge_width":4.0,"offset":-2.5},"geometry":{"type":"LineString","coordinates":[[-4.813809943331969,52.723307316894537],[2.6192647930852828,52.1935818898291]]}},{"type":"Feature","properties":{"departure_cph":"47/479/9810","dest_cph":"68/763/2008","departure_date":"2019-04-11","qty_pigs":132.0,"movement_reference":313761.0,"direction":"in","edge_id_on_connection":2,"edge_width":4.0,"offset":-7.5},"geometry":{"type":"LineString","coordinates":[[-4.813809943331969,52.723307316894537],[2.6192647930852828,52.1935818898291]]}},{"type":"Feature","properties":{"departure_cph":"50/651/8553","dest_cph":"95/216/1100","departure_date":"2019-04-21","qty_pigs":57.0,"movement_reference":159675.0,"direction":"in","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[-5.49156489052311,53.505830639546768],[2.973010058360246,54.87183548191156]]}},{"type":"Feature","properties":{"departure_cph":"50/651/8553","dest_cph":"95/216/1100","departure_date":"2019-04-21","qty_pigs":57.0,"movement_reference":159685.0,"direction":"in","edge_id_on_connection":2,"edge_width":2.0,"offset":-4.5},"geometry":{"type":"LineString","coordinates":[[-5.49156489052311,53.505830639546768],[2.973010058360246,54.87183548191156]]}},{"type":"Feature","properties":{"departure_cph":"68/763/2008","dest_cph":"95/216/1100","departure_date":"2019-04-21","qty_pigs":36.0,"movement_reference":273049.0,"direction":"in","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[2.6192647930852828,52.1935818898291],[2.973010058360246,54.87183548191156]]}},{"type":"Feature","properties":{"departure_cph":"68/763/2008","dest_cph":"95/216/1100","departure_date":"2019-04-21","qty_pigs":36.0,"movement_reference":273059.0,"direction":"in","edge_id_on_connection":2,"edge_width":2.0,"offset":-4.5},"geometry":{"type":"LineString","coordinates":[[2.6192647930852828,52.1935818898291],[2.973010058360246,54.87183548191156]]}},{"type":"Feature","properties":{"departure_cph":"75/345/2020","dest_cph":"68/763/2008","departure_date":"2019-04-16","qty_pigs":177.0,"movement_reference":397128.0,"direction":"in","edge_id_on_connection":1,"edge_width":4.0,"offset":-2.5},"geometry":{"type":"LineString","coordinates":[[-2.239221192053663,55.5962326322733],[2.6192647930852828,52.1935818898291]]}},{"type":"Feature","properties":{"departure_cph":"75/345/2020","dest_cph":"68/763/2008","departure_date":"2019-04-16","qty_pigs":177.0,"movement_reference":397138.0,"direction":"in","edge_id_on_connection":2,"edge_width":4.0,"offset":-7.5},"geometry":{"type":"LineString","coordinates":[[-2.239221192053663,55.5962326322733],[2.6192647930852828,52.1935818898291]]}},{"type":"Feature","properties":{"departure_cph":"75/929/3476","dest_cph":"50/651/8553","departure_date":"2019-04-17","qty_pigs":53.0,"movement_reference":558949.0,"direction":"in","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[1.5316697193434215,57.691987453391],[-5.49156489052311,53.505830639546768]]}},{"type":"Feature","properties":{"departure_cph":"75/929/3476","dest_cph":"50/651/8553","departure_date":"2019-04-17","qty_pigs":53.0,"movement_reference":558959.0,"direction":"in","edge_id_on_connection":2,"edge_width":2.0,"offset":-4.5},"geometry":{"type":"LineString","coordinates":[[1.5316697193434215,57.691987453391],[-5.49156489052311,53.505830639546768]]}},{"type":"Feature","properties":{"departure_cph":"97/665/7174","dest_cph":"46/782/4470","departure_date":"2019-04-03","qty_pigs":175.0,"movement_reference":224638.0,"direction":"in","edge_id_on_connection":1,"edge_width":4.0,"offset":-2.5},"geometry":{"type":"LineString","coordinates":[[-0.4189714941543531,53.03632949264616],[-0.26939988611381668,54.587648780288429]]}},{"type":"Feature","properties":{"departure_cph":"97/665/7174","dest_cph":"46/782/4470","departure_date":"2019-04-03","qty_pigs":175.0,"movement_reference":224648.0,"direction":"in","edge_id_on_connection":2,"edge_width":4.0,"offset":-7.5},"geometry":{"type":"LineString","coordinates":[[-0.4189714941543531,53.03632949264616],[-0.26939988611381668,54.587648780288429]]}}]},"movement_geojson_out":{"type":"FeatureCollection","features":[{"type":"Feature","properties":{"departure_cph":"46/908/7292","dest_cph":"77/112/3288","departure_date":"2019-06-18","qty_pigs":52.0,"movement_reference":351321.0,"direction":"out","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[4.812667616172421,52.32748769739458],[-3.9534806977810259,57.599737636075158]]}},{"type":"Feature","properties":{"departure_cph":"46/908/7292","dest_cph":"77/112/3288","departure_date":"2019-06-18","qty_pigs":52.0,"movement_reference":351331.0,"direction":"out","edge_id_on_connection":2,"edge_width":2.0,"offset":-4.5},"geometry":{"type":"LineString","coordinates":[[4.812667616172421,52.32748769739458],[-3.9534806977810259,57.599737636075158]]}},{"type":"Feature","properties":{"departure_cph":"47/319/4630","dest_cph":"25/591/6144","departure_date":"2019-06-20","qty_pigs":69.0,"movement_reference":458178.0,"direction":"out","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[-6.665831129204032,57.913240630527678],[-4.239834059728081,50.732673019707238]]}},{"type":"Feature","properties":{"departure_cph":"47/319/4630","dest_cph":"25/591/6144","departure_date":"2019-06-20","qty_pigs":69.0,"movement_reference":458188.0,"direction":"out","edge_id_on_connection":2,"edge_width":2.0,"offset":-4.5},"geometry":{"type":"LineString","coordinates":[[-6.665831129204032,57.913240630527678],[-4.239834059728081,50.732673019707238]]}},{"type":"Feature","properties":{"departure_cph":"47/319/4630","dest_cph":"46/908/7292","departure_date":"2019-06-18","qty_pigs":183.0,"movement_reference":66096.0,"direction":"out","edge_id_on_connection":1,"edge_width":4.0,"offset":-2.5},"geometry":{"type":"LineString","coordinates":[[-6.665831129204032,57.913240630527678],[4.812667616172421,52.32748769739458]]}},{"type":"Feature","properties":{"departure_cph":"47/319/4630","dest_cph":"46/908/7292","departure_date":"2019-06-18","qty_pigs":183.0,"movement_reference":66106.0,"direction":"out","edge_id_on_connection":2,"edge_width":4.0,"offset":-7.5},"geometry":{"type":"LineString","coordinates":[[-6.665831129204032,57.913240630527678],[4.812667616172421,52.32748769739458]]}},{"type":"Feature","properties":{"departure_cph":"95/216/1100","dest_cph":"47/319/4630","departure_date":"2019-06-05","qty_pigs":92.0,"movement_reference":674885.0,"direction":"out","edge_id_on_connection":1,"edge_width":2.0,"offset":-1.5},"geometry":{"type":"LineString","coordinates":[[2.973010058360246,54.87183548191156],[-6.665831129204032,57.913240630527678]]}},{"type":"Feature","properties":{"departure_cph":"95/216/1100","dest_cph":"47/319/4630","departure_date":"2019-06-05","qty_pigs":92.0,"movement_reference":674895.0,"direction":"out","edge_id_on_connection":2,"edge_width":2.0,"offset":-4.5},"geometry":{"type":"LineString","coordinates":[[2.973010058360246,54.87183548191156],[-6.665831129204032,57.913240630527678]]}},{"type":"Feature","properties":{"departure_cph":"95/216/1100","dest_cph":"59/623/8252","departure_date":"2019-06-15","qty_pigs":171.0,"movement_reference":945545.0,"direction":"out","edge_id_on_connection":1,"edge_width":4.0,"offset":-2.5},"geometry":{"type":"LineString","coordinates":[[2.973010058360246,54.87183548191156],[6.634899107698601,52.973524494895489]]}},{"type":"Feature","properties":{"departure_cph":"95/216/1100","dest_cph":"59/623/8252","departure_date":"2019-06-15","qty_pigs":171.0,"movement_reference":945555.0,"direction":"out","edge_id_on_connection":2,"edge_width":4.0,"offset":-7.5},"geometry":{"type":"LineString","coordinates":[[2.973010058360246,54.87183548191156],[6.634899107698601,52.973524494895489]]}}]},"dates_in":"2019-04-02 to 2019-07-01","dates_out":"2019-04-02 to 2019-07-01","max_distance":null}}]}}</script>

